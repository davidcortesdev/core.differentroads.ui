name: Merge to Develop and Pre

on:
  push:
    branches:
      - main

# Permisos necesarios para el job
defaults:
  run:
    shell: bash

jobs:
  merge-branches:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target_branch: [develop, pre]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          # Configura el token para autenticaci√≥n
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

      - name: Merge main into ${{ matrix.target_branch }}
        run: |
          set -e  # Sale inmediatamente si un comando falla

          # Asegurarse de que tenemos la rama objetivo
          git fetch origin ${{ matrix.target_branch }}:${{ matrix.target_branch }}

          # Cambiar a la rama objetivo
          git checkout ${{ matrix.target_branch }}

          # Hacer el merge
          git merge --no-ff origin/main -m "chore: merge main into ${{ matrix.target_branch }} [skip ci]"

          # Hacer push de los cambios
          git push origin ${{ matrix.target_branch }}

          echo "Merge completado exitosamente en ${{ matrix.target_branch }}"
        continue-on-error: false

      - name: Notify on failure
        if: ${{ failure() }}
        uses: actions/github-script@v7
        with:
          script: |
            const { context } = require('@actions/github');
            const core = require('@actions/core');
            core.warning(`Fallo al hacer merge a ${process.env.TARGET_BRANCH}`);
