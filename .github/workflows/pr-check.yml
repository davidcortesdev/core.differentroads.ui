name: Pull Request Check

on:
  pull_request:
    types: [opened, synchronize, reopened, draft, edited]
  check_suite:
    types: [completed, requested]
  push:
    branches:
      - '*'
      - '!main'
      - '!pre'
      - '!develop'

jobs:
  check-branch:
    runs-on: [ubuntu-latest]
    
    steps:

      - name: Checkout repository
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0

      - name: Fetch latest main
        run: git fetch origin main

      - name: Check if branch is up to date with main
        id: check_branch
        run: |
          # Ensure we have the latest from main
          echo "üîç Fetching latest changes from main branch..."
          git fetch --quiet
          
          # Create a temporary branch to test merge
          echo "üîÑ Creating temporary branch for merge test..."
          git branch temp-merge-test $(git rev-parse HEAD)
          
          # Try to merge main into the temp branch and capture if there are changes
          echo "üß™ Testing merge with main branch..."
          MERGE_OUTPUT=$(git checkout temp-merge-test && git merge --no-commit --no-ff origin/main 2>&1 || true)
          echo "üìã Merge output: $MERGE_OUTPUT"
          
          # Check for both "Already up to date" and "Automatic merge went well"
          HAS_CHANGES=0
          if echo "$MERGE_OUTPUT" | grep -q "Already up to date"; then
            HAS_CHANGES=0
            echo "üìä Status: Already up to date (no changes needed)"
          elif echo "$MERGE_OUTPUT" | grep -q "Automatic merge went well"; then
            HAS_CHANGES=1
            echo "üìä Status: Merge successful (changes were applied)"
          else
            HAS_CHANGES=1
            echo "üìä Status: Merge status unclear, assuming changes needed"
          fi
          
          echo "üìä Has changes: $([ $HAS_CHANGES -eq 1 ] && echo 'Yes' || echo 'No')"
          
          # Return to original branch
          echo "üîô Returning to original branch..."
          git checkout -
          git branch -D temp-merge-test
          
          # Also do the traditional checks
          echo "üìà Calculating commit differences..."
          BEHIND_BY=$(git rev-list --count HEAD..origin/main)
          DIVERGED=$(git rev-list --count origin/main..HEAD)
          
          echo "üìä Branch status:"
          echo "  - Behind main by: $BEHIND_BY commits"
          echo "  - Ahead of main by: $DIVERGED commits"
          
          echo "behind_by=$BEHIND_BY" >> $GITHUB_ENV
          echo "diverged=$DIVERGED" >> $GITHUB_ENV
          echo "has_changes=$([ $HAS_CHANGES -eq 0 ] && echo 'true' || echo 'false')" >> $GITHUB_ENV
          
          if [ $BEHIND_BY -gt 0 ] || [ $HAS_CHANGES -eq 0 ]; then
            echo "‚ö†Ô∏è This branch needs updates from main"
            echo "behind=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Branch is up to date with main"
            echo "behind=false" >> $GITHUB_OUTPUT
          fi
          
          if [ $DIVERGED -gt 0 ]; then
            echo "‚ÑπÔ∏è This branch has $DIVERGED commits that main doesn't have"
          fi

      - name: Add comment to PR if branch is not up to date
        if: (env.behind_by > 0 || env.has_changes == 'true') && github.event_name == 'pull_request'
        uses: actions/github-script@v7.0.1
        with:
          script: |
            let message = '';
            
            if (process.env.behind_by > 0) {
              message += `‚ö†Ô∏è This branch is behind main by ${process.env.behind_by} commits. `;
            }
            
            if (process.env.diverged > 0) {
              message += `‚ÑπÔ∏è This branch has ${process.env.diverged} commits that main doesn't have. `;
            }
            
            message += `Please update your branch with the latest changes from main using:\n\`\`\`\n git fetch origin main \n git merge --no-ff origin/main\n\`\`\``;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })

      - name: Fail if branch is not up to date
        if: env.behind_by > 0
        run: exit 1

  build-check:
    runs-on: [ubuntu-latest]
    needs: check-branch
    if: success() && (needs.check-branch.result == 'success')
    
    steps:

      - name: Checkout repository
        uses: actions/checkout@v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@v4.2.0
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build:prod

      - name: Add comment to PR if build fails
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7.0.1
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚ùå The build failed. Please check the build logs and fix the issues.`
            })

      - name: Add comment to PR if build succeeds
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7.0.1
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚úÖ The build succeeded.`
            })