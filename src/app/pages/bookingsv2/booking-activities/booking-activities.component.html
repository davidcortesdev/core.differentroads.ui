<p-toast />
<div class="activities-container">
  <p-panel header="Actividades">
    <p-dataview #dv [value]="availableActivities" [emptyMessage]="''">
      <ng-template #list let-items>
        <div class="activities-content">
          <div *ngFor="let activity of items" class="activity-item">
            <div class="activity-content">
              <div class="activity-image">
                <img [src]="getActivityImage(activity)" [alt]="activity.name"  loading="lazy"/>
              </div>
              <div class="activity-details">
                <div class="activity-header">
                  <div class="activity-title-container">
                    <span class="activity-title">{{ activity.name }}</span>
                  </div>
                  <div class="activity-price" *ngIf="shouldShowPrice(activity)">
                    <span class="price-value"
                      >+{{ getActivityPrice(activity) | currencyFormat }}</span
                    >
                    <span class="per-person">por persona</span>
                  </div>
                </div>
                <div
                  class="activity-description"
                  [innerHTML]="getSafeDescription(activity.description)"
                ></div>
                <div class="activity-actions">
                  <button
                    *ngIf="!hasAnyTravelerWithActivity(activity.id) && activity.type !== 'pack'"
                    pButton
                    type="button"
                    [label]="(isCancelled) ? 'No disponible' : 'Añadir'"
                    class="p-button-rounded"
                    [disabled]="isCancelled"
                    (click)="toggleAddActivity(activity.id)"
                  ></button>
                  <button
                    *ngIf="hasAnyTravelerWithActivity(activity.id)"
                    pButton
                    type="button"
                    label="Añadida"
                    class="p-button-rounded p-button-outlined"
                    [disabled]="true"
                  ></button>
                  <h4 *ngIf="activity.type === 'pack' && !hasAnyTravelerWithActivity(activity.id)">Para añadir esta actividad, contacte con atención al cliente</h4>
                </div>
                
                <!-- Sección para seleccionar pasajeros cuando se añade una actividad -->
                <div *ngIf="activity.showPassengers" class="passengers-section">
                  <h4>Selecciona los pasajeros:</h4>
                  <div
                    *ngFor="let traveler of activity.selectedTravelers"
                    class="passenger-item"
                  >
                    <p-toggleswitch
                    *ngIf="traveler.selected"
                      [(ngModel)]="traveler.selected"
                      [disabled]="traveler.price === 0 || isCancelled"
                    ></p-toggleswitch>
                    <span
                      >{{ getTravelerNameById(traveler.id) }} ({{
                        traveler.ageGroup
                      }})
                      <span *ngIf="traveler.price > 0" class="price-text"
                        >+{{ traveler.price | currencyFormat }}</span
                      >
                      <span *ngIf="traveler.price === 0">(No disponible)</span>
                    </span>
                  </div>
                  <div class="passenger-actions">
                    <p-button
                      [label]="isCancelled ? 'No disponible' : 'Agregar'"
                      (click)="onContinueActivity(activity.id)"
                      [rounded]="true"
                      [disabled]="isLoading || isCancelled"
                      [icon]="isLoading ? 'pi pi-spin pi-spinner' : ''"
                      [iconPos]="isLoading ? 'left' : 'right'"
                    ></p-button>
                  </div>
                </div>

                <!-- Sección para mostrar viajeros y sus actividades -->
                <div *ngIf="hasAnyTravelerWithActivity(activity.id)" class="traveler-activities">
                  <h4>Viajeros:</h4>
                  <div class="activities-list">
                    <ng-container *ngFor="let traveler of travelers">
                      <div class="traveler-section">
                        <div class="traveler-item" style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee;">
                          <div class="traveler-info">
                            <span>{{ getTravelerNameById(traveler.id) }}</span>
                            <span *ngIf="hasTravelerActivity(traveler.id, activity.id)" class="activity-status" style="margin-left: 10px; color: #28a745; font-size: 0.9em;">
                              ✓ Actividad seleccionada
                            </span>
                            <span *ngIf="!hasTravelerActivity(traveler.id, activity.id)" class="activity-status" style="margin-left: 10px; color: #666; font-size: 0.9em;">
                              - Sin actividad
                            </span>
                          </div>
                          <div class="traveler-actions">
                            <h5 *ngIf="activity.type === 'pack'" style="margin-right: 1rem;">{{hasTravelerActivity(traveler.id, activity.id) ? 'Para eliminar esta actividad, contacte con atención al cliente ' : 'Para añadir esta actividad, contacte con atención al cliente '}}</h5>
                            <p-toggleSwitch 
                              [ngModel]="hasTravelerActivity(traveler.id, activity.id)"
                              (ngModelChange)="onActivityToggleChange(traveler.id, activity.id, $event)"
                              [ngModelOptions]="{standalone: true}"
                              [disabled]="isCancelled || (activity.type === 'pack')">
                            </p-toggleSwitch>
                            
                          </div>
                        </div>
                      </div>
                    </ng-container>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="items.length === 0" class="no-activities">
            No hay actividades disponibles para esta reserva.
          </div>
        </div>
      </ng-template>
    </p-dataview>
  </p-panel>
</div>