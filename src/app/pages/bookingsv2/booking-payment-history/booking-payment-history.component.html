<div class="payment-history-container">
  <div class="payment-row">
    <!-- Resumen del viaje usando el componente summary-table -->
    <div class="payment-column-left">
      <p-panel header="Resumen del viaje">
        <app-summary-table
          [reservationId]="bookingID"
          [refreshTrigger]="refreshTrigger"
          [isAuthenticated]="false"
          [showPointsSection]="false"
          [showTotalSection]="false"
          [showFlightSection]="false"
          [title]="'Resumen del viaje'"
          [currency]="'EUR'"
          [customClass]="'booking-summary panel-background'"
          [showTitle]="false"
        >
        </app-summary-table>
      </p-panel>
    </div>

    <!-- Información de pagos (columna derecha) -->
    <div class="payment-column-right">
      <p-panel header="Pagos">
        <app-booking-payments-header
          [paymentInfo]="paymentInfo"
          [isAgency]="isAgency"
          [grossPaymentInfo]="grossPaymentInfo"
          [netPaymentInfo]="netPaymentInfo"
          [loadingProforma]="loadingProforma"
          [isCancelled]="isCancelled"
          (addPayment)="navigateToPayment()"
          (couponClick)="openCouponModal()"
        ></app-booking-payments-header>

        <p-divider></p-divider>

        <!-- Contenedor de columnas para pagos y historial -->
        <div class="payment-columns-container">

          <p-panel
            header="Historial de pago"
            [styleClass]="
              paymentHistory && paymentHistory.length > 0 ? '' : 'empty-panel'
            "
          >
            <!-- Loading state -->
            <div *ngIf="isLoadingPayments" class="loading-container">
              <p-progressSpinner></p-progressSpinner>
            </div>

            <!-- Payment history list -->
            <div *ngIf="!isLoadingPayments">
              <div *ngFor="let item of paymentHistory" class="history-item">
                <div class="history-item-content">
                  <!-- Columna 1: Método de pago -->
                  <div class="history-column method-column">
                    <span class="method" *ngIf="item.method">
                      <i class="pi pi-credit-card"></i> {{ item.method }}
                    </span>
                  </div>

                  <!-- Columna 2: Importe -->
                  <div class="history-column amount-column">
                    <span class="amount">{{ item.amount | currencyFormat }}</span>
                  </div>

                  <!-- Columna 3: Estado -->
                  <div class="history-column status-column">
                    <span class="status-text">
                      <p-tag 
                        [value]="getPaymentStatusDisplayName(item)" 
                        [severity]="getPaymentStatusColor(item) ? undefined : 'info'"
                        [style.background-color]="getPaymentStatusColor(item) || undefined"
                        [style.color]="getPaymentStatusColor(item) ? '#fff' : undefined"
                        [style.border]="getPaymentStatusColor(item) ? 'none' : undefined"
                      ></p-tag>
                    </span>
                  </div>

                  <!-- Columna 4: Notas y botón justificante (comparten columna) -->
                  <div class="history-column notes-column">
                    <div class="notes-content">
                      <span class="notes" *ngIf="item.notes">
                        <i class="pi pi-comment"></i> {{ getFriendlyErrorMessage(item.notes) }}
                      </span>
                      <!-- Botón para subir justificante si es transferencia -->
                      <span class="upload-voucher-action" *ngIf="isTransfer(item)">
                        <input
                          type="file"
                          [id]="'file-input-' + (item.id || item.publicID)"
                          accept="image/*,.pdf"
                          style="display: none;"
                          (change)="onVoucherFileSelect($event, item)"
                          [disabled]="isUploadingVoucher[item.id || item.publicID]"
                        />
                        <p-button
                          [label]="getUploadVoucherButtonLabel(item)"
                          icon="pi pi-upload"
                          severity="warning"
                          size="small"
                          [disabled]="isUploadingVoucher[item.id || item.publicID]"
                          (onClick)="triggerFileInput(item)"
                          [pTooltip]="getUploadVoucherButtonLabel(item)"
                        ></p-button>
                        <p-progressSpinner
                          *ngIf="isUploadingVoucher[item.id || item.publicID]"
                          styleClass="upload-spinner"
                          [style]="{ width: '20px', height: '20px' }"
                        ></p-progressSpinner>
                      </span>
                    </div>
                  </div>

                  <!-- Columna 5: Fecha de salida -->
                  <div class="history-column date-column">
                    <span class="date" *ngIf="displayDepartureDate">{{ displayDepartureDate | date : 'dd/MM/yyyy' }}</span>
                    <span class="date" *ngIf="!displayDepartureDate">{{ item.createdAt | date : 'dd/MM/yyyy' }}</span>
                  </div>

                  <!-- Columna 6: Acciones ATC -->
                  <div class="history-column actions-column">
                    <div class="actions-container">
                      <!-- Acciones de ATC -->
                      <span class="actions" *ngIf="isATC">
                        <p-dropdown
                          [options]="paymentStatuses"
                          [(ngModel)]="selectedStatusByPaymentId[item.publicID]"
                          optionLabel="name"
                          optionValue="id"
                          [placeholder]="getPaymentStatusDisplayName(item)"
                          [style]="{ minWidth: '200px' }"
                          [disabled]="loadingStatuses || paymentStatuses.length === 0 || isChanging[item.publicID]"
                          appendTo="body"
                        ></p-dropdown>
                        <button
                          pButton
                          label="Aceptar"
                          class="status-change-btn"
                          [disabled]="isChangeDisabled(item)"
                          [loading]="isChanging[item.publicID]"
                          (click)="onChangeStatusClick(item)"
                        ></button>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              <div
                *ngIf="!paymentHistory || paymentHistory.length === 0"
                class="empty-message"
              >
                No hay ningun pago registrado
              </div>
            </div>
          </p-panel>

          <!-- Historial de recibos -->
          <p-panel
            header="Justificantes de Pago"
            [styleClass]="getPaymentVouchers().length > 0 ? '' : 'empty-panel'"
          >
            <!-- Loading state -->
            <div *ngIf="isLoadingPayments" class="loading-container">
              <p-progressSpinner></p-progressSpinner>
            </div>

            <!-- Lista de justificantes -->
            <div *ngIf="!isLoadingPayments">
              <div *ngIf="getPaymentVouchers().length > 0" class="vouchers-list">
                <div *ngFor="let voucher of getPaymentVouchers(); let i = index" class="voucher-item">
                  <div class="voucher-info">
                    <i class="pi pi-file-pdf" style="margin-right: 8px; color: #f05a4c; font-size: 1.5rem;"></i>
                    <div class="voucher-details">
                      <span class="voucher-name">{{ voucher.fileName || ('Justificante ' + (i + 1)) }}</span>
                      <span class="voucher-date">{{ formatVoucherDate(voucher.uploadDate) }}</span>
                    </div>
                  </div>
                  <div class="voucher-actions">
                    <p-button
                      label="Ver"
                      icon="pi pi-external-link"
                      severity="info"
                      size="small"
                      [text]="true"
                      (onClick)="viewVoucher(voucher)"
                      pTooltip="Ver justificante"
                    ></p-button>
                    <p-button
                      icon="pi pi-trash"
                      severity="danger"
                      size="small"
                      [disabled]="isDeletingVoucher[voucher.id]"
                      (onClick)="deleteVoucher(voucher)"
                      pTooltip="Eliminar justificante"
                    ></p-button>
                    <p-progressSpinner
                      *ngIf="isDeletingVoucher[voucher.id]"
                      styleClass="delete-spinner"
                      [style]="{ width: '16px', height: '16px' }"
                    ></p-progressSpinner>
                  </div>
                </div>
              </div>

              <!-- Mensaje cuando no hay justificantes -->
              <div *ngIf="getPaymentVouchers().length === 0" class="empty-message">
                <i class="pi pi-info-circle" style="margin-right: 8px;"></i>
                No hay justificantes de pago adjuntos
              </div>
            </div>
          </p-panel>
        </div>
      </p-panel>
    </div>
  </div>
</div>

<!-- Modal para registrar pago -->
<p-dialog
  header="Registrar pago"
  [(visible)]="displayPaymentModal"
  [style]="{ width: '450px' }"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="payment-dialog"
>
  <form [formGroup]="paymentForm" (ngSubmit)="onSubmitPayment()">
    <div class="p-field">
      <label for="amount"
        >Importe del pago<span class="required">*</span></label
      >
      <div class="p-inputgroup">
        <input
          type="number"
          pInputText
          formControlName="amount"
          id="amount"
          class="p-inputtext"
        />
        <span class="p-inputgroup-addon">€</span>
      </div>
    </div>

    <div class="p-dialog-footer">
      <p-button
        label="Cancelar"
        icon="pi pi-times"
        (onClick)="hidePaymentModal()"
        styleClass="p-button-outlined"
      ></p-button>
      <p-button
        label="Realizar pago"
        icon="pi pi-check"
        type="submit"
        styleClass="p-button-danger p-button-success"
        [disabled]="paymentForm.invalid"
      ></p-button>
    </div>
  </form>
</p-dialog>

<!-- NUEVO: Modal de revisión de pago -->
<p-dialog
  header="Revisión de pago"
  [(visible)]="displayReviewModal"
  [style]="{ width: '450px' }"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="payment-dialog"
>
  <div class="p-dialog-content">
    <p>Tranferencia de {{ selectedPayment?.amount || 0 | currencyFormat }}</p>
    <p-button
      label="Ver comprobante"
      icon="pi pi-external-link"
      (onClick)="viewPaymentReview()"
      styleClass="p-button-info"
    >
    </p-button>
  </div>
  <p *ngIf="approveMessage">
    {{ approveMessage }}
  </p>
  <div class="p-dialog-footer">
    <p-button
      label="Aprobar"
      icon="pi pi-check"
      (onClick)="approvePaymentReview()"
      styleClass="p-button-success"
      [loading]="isApproveLoading"
    >
    </p-button>
    <p-button
      label="Rechazar"
      icon="pi pi-times-circle"
      (onClick)="rejectPaymentReview()"
      styleClass="p-button-danger"
      [loading]="isRejectLoading"
    >
    </p-button>
  </div>
</p-dialog>

<!-- NUEVO: Modal para añadir pago -->
<app-add-payment-modal
  [(visible)]="displayAddPaymentModal"
  [paymentInfo]="paymentInfo"
  [reservationId]="reservationId"
  (paymentProcessed)="onPaymentProcessed($event)">
</app-add-payment-modal>

<!-- Modal para aplicar cupón -->
<app-apply-coupon-modal
  [(visible)]="displayCouponModal"
  [reservationId]="reservationId"
  (couponApplied)="onCouponApplied()">
</app-apply-coupon-modal>
