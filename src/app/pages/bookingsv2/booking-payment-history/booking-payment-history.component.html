<div class="payment-history-container">
  <div class="payment-row">
    <!-- Resumen del viaje usando el componente summary-table -->
    <div class="payment-column-left">
      <p-panel header="Resumen del viaje">
        <app-summary-table
          [reservationId]="bookingID"
          [refreshTrigger]="refreshTrigger"
          [isAuthenticated]="false"
          [showPointsSection]="false"
          [showTotalSection]="false"
          [showFlightSection]="false"
          [title]="'Resumen del viaje'"
          [currency]="'EUR'"
          [customClass]="'booking-summary panel-background'"
          [showTitle]="false"
        >
        </app-summary-table>
      </p-panel>
    </div>

    <!-- Información de pagos (columna derecha) -->
    <div class="payment-column-right">
      <p-panel header="Pagos">
        <app-booking-payments-header
          [paymentInfo]="paymentInfo"
          [isAgency]="isAgency"
          [grossPaymentInfo]="grossPaymentInfo"
          [netPaymentInfo]="netPaymentInfo"
          [loadingProforma]="loadingProforma"
          [isCancelled]="isCancelled"
          (addPayment)="navigateToPayment()"
          (couponClick)="openCouponModal()"
        ></app-booking-payments-header>

        <p-divider></p-divider>

        <!-- Contenedor de columnas para pagos y historial -->
        <div class="payment-columns-container">

          <p-panel
            header="Historial de pago"
            [styleClass]="
              paymentHistory && paymentHistory.length > 0 ? '' : 'empty-panel'
            "
          >
            <!-- Loading state -->
            <div *ngIf="isLoadingPayments" class="loading-container">
              <p-progressSpinner></p-progressSpinner>
            </div>

            <!-- Payment History List -->
            <div *ngIf="!isLoadingPayments" class="payment-history-list">
              <!-- Payment Items -->
              <article 
                *ngFor="let payment of paymentHistory; trackBy: trackByPaymentId" 
                class="payment-item"
              >
                <!-- Payment Identifiers -->
                <header class="payment-header">
                  <div class="payment-identifiers">
                    <span class="payment-id" *ngIf="payment.id">
                      <strong>ID:</strong>
                      <span>{{ payment.id }}</span>
                    </span>
                    <span class="payment-id" *ngIf="isATC && payment.tkId">
                      <strong>ID TK:</strong>
                      <span>{{ payment.tkId }}</span>
                    </span>
                  </div>
                  <div class="payment-header-actions" *ngIf="isATC">
                    <!-- Botón sincronizado (si ya tiene tkId) -->
                    <p-button
                      *ngIf="payment.tkId"
                      label="Sincronizado con TK"
                      icon="pi pi-check-circle"
                      severity="success"
                      size="small"
                      [disabled]="true"
                      pTooltip="Este pago ya está sincronizado con TourKnife"
                      tooltipPosition="top"
                      appendTo="body"
                    ></p-button>
                    <!-- Botón para sincronizar (si no tiene tkId) -->
                    <p-button
                      *ngIf="!payment.tkId"
                      label="Sincronizar con TK"
                      icon="pi pi-sync"
                      size="small"
                      [disabled]="isSyncingPayment[payment.id?.toString() || '']"
                      [loading]="isSyncingPayment[payment.id?.toString() || '']"
                      (onClick)="syncPaymentWithTk(payment)"
                      pTooltip="Sincronizar pago con TourKnife"
                      tooltipPosition="top"
                      appendTo="body"
                    ></p-button>
                  </div>
                </header>

                <!-- Payment Details -->
                <section class="payment-details">
                  <div class="payment-info">
                    <div class="payment-method" *ngIf="payment.method">
                      <i class="pi pi-credit-card" aria-hidden="true"></i>
                      <span>{{ payment.method }}</span>
                    </div>
                    <div class="payment-amount">
                      {{ payment.amount | currencyFormat }}
                    </div>
                    <div class="payment-status">
                      <p-tag 
                        [value]="getPaymentStatusDisplayName(payment)" 
                        [severity]="getPaymentStatusColor(payment) ? undefined : 'info'"
                        [style.background-color]="getPaymentStatusColor(payment) || undefined"
                        [style.color]="getPaymentStatusColor(payment) ? '#fff' : undefined"
                        [style.border]="getPaymentStatusColor(payment) ? 'none' : undefined"
                      ></p-tag>
                    </div>
                    <div class="payment-date">
                      <time [attr.datetime]="payment.createdAt">
                        {{ payment.createdAt | date : 'dd/MM/yyyy' }}
                      </time>
                    </div>
                  </div>

                  <!-- Payment Actions -->
                  <div class="payment-actions">
                    <!-- Voucher Upload (Transfer payments only) -->
                    <div *ngIf="isTransfer(payment)" class="voucher-upload">
                      <input
                        type="file"
                        [id]="'file-input-' + (payment.id || payment.publicID)"
                        accept="image/*,.pdf"
                        style="display: none;"
                        (change)="onVoucherFileSelect($event, payment)"
                        [disabled]="isUploadingVoucher[payment.id || payment.publicID]"
                      />
                      <p-button
                        [label]="getUploadVoucherButtonLabel(payment)"
                        icon="pi pi-upload"
                        severity="warning"
                        size="small"
                        [disabled]="isUploadingVoucher[payment.id || payment.publicID]"
                        (onClick)="triggerFileInput(payment)"
                        [pTooltip]="getUploadVoucherButtonLabel(payment)"
                      ></p-button>
                      <p-progressSpinner
                        *ngIf="isUploadingVoucher[payment.id || payment.publicID]"
                        styleClass="upload-spinner"
                        [style]="{ width: '20px', height: '20px' }"
                      ></p-progressSpinner>
                    </div>

                    <!-- ATC Actions -->
                    <div *ngIf="isATC" class="atc-actions">
                      <p-dropdown
                        [options]="paymentStatuses"
                        [(ngModel)]="selectedStatusByPaymentId[payment.publicID]"
                        optionLabel="name"
                        optionValue="id"
                        [placeholder]="getPaymentStatusDisplayName(payment)"
                        [style]="{ minWidth: '200px' }"
                        [disabled]="loadingStatuses || paymentStatuses.length === 0 || isChanging[payment.publicID]"
                        appendTo="body"
                      ></p-dropdown>
                      <button
                        pButton
                        label="Aceptar"
                        class="status-change-btn"
                        [disabled]="isChangeDisabled(payment)"
                        [loading]="isChanging[payment.publicID]"
                        (click)="onChangeStatusClick(payment)"
                      ></button>
                    </div>
                  </div>
                </section>
              </article>

              <!-- Empty State -->
              <div 
                *ngIf="!paymentHistory || paymentHistory.length === 0" 
                class="empty-state"
              >
                <p>No hay ningún pago registrado</p>
              </div>
            </div>
          </p-panel>

          <!-- Historial de recibos -->
          <p-panel
            header="Justificantes de Pago"
            [styleClass]="getPaymentVouchers().length > 0 ? '' : 'empty-panel'"
          >
            <!-- Loading state -->
            <div *ngIf="isLoadingPayments" class="loading-container">
              <p-progressSpinner></p-progressSpinner>
            </div>

            <!-- Lista de justificantes -->
            <div *ngIf="!isLoadingPayments">
              <div *ngIf="getPaymentVouchers().length > 0" class="vouchers-list">
                <div *ngFor="let voucher of getPaymentVouchers(); let i = index" class="voucher-item">
                  <div class="voucher-info">
                    <i class="pi pi-file-pdf" style="margin-right: 8px; color: #f05a4c; font-size: 1.5rem;"></i>
                    <div class="voucher-details">
                      <span class="voucher-name">{{ voucher.fileName || ('Justificante ' + (i + 1)) }}</span>
                      <span class="voucher-date">{{ formatVoucherDate(voucher.uploadDate) }}</span>
                    </div>
                  </div>
                  <div class="voucher-actions">
                    <p-button
                      label="Ver"
                      icon="pi pi-external-link"
                      severity="info"
                      size="small"
                      [text]="true"
                      (onClick)="viewVoucher(voucher)"
                      pTooltip="Ver justificante"
                    ></p-button>
                    <p-button
                      icon="pi pi-trash"
                      severity="danger"
                      size="small"
                      [disabled]="isDeletingVoucher[voucher.id]"
                      (onClick)="deleteVoucher(voucher)"
                      pTooltip="Eliminar justificante"
                    ></p-button>
                    <p-progressSpinner
                      *ngIf="isDeletingVoucher[voucher.id]"
                      styleClass="delete-spinner"
                      [style]="{ width: '16px', height: '16px' }"
                    ></p-progressSpinner>
                  </div>
                </div>
              </div>

              <!-- Mensaje cuando no hay justificantes -->
              <div *ngIf="getPaymentVouchers().length === 0" class="empty-message">
                <i class="pi pi-info-circle" style="margin-right: 8px;"></i>
                No hay justificantes de pago adjuntos
              </div>
            </div>
          </p-panel>
        </div>
      </p-panel>
    </div>
  </div>
</div>

<!-- Modal para registrar pago -->
<p-dialog
  header="Registrar pago"
  [(visible)]="displayPaymentModal"
  [style]="{ width: '450px' }"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="payment-dialog"
>
  <form [formGroup]="paymentForm" (ngSubmit)="onSubmitPayment()">
    <div class="p-field">
      <label for="amount"
        >Importe del pago<span class="required">*</span></label
      >
      <div class="p-inputgroup">
        <input
          type="number"
          pInputText
          formControlName="amount"
          id="amount"
          class="p-inputtext"
        />
        <span class="p-inputgroup-addon">€</span>
      </div>
    </div>

    <div class="p-dialog-footer">
      <p-button
        label="Cancelar"
        icon="pi pi-times"
        (onClick)="hidePaymentModal()"
        styleClass="p-button-outlined"
      ></p-button>
      <p-button
        label="Realizar pago"
        icon="pi pi-check"
        type="submit"
        styleClass="p-button-danger p-button-success"
        [disabled]="paymentForm.invalid"
      ></p-button>
    </div>
  </form>
</p-dialog>

<!-- NUEVO: Modal de revisión de pago -->
<p-dialog
  header="Revisión de pago"
  [(visible)]="displayReviewModal"
  [style]="{ width: '450px' }"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="payment-dialog"
>
  <div class="p-dialog-content">
    <p>Tranferencia de {{ selectedPayment?.amount || 0 | currencyFormat }}</p>
    <p-button
      label="Ver comprobante"
      icon="pi pi-external-link"
      (onClick)="viewPaymentReview()"
      styleClass="p-button-info"
    >
    </p-button>
  </div>
  <p *ngIf="approveMessage">
    {{ approveMessage }}
  </p>
  <div class="p-dialog-footer">
    <p-button
      label="Aprobar"
      icon="pi pi-check"
      (onClick)="approvePaymentReview()"
      styleClass="p-button-success"
      [loading]="isApproveLoading"
    >
    </p-button>
    <p-button
      label="Rechazar"
      icon="pi pi-times-circle"
      (onClick)="rejectPaymentReview()"
      styleClass="p-button-danger"
      [loading]="isRejectLoading"
    >
    </p-button>
  </div>
</p-dialog>

<!-- NUEVO: Modal para añadir pago -->
<app-add-payment-modal
  [(visible)]="displayAddPaymentModal"
  [paymentInfo]="paymentInfo"
  [reservationId]="reservationId"
  [isTO]="isTO"
  (paymentProcessed)="onPaymentProcessed($event)">
</app-add-payment-modal>

<!-- Modal para aplicar cupón -->
<app-apply-coupon-modal
  [(visible)]="displayCouponModal"
  [reservationId]="reservationId"
  (couponApplied)="onCouponApplied()">
</app-apply-coupon-modal>
