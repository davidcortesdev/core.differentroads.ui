<p-card styleClass="passenger-card-panel">
  <ng-template #header>
    <div class="passenger-header">
      <i class="pi pi-user"></i>
      <span class="passenger-type">{{
        getPassengerTypeLabel(passenger.type)
      }}</span>
    </div>
  </ng-template>

  <!-- View Mode -->
  <div class="passenger-content" *ngIf="!isEditing">
    <div class="detail-row hab" *ngIf="shouldShowField('room')">
      <span class="detail-label hab">Habitación:</span>
      <span
        class="detail-value hab"
        [ngClass]="{ 'pending-value': !passenger.room }"
        >{{ passenger.room || "Pendiente" }}</span
      >
    </div>

    <div class="passenger-details">
      <div class="passenger-name">
        <h3>{{ passenger.name }} {{ passenger.surname }}</h3>
      </div>

      <!-- Campos generados dinámicamente desde departureReservationFields (COMPLETAMENTE DINÁMICO) -->
      <ng-container *ngFor="let drf of departureReservationFields; trackBy: trackByReservationFieldId">
        <ng-container *ngIf="getReservationFieldDetails(drf.reservationFieldId) as fieldDetails">
          <!-- Excluir campos que ya se muestran en el header (name, surname) y phonePrefix (se muestra junto al teléfono) -->
          <ng-container *ngIf="fieldDetails.code !== 'name' && fieldDetails.code !== 'surname' && fieldDetails.code !== 'phonePrefix'">
            <ng-container *ngIf="getPassengerFieldValue(fieldDetails.code) as fieldValue; else noValue">
              <div class="detail-row">
                <span class="detail-label">
                  {{ fieldDetails.name }}:
                  <span *ngIf="drf.mandatoryTypeId === 2 || (drf.mandatoryTypeId === 3 && isLeadTraveler)" class="required-indicator">*</span>
                </span>
                
                <!-- Mostrar valor del campo (con formato especial para sexo, fechas y teléfono) -->
                <span class="detail-value">
                  <ng-container *ngIf="fieldDetails.fieldType === 'date'">
                    {{ formatDate(fieldValue || "") }}
                  </ng-container>
                  <ng-container *ngIf="fieldDetails.code === 'sex'">
                    {{ getGenderLabel(fieldValue) }}
                  </ng-container>
                  <ng-container *ngIf="fieldDetails.code === 'phone'">
                    <ng-container *ngIf="getPassengerFieldValue('phonePrefix') as phonePrefix">
                      <span>{{ phonePrefix }} </span>
                    </ng-container>
                    {{ fieldValue }}
                  </ng-container>
                  <ng-container *ngIf="fieldDetails.fieldType !== 'date' && fieldDetails.code !== 'sex' && fieldDetails.code !== 'phone'">
                    {{ fieldValue }}
                  </ng-container>
                </span>
              </div>
            </ng-container>
            
            <!-- Mostrar icono de info si no hay valor -->
            <ng-template #noValue>
              <div class="detail-row">
                <span class="detail-label">
                  {{ fieldDetails.name }}:
                  <span *ngIf="drf.mandatoryTypeId === 2 || (drf.mandatoryTypeId === 3 && isLeadTraveler)" class="required-indicator">*</span>
                </span>
                <span class="detail-value">
                  <i class="pi pi-info-circle"
                    [pTooltip]="(drf.mandatoryTypeId === 2 || (drf.mandatoryTypeId === 3 && isLeadTraveler)) ? 'Este campo es obligatorio' : 'Este dato no es obligatorio para realizar la reserva'"
                    [ngClass]="{ 'required-field': drf.mandatoryTypeId === 2 || (drf.mandatoryTypeId === 3 && isLeadTraveler) }"></i>
                </span>
              </div>
            </ng-template>
          </ng-container>
        </ng-container>
      </ng-container>
    </div>
  </div>

  <!-- Edit Mode -->
  <div class="passenger-content edit-mode" *ngIf="isEditing">
    <form [formGroup]="passengerForm">
      <div class="detail-row hab" *ngIf="shouldShowField('room')">
        <span class="detail-label hab">Habitación:</span>
        <span
          class="detail-value hab"
          [ngClass]="{ 'pending-value': !passenger.room }"
          >{{ passenger.room || "Pendiente" }}</span
        >
      </div>

      <div class="update-passenger-details">
        <!-- Campos name y surname (siempre visibles si están en departureReservationFields) -->
        <ng-container *ngIf="departureReservationFields && departureReservationFields.length > 0">
          <ng-container *ngFor="let drf of departureReservationFields; trackBy: trackByReservationFieldId">
          <ng-container *ngIf="getReservationFieldDetails(drf.reservationFieldId) as fieldDetails">
            <!-- Campo nombre -->
            <ng-container *ngIf="fieldDetails.code === 'name'">
              <div class="form-field">
                <label>
                  {{ fieldDetails.name }}:
                  <span *ngIf="drf.mandatoryTypeId === 2 || (drf.mandatoryTypeId === 3 && isLeadTraveler)" class="required-indicator">*</span>
                </label>
                <input
                  pInputText
                  formControlName="fullName"
                  placeholder="Ingrese su nombre completo"
                />
              </div>
            </ng-container>
            <!-- Campo apellido -->
            <ng-container *ngIf="fieldDetails.code === 'surname'">
              <div class="form-field">
                <label>
                  {{ fieldDetails.name }}:
                  <span *ngIf="drf.mandatoryTypeId === 2 || (drf.mandatoryTypeId === 3 && isLeadTraveler)" class="required-indicator">*</span>
                </label>
                <input
                  pInputText
                  formControlName="surname"
                  placeholder="Ingrese su apellido completo"
                />
              </div>
            </ng-container>
          </ng-container>
        </ng-container>
        </ng-container>

        <!-- Campos generados dinámicamente desde departureReservationFields -->
        <ng-container *ngIf="departureReservationFields && departureReservationFields.length > 0">
          <ng-container *ngFor="let drf of departureReservationFields; trackBy: trackByReservationFieldId">
          <ng-container *ngIf="getReservationFieldDetails(drf.reservationFieldId) as fieldDetails">
            <!-- Excluir campos que se muestran en el header (name, surname) y phonePrefix (se muestra junto al teléfono) -->
            <ng-container *ngIf="fieldDetails.code !== 'name' && fieldDetails.code !== 'surname' && fieldDetails.code !== 'phonePrefix'">
              
              <!-- Campo de teléfono con prefijo -->
              <ng-container *ngIf="fieldDetails.code === 'phone'">
                <div class="form-field">
                  <label>
                    {{ fieldDetails.name }}:
                    <span *ngIf="drf.mandatoryTypeId === 2 || (drf.mandatoryTypeId === 3 && isLeadTraveler)" class="required-indicator">*</span>
                  </label>
                  <div class="phone-row">
                    <app-phone-prefix-select
                      *ngIf="phonePrefixOptions.length > 0"
                      [(ngModel)]="selectedPhonePrefix"
                      name="prefijo"
                      [ngModelOptions]="{standalone: true}"
                      [phonePrefixOptions]="phonePrefixOptions"
                      [placeholder]="'Seleccione prefijo'"
                      [showClear]="true"
                      [filter]="true"
                      [disabled]="!isEditing"
                      [styleClass]="'prefix-select'"
                      [smallSize]="true"
                      (prefixChange)="onPhonePrefixChange({ value: $event })">
                    </app-phone-prefix-select>
                    <input
                      pInputText
                      [formControlName]="getFormControlName(fieldDetails.code)"
                      placeholder="Ingrese su teléfono"
                      inputmode="tel"
                      maxlength="20"
                      (input)="onPhoneInput($event)"
                    />
                  </div>
                </div>
              </ng-container>

              <!-- Campo de sexo (dropdown) -->
              <ng-container *ngIf="fieldDetails.code === 'sex'">
                <div class="form-field">
                  <label>
                    {{ fieldDetails.name }}:
                    <span *ngIf="drf.mandatoryTypeId === 2 || (drf.mandatoryTypeId === 3 && isLeadTraveler)" class="required-indicator">*</span>
                  </label>
                  <p-dropdown
                    [formControlName]="getFormControlName(fieldDetails.code)"
                    [options]="genderOptions"
                    optionLabel="label"
                    optionValue="value"
                    [placeholder]="'Seleccione su sexo'"
                    [disabled]="!isEditing"
                    styleClass="custom-dropdown"
                    [showClear]="true"
                    [autoDisplayFirst]="false"
                  ></p-dropdown>
                </div>
              </ng-container>

              <!-- Campo de fecha -->
              <ng-container *ngIf="fieldDetails.fieldType === 'date' && fieldDetails.code !== 'sex'">
                <div class="form-field">
                  <label>
                    {{ fieldDetails.name }}:
                    <span *ngIf="drf.mandatoryTypeId === 2 || (drf.mandatoryTypeId === 3 && isLeadTraveler)" class="required-indicator">*</span>
                  </label>
                  <p-datepicker
                    [formControlName]="getFormControlName(fieldDetails.code)"
                    placeholder="dd/mm/aaaa"
                    [showIcon]="true"
                    appendTo="body"
                    dateFormat="dd/mm/yy"
                    [maxDate]="fieldDetails.code === 'birthdate' ? today : undefined"
                    [minDate]="fieldDetails.code === 'minorIdExpirationDate' || fieldDetails.code === 'documentExpirationDate' ? today : undefined"
                  ></p-datepicker>
                </div>
              </ng-container>

              <!-- Campo de email -->
              <ng-container *ngIf="fieldDetails.fieldType === 'email'">
                <div class="form-field">
                  <label>
                    {{ fieldDetails.name }}:
                    <span *ngIf="drf.mandatoryTypeId === 2 || (drf.mandatoryTypeId === 3 && isLeadTraveler)" class="required-indicator">*</span>
                  </label>
                  <input
                    pInputText
                    type="email"
                    [formControlName]="getFormControlName(fieldDetails.code)"
                    [placeholder]="'Ingrese su ' + fieldDetails.name.toLowerCase()"
                  />
                </div>
              </ng-container>

              <!-- Campo de texto (excluyendo phone y sex que ya se manejan arriba) -->
              <ng-container *ngIf="fieldDetails.fieldType === 'text' && fieldDetails.code !== 'phone' && fieldDetails.code !== 'sex'">
                <div class="form-field">
                  <label>
                    {{ fieldDetails.name }}:
                    <span *ngIf="drf.mandatoryTypeId === 2 || (drf.mandatoryTypeId === 3 && isLeadTraveler)" class="required-indicator">*</span>
                  </label>
                  <input
                    pInputText
                    [formControlName]="getFormControlName(fieldDetails.code)"
                    [placeholder]="'Ingrese su ' + fieldDetails.name.toLowerCase()"
                  />
                </div>
              </ng-container>

              <!-- Campo comfortPlan (solo lectura) -->
              <ng-container *ngIf="fieldDetails.code === 'comfortPlan'">
                <div class="detail-row">
                  <span class="detail-label">{{ fieldDetails.name }}:</span>
                  <span class="detail-value">{{ getComfortPlanValue() }}</span>
                </div>
              </ng-container>

            </ng-container>
          </ng-container>
        </ng-container>
        </ng-container>
      </div>
    </form>
  </div>

  <ng-template #footer>
    <div class="passenger-footer">
      <div
        *ngIf="!isEditing && hasPendingFields()"
        class="pending-fields-indicator"
      >
        <i class="pi pi-info-circle"></i>
        <span>Completa tus datos antes de tu viaje.</span>
      </div>

      <!-- This spacer ensures the edit button is always on the right, even if no pending indicator -->
      <div *ngIf="!isEditing && !hasPendingFields()" class="flex-spacer"></div>

      <!-- Edit button in view mode -->
      <div class="edit-button-container">
        <p-button
    *ngIf="!isEditing"
    icon="pi pi-pencil"
    styleClass="p-button-rounded p-button-text"
    [pTooltip]="(isEditingBlocked && !isATC) ? 'Edición bloqueada - Faltan ' + Days + ' días o menos para el viaje' : 'Editar pasajero'"
    [disabled]="isEditingBlocked && !isATC"
    (onClick)="onEdit()"
  >
  </p-button>
      </div>

      <!-- Save buttons in edit mode -->
      <div *ngIf="isEditing" class="edit-buttons">
        <p-button
          label="Guardar"
          icon="pi pi-check"
          styleClass="p-button-success"
          (onClick)="onSave()"
        >
        </p-button>
        <p-button
          icon="pi pi-times"
          styleClass="p-button-text p-button-danger ml-2 p-button-rounded"
          (onClick)="onCancel()"
        >
        </p-button>
      </div>
    </div>
  </ng-template>
</p-card>
