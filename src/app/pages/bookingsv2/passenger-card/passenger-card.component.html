<p-card styleClass="passenger-card-panel">
  <ng-template #header>
    <div class="passenger-header">
      <i class="pi pi-user"></i>
      <span class="passenger-type">{{
        getPassengerTypeLabel(passenger.type)
      }}</span>
    </div>
  </ng-template>

  <!-- View Mode -->
  <div class="passenger-content" *ngIf="!isEditing">
    <div class="detail-row hab" *ngIf="shouldShowField('room')">
      <span class="detail-label hab">Habitación:</span>
      <span
        class="detail-value hab"
        [ngClass]="{ 'pending-value': !passenger.room }"
        >{{ passenger.room || "Pendiente" }}</span
      >
    </div>

    <div class="passenger-details">
      <div class="passenger-name">
        <h3>{{ passenger.name }} {{ passenger.surname }}</h3>
      </div>

      <!-- Campos generados dinámicamente desde departureReservationFields (COMPLETAMENTE DINÁMICO) -->
      <ng-container *ngFor="let drf of departureReservationFields; trackBy: trackByReservationFieldId">
        <ng-container *ngIf="getReservationFieldDetails(drf.reservationFieldId) as fieldDetails">
          <!-- Excluir campos que ya se muestran en el header (name, surname) y phonePrefix (se muestra junto al teléfono) -->
          <ng-container *ngIf="fieldDetails.code !== 'name' && fieldDetails.code !== 'surname' && fieldDetails.code !== 'phonePrefix'">
            <ng-container *ngIf="getPassengerFieldValue(fieldDetails.code) as fieldValue; else noValue">
              <div class="detail-row">
                <span class="detail-label">
                  {{ fieldDetails.name }}:
                  <span *ngIf="drf.mandatoryTypeId === 2 || (drf.mandatoryTypeId === 3 && isLeadTraveler)" class="required-indicator">*</span>
                </span>
                
                <!-- Mostrar valor del campo (con formato especial para sexo, fechas y teléfono) -->
                <span class="detail-value">
                  <ng-container *ngIf="fieldDetails.fieldType === 'date'">
                    {{ formatDate(fieldValue || "") }}
                  </ng-container>
                  <ng-container *ngIf="fieldDetails.code === 'sex'">
                    {{ getGenderLabel(fieldValue) }}
                  </ng-container>
                  <ng-container *ngIf="fieldDetails.code === 'phone'">
                    <ng-container *ngIf="getPassengerFieldValue('phonePrefix') as phonePrefix">
                      <span>{{ phonePrefix }} </span>
                    </ng-container>
                    {{ fieldValue }}
                  </ng-container>
                  <ng-container *ngIf="fieldDetails.fieldType !== 'date' && fieldDetails.code !== 'sex' && fieldDetails.code !== 'phone'">
                    {{ fieldValue }}
                  </ng-container>
                </span>
              </div>
            </ng-container>
            
            <!-- Mostrar icono de info si no hay valor -->
            <ng-template #noValue>
              <div class="detail-row">
                <span class="detail-label">
                  {{ fieldDetails.name }}:
                  <span *ngIf="drf.mandatoryTypeId === 2 || (drf.mandatoryTypeId === 3 && isLeadTraveler)" class="required-indicator">*</span>
                </span>
                <span class="detail-value">
                  <i class="pi pi-info-circle"
                    [pTooltip]="(drf.mandatoryTypeId === 2 || (drf.mandatoryTypeId === 3 && isLeadTraveler)) ? 'Este campo es obligatorio' : 'Este dato no es obligatorio para realizar la reserva'"
                    [ngClass]="{ 'required-field': drf.mandatoryTypeId === 2 || (drf.mandatoryTypeId === 3 && isLeadTraveler) }"></i>
                </span>
              </div>
            </ng-template>
          </ng-container>
        </ng-container>
      </ng-container>
    </div>
  </div>

  <!-- Edit Mode -->
  <div class="passenger-content edit-mode" *ngIf="isEditing">
    <form [formGroup]="passengerForm">
      <div class="detail-row hab" *ngIf="shouldShowField('room')">
        <span class="detail-label hab">Habitación:</span>
        <span
          class="detail-value hab"
          [ngClass]="{ 'pending-value': !passenger.room }"
          >{{ passenger.room || "Pendiente" }}</span
        >
      </div>

      <div class="update-passenger-details">
        <div class="form-field" *ngIf="shouldShowField('name')">
          <label>Nombre:</label>
          <input
            pInputText
            formControlName="fullName"
            placeholder="Ingrese su nombre completo"
          />
        </div>
        <div class="form-field" *ngIf="shouldShowField('surname')">
          <label>Apellido:</label>
          <input
            pInputText
            formControlName="surname"
            placeholder="Ingrese su apellido completo"
          />
        </div>

        <div class="form-field" *ngIf="shouldShowField('phone')">
          <label>Teléfono:</label>
          <div class="phone-row">
            <app-phone-prefix-select
              *ngIf="phonePrefixOptions.length > 0"
              [(ngModel)]="selectedPhonePrefix"
              name="prefijo"
              [ngModelOptions]="{standalone: true}"
              [phonePrefixOptions]="phonePrefixOptions"
              [placeholder]="'Seleccione prefijo'"
              [showClear]="true"
              [filter]="true"
              [disabled]="!isEditing"
              [styleClass]="'prefix-select'"
              (prefixChange)="onPhonePrefixChange({ value: $event })">
            </app-phone-prefix-select>
            <input
              pInputText
              formControlName="phone"
              placeholder="Ingrese su teléfono"
              inputmode="tel"
              maxlength="20"
              (input)="onPhoneInput($event)"
            />
          </div>
        </div>

        <div class="form-field" *ngIf="shouldShowField('email')">
          <label>Email:</label>
          <input
            pInputText
            formControlName="email"
            placeholder="Ingrese su email"
          />
        </div>

        <div class="form-field" *ngIf="shouldShowField('gender')">
          <label>Sexo:</label>
          <p-dropdown
            formControlName="gender"
            [options]="genderOptions"
            optionLabel="label"
            optionValue="value"
            placeholder="Seleccione su sexo"
            [disabled]="!isEditing"
            styleClass="custom-dropdown"
            [showClear]="true"
            [autoDisplayFirst]="false"
          ></p-dropdown>
        </div>

        <div class="form-field" *ngIf="shouldShowField('birthDate')">
          <label>Fecha de nacimiento:</label>
          <p-datepicker
            formControlName="birthDate"
            placeholder="dd/mm/aaaa"
            [showIcon]="true"
            appendTo="body"
            dateFormat="dd/mm/yy"
            [maxDate]="today"
          ></p-datepicker>
        </div>

        <div class="form-field" *ngIf="shouldShowField('ciudad')">
          <label>Ciudad:</label>
          <input
            pInputText
            formControlName="ciudad"
            placeholder="Ingrese su ciudad"
          />
        </div>

        <div class="form-field" *ngIf="shouldShowField('codigoPostal')">
          <label>Código postal:</label>
          <input
            pInputText
            formControlName="codigoPostal"
            placeholder="Ingrese su código postal"
          />
        </div>

        <div class="form-field" *ngIf="shouldShowField('nationality')">
          <label>Nacionalidad</label>
          <input
            pInputText
            formControlName="nationality"
            placeholder="Ingrese su nacionalidad"
          />
        </div>

        <div class="form-field" *ngIf="shouldShowField('dni')">
          <label>DNI:</label>
          <input
            pInputText
            formControlName="dni"
            placeholder="Ingrese su DNI"
          />
        </div>

        <div class="form-field" *ngIf="shouldShowField('minorIdIssueDate')">
          <label>Fecha de expedición DNI:</label>
          <p-datepicker
            formControlName="minorIdIssueDate"
            placeholder="dd/mm/aaaa"
            [showIcon]="true"
            appendTo="body"
            dateFormat="dd/mm/yy"
            [maxDate]="today"
          ></p-datepicker>
        </div>

        <div
          class="form-field"
          *ngIf="shouldShowField('minorIdExpirationDate')"
        >
          <label>Fecha de caducidad DNI:</label>
          <p-datepicker
            formControlName="minorIdExpirationDate"
            placeholder="dd/mm/aaaa"
            [showIcon]="true"
            appendTo="body"
            dateFormat="dd/mm/yy"
            [minDate]="today"
          ></p-datepicker>
        </div>

        <div class="form-field" *ngIf="shouldShowField('passportID')">
          <label>Pasaporte:</label>
          <input
            pInputText
            formControlName="passportID"
            placeholder="Ingrese N° pasaporte"
          />
        </div>

        <div
          class="form-field"
          *ngIf="shouldShowField('documentExpeditionDate')"
        >
          <label>Fecha de expedición:</label>
          <p-datepicker
            formControlName="documentExpeditionDate"
            placeholder="dd/mm/aaaa"
            [showIcon]="true"
            appendTo="body"
            dateFormat="dd/mm/yy"
            [maxDate]="today"
          ></p-datepicker>
        </div>

        <div
          class="form-field"
          *ngIf="shouldShowField('documentExpirationDate')"
        >
          <label>Fecha de caducidad:</label>
          <p-datepicker
            formControlName="documentExpirationDate"
            placeholder="dd/mm/aaaa"
            [showIcon]="true"
            appendTo="body"
            dateFormat="dd/mm/yy"
          ></p-datepicker>
        </div>

        <div class="detail-row" *ngIf="shouldShowField('comfortPlan')">
          <span class="detail-label">Seguro:</span>
          <span class="detail-value">{{ getComfortPlanValue() }}</span>
        </div>
      </div>
    </form>
  </div>

  <ng-template #footer>
    <div class="passenger-footer">
      <div
        *ngIf="!isEditing && hasPendingFields()"
        class="pending-fields-indicator"
      >
        <i class="pi pi-info-circle"></i>
        <span>Completa tus datos antes de tu viaje.</span>
      </div>

      <!-- This spacer ensures the edit button is always on the right, even if no pending indicator -->
      <div *ngIf="!isEditing && !hasPendingFields()" class="flex-spacer"></div>

      <!-- Edit button in view mode -->
      <div class="edit-button-container">
        <p-button
          *ngIf="!isEditing"
          icon="pi pi-pencil"
          styleClass="p-button-rounded p-button-text"
          pTooltip="Editar pasajero"
          (onClick)="onEdit()"
        >
        </p-button>
      </div>

      <!-- Save buttons in edit mode -->
      <div *ngIf="isEditing" class="edit-buttons">
        <p-button
          label="Guardar"
          icon="pi pi-check"
          styleClass="p-button-success"
          (onClick)="onSave()"
        >
        </p-button>
        <p-button
          icon="pi pi-times"
          styleClass="p-button-text p-button-danger ml-2 p-button-rounded"
          (onClick)="onCancel()"
        >
        </p-button>
      </div>
    </div>
  </ng-template>
</p-card>
