<div class="checkout">
  <!-- Toast para mensajes -->
  <p-toast></p-toast>

  <!-- Título del tour -->
  <h2 class="checkout-title">
    <p-button
      [link]="true"
      [routerLink]="['/tour', tourSlug]"
      class="tour-link plain-text"
      *ngIf="tourSlug && !isStandaloneMode; else plainTitle"
    >
      {{ tourName }}
    </p-button>
    <ng-template #plainTitle>
      {{ tourName }}
      <span *ngIf="isStandaloneMode" class="standalone-badge">
        <i class="pi pi-external-link"></i> Checkout Externo
      </span>
    </ng-template>
  </h2>

  <!-- Fechas del tour -->
  <p class="checkout-subtitle">
    {{ tourDates }}
  </p>

  <!-- Container principal -->
  <div class="checkout-container">
    <!-- Contenido principal con steps -->
    <div class="main-content">
      <div class="steps-container full-width">
        <!-- Steps de PrimeNG -->
        <p-steps
          [model]="items"
          [readonly]="false"
          [activeIndex]="activeIndex"
          (activeIndexChange)="onActiveIndexChange($event)"
        ></p-steps>

        <!-- Contenido de cada paso -->
        <div [ngSwitch]="activeIndex">
          <!-- Step 1: Personalizar viaje -->
          <div *ngSwitchCase="0">
            <!-- Componente selector de viajeros -->
            <app-selector-traveler
              [departureId]="departureId"
              [reservationId]="reservationId"
              [availableTravelers]="['Adultos', 'Niños', 'Bebés']"
              (travelersNumbersChange)="onTravelersNumbersChange($event)"
              (saveStatusChange)="onTravelerSelectorSaveStatusChange($event)"
              (saveCompleted)="onTravelerSelectorSaveCompleted($event)"
              #travelerSelector
            >
            </app-selector-traveler>

            <!-- Componente selector de habitaciones -->
            <app-selector-room
              [departureId]="departureId"
              [reservationId]="reservationId"
              (roomsSelectionChange)="onRoomsSelectionChange($event)"
              #roomSelector
            >
            </app-selector-room>

            <!-- Componente actividades opcionales -->
            <app-activities-optionals
              #activitiesOptionals
              [itineraryId]="itineraryId"
              [departureId]="departureId"
              [reservationId]="reservationId"
              (activitiesSelectionChange)="onActivitiesSelectionChange($event)"
            >
            </app-activities-optionals>

            <!-- Componente de seguro -->
            <app-insurance
              [tourId]="tourId"
              [departureId]="departureId"
              [itineraryId]="itineraryId"
              [reservationId]="reservationId"
              (insuranceSelectionChange)="onInsuranceSelectionChange($event)"
              #insuranceSelector
            >
            </app-insurance>

            <div class="flex pt-6 justify-end">
              <p-button
                class="next"
                label="Continuar"
                icon="pi pi-arrow-right"
                iconPos="right"
                (onClick)="nextStepWithValidation(1)"
              ></p-button>
            </div>
          </div>

          <!-- Step 2: Vuelos -->
          <div *ngSwitchCase="1">
            <!-- Componente de gestión de vuelos -->
            <app-flight-management
              #flightManagement
              [departureId]="departureId ?? 0"
              [reservationId]="reservationId ?? 0"
              [tourId]="tourId ?? 0"
              [selectedFlight]="selectedFlight"
              [departureActivityPackId]="departureActivityPackId"
              [isStandaloneMode]="isStandaloneMode"
              (flightSelectionChange)="onFlightSelectionChange($event)"
            >
            </app-flight-management>

            <div class="flight-buttons">
              <p-button
                *ngIf="hasAvailableFlights"
                class="without-flight"
                [label]="
                  isFlightlessProcessing
                    ? flightlessProcessingMessage
                    : 'Lo quiero sin vuelos'
                "
                [icon]="isFlightlessProcessing ? 'pi pi-spinner pi-spin' : ''"
                [disabled]="isFlightlessProcessing"
                [loading]="isFlightlessProcessing"
                (onClick)="
                  checkAuthAndContinue(2, onActiveIndexChange.bind(this), true)
                "
              ></p-button>
              <p-button
                class="continue-button"
                label="Continuar"
                icon="pi pi-arrow-right"
                iconPos="right"
                [disabled]="!selectedFlight || isFlightlessProcessing"
                [pTooltip]="getContinueButtonTooltip()"
                tooltipPosition="top"
                (onClick)="
                  checkAuthAndContinue(2, onActiveIndexChange.bind(this), false)
                "
              ></p-button>
            </div>
          </div>

          <!-- Step 3: Viajeros -->
          <div *ngSwitchCase="2">
            <app-info-travelers
              [departureId]="departureId"
              [reservationId]="reservationId"
              [itineraryId]="itineraryId"
              (activitiesAssignmentChange)="
                onActivitiesAssignmentChange($event)
              "
              (roomAssignmentsChange)="onRoomAssignmentsChange($event)"
              #infoTravelers
            >
            </app-info-travelers>

            <div class="flight-buttons">
              <p-button
                label="Continuar"
                icon="pi pi-arrow-right"
                iconPos="right"
                (onClick)="
                  checkAuthAndContinue(3, onActiveIndexChange.bind(this), false)
                "
              ></p-button>
            </div>
          </div>

          <!-- Step 4: Pago -->
          <div *ngSwitchCase="3">
            <!-- Componente de pago -->
            <app-payment-management
              [totalPrice]="totalAmountCalculated"
              [reservationId]="reservationId ?? 0"
              [departureDate]="departureDate"
              (navigateToStep)="onNavigateToStep($event)"
              (pointsDiscountChange)="onPointsDiscountChange($event)"
            >
            </app-payment-management>
          </div>
        </div>
      </div>
      <!-- Budget Options Section Footer -->
      <div class="tour-additional-info-container">
        <!-- Card para "Guarda tu presupuesto" con tooltip mejorado -->
        <p-card
          styleClass="action-card"
          (click)="handleSaveBudget()"
          [pTooltip]="
            !isAuthenticated && !isStandaloneMode
              ? 'Para guardar tu presupuesto debes iniciar sesión o registrarte en la plataforma'
              : isStandaloneMode && !isAuthenticated
              ? 'Esta función requiere acceso desde la plataforma principal con sesión iniciada'
              : 'Guarda este presupuesto en tu perfil para consultarlo más tarde'
          "
          tooltipPosition="top"
        >
          <div class="card-content">
            <span class="bg-pink-100">
              <i class="pi pi-bookmark" aria-hidden="true"></i>
            </span>
            <span class="card-text">Guarda tu presupuesto</span>
          </div>
        </p-card>

        <!-- Card para "Descarga tu presupuesto" con tooltip -->
        <p-card
          styleClass="action-card claseBord"
          (click)="handleDownloadBudget()"
          pTooltip="Envia un email con un PDF con toda la información de este presupuesto"
          tooltipPosition="top"
        >
          <div class="card-content">
            <span class="bg-pink-100">
              <i class="pi pi-download" aria-hidden="true"></i>
            </span>
            <span class="card-text">Descarga tu presupuesto</span>
          </div>
        </p-card>

        <!-- Card para "Comparte tu presupuesto con alguien" con tooltip (ahora abre el mismo modal) -->
        <p-card
          styleClass="action-card"
          (click)="handleShareBudget()"
          pTooltip="Comparte este presupuesto con amigos o familiares"
          tooltipPosition="top"
        >
          <div class="card-content">
            <span class="bg-pink-100">
              <i class="pi pi-user-plus" aria-hidden="true"></i>
            </span>
            <span class="card-text">Comparte tu presupuesto con alguien</span>
          </div>
        </p-card>
      </div>
    </div>

    <!-- Columna derecha - Resumen -->
    <div class="right-column">
      <!-- Resumen del pedido usando SummaryTableComponent -->
      <app-summary-table
        [reservationId]="reservationId || undefined"
        [refreshTrigger]="summaryRefreshTrigger"
        [isAuthenticated]="false"
        [selectedFlight]="selectedFlight"
        [showPointsSection]="false"
        [showTotalSection]="true"
        [showFlightSection]="true"
        [currency]="'EUR'"
        [title]="'Resumen del pedido'"
        [pointsDiscount]="pointsDiscount"
      >
      </app-summary-table>
    </div>
  </div>

  <!-- Indicadores de carga y error -->
  <div *ngIf="loading" class="loading-indicator">
    <p>Cargando información de la reserva...</p>
  </div>

  <div *ngIf="error" class="error-message">
    <p>{{ error }}</p>
  </div>

  <!-- Modal de login -->
  <app-login-modal
    [visible]="loginDialogVisible"
    (close)="closeLoginModal()"
    (login)="navigateToLogin()"
    (register)="navigateToRegister()"
  >
  </app-login-modal>
</div>
