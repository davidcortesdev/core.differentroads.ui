<div class="checkout">
  <!-- Toast para mensajes -->
  <p-toast></p-toast>

  <!-- Título del tour -->
  <h2 class="checkout-title">
    <p-button 
      [link]="true" 
      [routerLink]="['/tour', tourSlug]" 
      class="tour-link plain-text"
      *ngIf="tourSlug; else plainTitle">
      {{ tourName }}
    </p-button>
    <ng-template #plainTitle>
      {{ tourName }}
    </ng-template>
  </h2>

  <!-- Fechas del tour -->
  <p class="checkout-subtitle">
    {{ tourDates }}
  </p>

  <!-- Container principal -->
  <div class="checkout-container">
    <!-- Contenido principal con steps -->
    <div class="main-content">
      <div class="steps-container full-width">
        <!-- Steps de PrimeNG -->
        <p-steps
          [model]="items"
          [readonly]="false"
          [activeIndex]="activeIndex"
          (activeIndexChange)="onActiveIndexChange($event)"
        ></p-steps>

        <!-- Contenido de cada paso -->
        <div [ngSwitch]="activeIndex">
          <!-- Step 1: Personalizar viaje -->
          <div *ngSwitchCase="0">
            <!-- Componente selector de viajeros -->
            <app-selector-traveler 
              [departureId]="departureId"
              [reservationId]="reservationId"
              [availableTravelers]="['Adultos', 'Niños', 'Bebés']"
              (travelersNumbersChange)="onTravelersNumbersChange($event)"
              #travelerSelector>
            </app-selector-traveler>
            
            <!-- Componente selector de habitaciones -->
            <app-selector-room 
              [departureId]="departureId"
              [reservationId]="reservationId"
              (roomsSelectionChange)="onRoomsSelectionChange($event)"
              #roomSelector>
            </app-selector-room>

            <!-- Componente de seguro -->
            <app-insurance
              [tourId]="tourId"
              [departureId]="departureId"
              [itineraryId]="itineraryId"
              [reservationId]="reservationId"
              (insuranceSelectionChange)="onInsuranceSelectionChange($event)"
              #insuranceSelector>
            </app-insurance>

            <div class="flex pt-6 justify-end">
              <p-button
                class="next"
                label="Continuar"
                icon="pi pi-arrow-right"
                iconPos="right"
                (onClick)="nextStepWithValidation(1)"
              ></p-button>
            </div>
          </div>

          <!-- Step 2: Vuelos -->
          <div *ngSwitchCase="1">
            <!-- Componente de gestión de vuelos -->
            <app-flight-management [departureId]="departureId ?? 0" [reservationId]="reservationId ?? 0" [tourId]="tourId ?? 0"></app-flight-management>

            <div class="flight-buttons">
              <p-button
                class="without-flight"
                label="Lo quiero sin vuelos"
                (onClick)="nextStepWithValidation(2)"
              ></p-button>
              <p-button
                class="continue-button"
                label="Continuar"
                icon="pi pi-arrow-right"
                iconPos="right"
                (onClick)="nextStepWithValidation(2)"
              ></p-button>
            </div>
          </div>

          <!-- Step 3: Viajeros -->
          <div *ngSwitchCase="2">
            <h3>Viajeros</h3>
            <p>Contenido del paso 3 - Viajeros</p>

            <div class="flex pt-6 justify-between">
              <p-button
                label="Continuar"
                icon="pi pi-arrow-right"
                iconPos="right"
                (onClick)="nextStepWithValidation(3)"
              ></p-button>
            </div>
          </div>

          <!-- Step 4: Pago -->
          <div *ngSwitchCase="3">
            <!-- Componente de pago -->
             <app-payment-management></app-payment-management>

            <div class="flex pt-6 justify-between">
              <p-button
                label="Finalizar reserva"
                icon="pi pi-check"
                iconPos="right"
              ></p-button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Columna derecha - Resumen -->
    <div class="right-column">
      <!-- Resumen del pedido usando SummaryTableComponent -->
      <app-summary-table
        [summary]="summary"
        [subtotal]="subtotal"
        [total]="totalAmountCalculated"
        [isAuthenticated]="false"
        [selectedFlight]="null"
        [showPointsSection]="false"
        [showTotalSection]="true"
        [showFlightSection]="false"
        [currency]="'EUR'"
        [title]="'Resumen del pedido'"
      >
      </app-summary-table>
    </div>
  </div>

  <!-- Indicadores de carga y error -->
  <div *ngIf="loading" class="loading-indicator">
    <p>Cargando información de la reserva...</p>
  </div>

  <div *ngIf="error" class="error-message">
    <p>{{ error }}</p>
  </div>
</div>