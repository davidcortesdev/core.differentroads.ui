<div class="checkout">
  <!-- Toast para mensajes -->
  <p-toast></p-toast>

  <!-- Título del tour -->
  <h2 class="checkout-title">
    <p-button
      [link]="true"
      [routerLink]="['/tour', tourSlug]"
      class="tour-link plain-text"
      *ngIf="tourSlug && !isStandaloneMode; else plainTitle"
    >
      {{ tourName }}
    </p-button>
    <ng-template #plainTitle>
      {{ tourName }}
      <span *ngIf="isStandaloneMode" class="standalone-badge">
        <i class="pi pi-external-link"></i> Checkout Externo
      </span>
    </ng-template>
  </h2>

  <!-- Fechas del tour -->
  <p class="checkout-subtitle">
    {{ tourDates }}
  </p>

  <!-- Container principal -->
  <div class="checkout-container">
    <!-- Contenido principal con steps -->
    <div class="main-content">
      <div class="steps-container full-width">
        <!-- Steps de PrimeNG -->
        <p-steps
          [model]="items"
          [readonly]="true"
          [activeIndex]="activeIndex"
          (activeIndexChange)="onActiveIndexChange($event)"
        ></p-steps>

        <!-- Contenido de cada paso -->
        <div [ngSwitch]="activeIndex">
          <!-- Step 1: Personalizar viaje -->
          <div *ngSwitchCase="0">
            <!-- Componente selector de viajeros -->
            <app-selector-traveler
              [departureId]="departureId"
              [reservationId]="reservationId"
              (travelersUpdated)="onTravelersUpdated()"
              #travelerSelector
            >
            </app-selector-traveler>

            <!-- Componente selector de habitaciones -->
            <app-selector-room
              [departureId]="departureId"
              [reservationId]="reservationId"
              (roomsUpdated)="onRoomsUpdated()"
              #roomSelector
            >
            </app-selector-room>

            <!-- Componente actividades opcionales -->
            <app-activities-optionals
              #activitiesOptionals
              [itineraryId]="itineraryId"
              [departureId]="departureId"
              [reservationId]="reservationId"
              (activitiesUpdated)="onActivitiesUpdated()"
            >
            </app-activities-optionals>

            <!-- Componente de seguro -->
            <app-insurance
              [tourId]="tourId"
              [departureId]="departureId"
              [itineraryId]="itineraryId"
              [reservationId]="reservationId"
              (insuranceSelectionChange)="onInsuranceSelectionChange($event)"
              #insuranceSelector
            >
            </app-insurance>

            <div class="flex pt-6 justify-end">
              <p-button
                class="next"
                label="Continuar"
                icon="pi pi-arrow-right"
                iconPos="right"
                [loading]="isStep0Saving"
                [disabled]="isStep0Saving"
                (onClick)="nextStepWithValidation(1)"
              ></p-button>
            </div>
          </div>

          <!-- Step 2: Vuelos -->
          <div *ngSwitchCase="1">
            <!-- Componente de gestión de vuelos -->
            <app-flight-management
              #flightManagement
              [departureId]="departureId ?? 0"
              [reservationId]="reservationId ?? 0"
              [tourId]="tourId ?? 0"
              [selectedFlight]="selectedFlight"
              [departureActivityPackId]="departureActivityPackId"
              [isStandaloneMode]="isStandaloneMode"
              (flightSelectionChange)="onFlightSelectionChange($event)"
            >
            </app-flight-management>

            <div class="flight-buttons">
              <p-button
                *ngIf="hasAvailableFlights"
                class="without-flight"
                [label]="
                  isFlightlessProcessing
                    ? flightlessProcessingMessage
                    : 'Lo quiero sin vuelos'
                "
                [icon]="isFlightlessProcessing ? 'pi pi-spinner pi-spin' : ''"
                [disabled]="isFlightlessProcessing"
                [loading]="isFlightlessProcessing"
                (onClick)="
                  checkAuthAndContinue(2, onActiveIndexChange.bind(this), true)
                "
              ></p-button>
              <p-button
                class="continue-button"
                label="Continuar"
                icon="pi pi-arrow-right"
                iconPos="right"
                [disabled]="!selectedFlight || isFlightlessProcessing"
                [pTooltip]="getContinueButtonTooltip()"
                tooltipPosition="top"
                (onClick)="
                  checkAuthAndContinue(2, onActiveIndexChange.bind(this), false)
                "
              ></p-button>
            </div>
          </div>

          <!-- Step 3: Viajeros -->
          <div *ngSwitchCase="2">
            <app-info-travelers
              [departureId]="departureId"
              [reservationId]="reservationId"
              [itineraryId]="itineraryId"
              (activitiesAssignmentChange)="
                onActivitiesAssignmentChange($event)
              "
              (dataUpdated)="onTravelerDataUpdated()"
              (roomAssignmentsChange)="onRoomAssignmentsChange($event)"
              #infoTravelers
            >
            </app-info-travelers>

            <div class="flight-buttons">
              <p-button
                label="Continuar"
                icon="pi pi-arrow-right"
                iconPos="right"
                (onClick)="
                  checkAuthAndContinue(3, onActiveIndexChange.bind(this), false)
                "
              ></p-button>
            </div>
          </div>

          <!-- Step 4: Pago -->
          <div *ngSwitchCase="3">
            <!-- Componente de pago -->
            <app-payment-management
              [totalPrice]="totalAmountCalculated"
              [reservationId]="reservationId ?? 0"
              [departureDate]="departureDate"
              [showTransfer25Option]="showTransfer25Option"
              [isTourOperator]="isTourOperator"
              (navigateToStep)="onNavigateToStep($event)"
              (paymentCompleted)="onPaymentCompleted($event)"
            >
            </app-payment-management>
          </div>
        </div>
      </div>
      <!-- Budget Options Section Footer -->
      <div class="tour-additional-info-container">
        <app-additional-info
          [existingOrder]="reservationData"
          [tourId]="tourId?.toString() || ''"
          [tourName]="tourName"
          [periodName]="tourName"
          [periodDates]="tourDates"
          [selectedFlight]="selectedFlight"
          [travelersSelected]="{
            adults: totalPassengers,
            childs: 0,
            babies: 0
          }"
          [periodID]="departureId?.toString() || ''"
          [isAuthenticated]="isAuthenticated"
          [context]="'checkout'"
          [tourCountry]="tourCountry"
          [tourContinent]="tourContinent"
          [tourRating]="tourRating"
          [tourDuration]="tourDuration"
          [tourTripType]="tourTripType"
          [tourProductStyle]="tourProductStyle"
          [tourListId]="tourId?.toString() || ''"
          [tourListName]="tourName || ''"
        ></app-additional-info>
      </div>
    </div>

    <!-- Columna derecha - Resumen -->
    <div class="right-column">
      <!-- Resumen del pedido usando SummaryTableComponent -->
      <app-summary-table
        [reservationId]="reservationId || undefined"
        [refreshTrigger]="summaryRefreshTrigger"
        [isAuthenticated]="false"
        [selectedFlight]="selectedFlight"
        [showPointsSection]="false"
        [showTotalSection]="true"
        [showFlightSection]="true"
        [currency]="'EUR'"
        [title]="'Resumen del pedido'"
        (totalChanged)="onTotalChanged($event)"
      >
      </app-summary-table>
    </div>
  </div>

  <!-- Indicadores de carga y error -->
  <div *ngIf="loading" class="loading-indicator">
    <p>Cargando información de la reserva...</p>
  </div>

  <div *ngIf="error" class="error-message">
    <p>{{ error }}</p>
  </div>

  <!-- Modal de login -->
  <app-login-modal
    [visible]="loginDialogVisible"
    (close)="closeLoginModal()"
    (login)="navigateToLogin()"
    (register)="navigateToRegister()"
  >
  </app-login-modal>
</div>
