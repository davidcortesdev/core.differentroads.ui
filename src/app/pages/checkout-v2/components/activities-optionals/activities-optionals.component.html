<div
  class="optional-activities"
  *ngIf="optionalActivities && optionalActivities.length > 0"
>
  <!-- Mensaje de error -->
  <div *ngIf="errorMessage" class="error-message">
    <i class="pi pi-exclamation-triangle"></i>
    <p>{{ errorMessage }}</p>
  </div>

  <div class="step">
    <div class="step-title">Agrega actividades</div>
    <div class="step-description">
      <i class="pi pi-info-circle"></i>También puedes añadirlas después desde tu
      perfil
    </div>
    <!-- Mensaje informativo sobre personalización por viajero -->
    <div
      class="step-info"
      *ngIf="hasSelectedActivities"
    >
      <i class="pi pi-info-circle"></i>
      <span>Las actividades seleccionadas se aplicarán a todos los viajeros. En el paso 3 podrás personalizar qué actividades desea cada viajero específicamente.</span>
    </div>
  </div>

  <p-dataview #dv [value]="optionalActivities">
    <ng-template #list let-items>
      <div class="dataview-grid">
        <div
          class="dataview-item"
          *ngFor="let item of items; let first = first"
        >
          <div
            class="dataview-card"
            [ngClass]="{ 
              'dataview-card-border': !first,
              'unavailable': item.availablePlaces !== undefined && item.availablePlaces === 0 && !isActivityAdded(item)
            }"
          >
            <div class="dataview-image">
              <img
                class="dataview-img"
                [src]="item.imageUrl || ''"
                [alt]="item.name"
                loading="lazy"
              />
            </div>

            <div class="dataview-content">
              <div class="dataview-info">
                <div>
                  <div
                    class="dataview-name"
                    [class.clickable]="shouldShowReadMore(item)"
                    (click)="shouldShowReadMore(item) && openDescriptionModal(item)"
                  >
                    {{ item.name }}
                  </div>
                  <div class="dataview-description-container">
                    <div
                      class="dataview-description"
                      [class.clickable]="shouldShowReadMore(item)"
                      [innerHTML]="item.description"
                      (click)="shouldShowReadMore(item) && openDescriptionModal(item)"
                    ></div>
                  </div>
                </div>
              </div>

              <div class="dataview-actions">
                <div class="dataview-price" *ngIf="getBasePrice(item) !== null">
                  <span class="dataview-price-value">
                    +{{ getBasePrice(item)! | currencyFormat : "EUR" }}
                  </span>
                  <span class="dataview-per-person"> por persona </span>
                </div>

                <!-- Información de disponibilidad -->
                <div class="activity-availability-info" *ngIf="item.availablePlaces !== undefined && item.availablePlaces <= 4">
                  <span *ngIf="item.availablePlaces > 0" class="availability-available">
                    <i class="pi pi-check-circle"></i>
                    {{ item.availablePlaces }} {{ item.availablePlaces === 1 ? ' disponible' : ' disponibles' }}
                  </span>
                  <span *ngIf="item.availablePlaces === 0" class="availability-unavailable">
                    <i class="pi pi-times-circle"></i>
                    Sin disponibilidad
                  </span>
                </div>

                <div class="dataview-buttons">
                  <p-button
                    class="dataview-buy-button"
                    [label]="isActivityAdded(item) ? 'Eliminar' : 'Añadir'"
                    [rounded]="true"
                    [loading]="isActivityLoading(item)"
                    [disabled]="isActivityLoading(item) || (item.availablePlaces !== undefined && item.availablePlaces === 0 && !isActivityAdded(item))"
                    [styleClass]="isActivityAdded(item) ? 'added-button' : ''"
                    (click)="toggleActivity(item)"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </ng-template>
  </p-dataview>

  <!-- Modal de descripción completa -->
  <app-activity-description-modal
    [visible]="descriptionModalVisible"
    [activity]="getActivityForModal()"
    (close)="closeDescriptionModal()"
  ></app-activity-description-modal>
</div>
