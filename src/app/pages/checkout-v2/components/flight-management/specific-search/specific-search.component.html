<p-panel>
  <ng-template #header>
    <div class="flt-hdr">
      <h2>Gestión de vuelos - Mejor precio, reserva simple</h2>
      <p>
        {{ tourName }}
        <span *ngIf="flightForm.get('adults')?.value > 0">
          | {{ flightForm.get("adults")?.value }} adulto{{
            flightForm.get("adults")?.value > 1 ? "s" : ""
          }}
        </span>
        <span *ngIf="flightForm.get('children')?.value > 0">
          , {{ flightForm.get("children")?.value }} niño{{
            flightForm.get("children")?.value > 1 ? "s" : ""
          }}
        </span>
        <span *ngIf="flightForm.get('infants')?.value > 0">
          , {{ flightForm.get("infants")?.value }} bebé{{
            flightForm.get("infants")?.value > 1 ? "s" : ""
          }}
        </span>
      </p>
    </div>
  </ng-template>

  <form [formGroup]="flightForm" class="flight-form-container">
    <div class="travel-type">
      <div class="radio">
        <p-radioButton
          formControlName="tipoViaje"
          name="tipoViaje"
          value="IdaVuelta"
          inputId="IdaVuelta"
        ></p-radioButton>
        <label for="IdaVuelta">Ida y vuelta</label>
      </div>
      <div class="radio">
        <p-radioButton
          formControlName="tipoViaje"
          name="tipoViaje"
          value="Ida"
          inputId="Ida"
        ></p-radioButton>
        <label for="Ida">Solo ida</label>
      </div>
      <div class="radio">
        <p-radioButton
          formControlName="tipoViaje"
          name="tipoViaje"
          value="Vuelta"
          inputId="Vuelta"
        ></p-radioButton>
        <label for="Vuelta">Solo vuelta</label>
      </div>
    </div>

    <!-- Ida -->
    <div class="flight-row" *ngIf="tipoViaje !== 'Vuelta'">
      <div class="row-label">
        <label>Ida</label>
        <span class="from-label">Desde</span>
      </div>
      
      <div class="field-group origin-field">
        <label>
          Origen
          <i class="pi pi-info-circle info-icon" 
             pTooltip="Selecciona el aeropuerto desde donde quieres iniciar tu viaje. Este será el punto de partida de tu vuelo de ida."
             tooltipPosition="top"
             [showDelay]="300"></i>
        </label>
        <i class="pi pi-plane plane-icon"></i>
        <p-autocomplete
          formControlName="origen"
          [suggestions]="filteredCities"
          (completeMethod)="searchCities($event)"
          field="nombre"
          [forceSelection]="true"
          [styleClass]="flightForm.get('origen')?.invalid && flightForm.get('origen')?.touched ? 'p-invalid' : ''"
          [dropdown]="true"
          [minLength]="1"
          [delay]="0"
          [appendTo]="'body'"
          [showEmptyMessage]="true"
          emptyMessage="No se encontraron ciudades"
        >
          <ng-template #item let-city>
            <div class="city-item">{{ city.codigo }} - {{ city.nombre }}</div>
          </ng-template>
          <ng-template #selectedItem let-city>
            <div class="selected-city">{{ city.codigo }} - {{ city.nombre }}</div>
          </ng-template>
        </p-autocomplete>
        <div class="field-hint">
          <span>Selecciona uno de nuestros aeropuertos seleccionados</span>
        </div>
        <small class="p-error" *ngIf="flightForm.get('origen')?.invalid && flightForm.get('origen')?.touched">
          Por favor, rellena este campo
        </small>
      </div>
      
      <div class="field-group">
        <label>
          Llegada
          <i class="pi pi-info-circle info-icon" 
             pTooltip="Este es el aeropuerto de destino del tour, donde aterrizará tu vuelo de ida. Este valor está predeterminado según tu destino turístico."
             tooltipPosition="top"
             [showDelay]="300"></i>
        </label>
        <div class="static-field" 
             [pTooltip]="tourOrigenConstante.codigo && tourOrigenConstante.nombre ? (tourOrigenConstante.codigo + ' - ' + tourOrigenConstante.nombre) : ''"
             tooltipPosition="top"
             [showDelay]="300">
          {{ tourOrigenConstante.codigo }} - {{ tourOrigenConstante.nombre }}
        </div>
      </div>
      
      <div class="field-group date-field-group">
        <label>
          Fecha y hora de llegada
          <i class="pi pi-info-circle info-icon" 
             pTooltip="Hora local del aeropuerto de llegada"
             tooltipPosition="top"
             [showDelay]="300"></i>
        </label>
        <p-datepicker
          formControlName="fechaHoraIda"
          [showTime]="true"
          [hourFormat]="'24'"
          [maxDate]="maxFechaIda"
          [showIcon]="true"
          appendTo="body"
          dateFormat="dd/mm/yy"
          [showButtonBar]="true"
          placeholder="Seleccionar fecha y hora"
          [styleClass]="flightForm.get('fechaHoraIda')?.invalid && flightForm.get('fechaHoraIda')?.touched ? 'p-invalid' : ''"
        >
        </p-datepicker>
        <small class="p-error" *ngIf="flightForm.get('fechaHoraIda')?.invalid && flightForm.get('fechaHoraIda')?.touched">
          <span *ngIf="flightForm.get('fechaHoraIda')?.errors?.['required']">Por favor, rellena este campo</span>
          <span *ngIf="flightForm.get('fechaHoraIda')?.errors?.['fechaHoraIdaExceedsMax']">La fecha/hora seleccionada excede el límite máximo permitido</span>
        </small>
      </div>
    </div>

    <!-- Solo vuelta: origen fijo (aeropuerto de salida del tour), destino editable -->
    <div class="flight-row" *ngIf="tipoViaje === 'Vuelta'">
      <div class="row-label">
        <label>Vuelta</label>
        <span class="from-label">Desde</span>
      </div>
      
      <div class="field-group">
        <label>
          Origen
          <i class="pi pi-info-circle info-icon" 
             pTooltip="Este es el aeropuerto de salida del tour, desde donde partirá tu vuelo de vuelta. Este valor está predeterminado según tu destino turístico."
             tooltipPosition="top"
             [showDelay]="300"></i>
        </label>
        <div class="static-field"
             [pTooltip]="tourDestinoConstante.codigo && tourDestinoConstante.nombre ? (tourDestinoConstante.codigo + ' - ' + tourDestinoConstante.nombre) : ''"
             tooltipPosition="top"
             [showDelay]="300">
          {{ tourDestinoConstante.codigo }} - {{ tourDestinoConstante.nombre }}
        </div>
      </div>
      
      <div class="field-group origin-field">
        <label>
          Llegada
          <i class="pi pi-info-circle info-icon" 
             pTooltip="Selecciona el aeropuerto al que quieres llegar en tu vuelo de vuelta. Este será tu destino final."
             tooltipPosition="top"
             [showDelay]="300"></i>
        </label>
        <i class="pi pi-plane plane-icon"></i>
        <p-autocomplete
          formControlName="origen"
          [suggestions]="filteredCities"
          (completeMethod)="searchCities($event)"
          field="nombre"
          [forceSelection]="true"
          [styleClass]="flightForm.get('origen')?.invalid && flightForm.get('origen')?.touched ? 'p-invalid' : ''"
          [dropdown]="true"
          [minLength]="1"
          [delay]="0"
          [appendTo]="'body'"
          [showEmptyMessage]="true"
          emptyMessage="No se encontraron ciudades"
        >
          <ng-template #item let-city>
            <div class="city-item">{{ city.codigo }} - {{ city.nombre }}</div>
          </ng-template>
          <ng-template #selectedItem let-city>
            <div class="selected-city">{{ city.codigo }} - {{ city.nombre }}</div>
          </ng-template>
        </p-autocomplete>
        <div class="field-hint">
          <span>Selecciona uno de nuestros aeropuertos seleccionados</span>
        </div>
        <small class="p-error" *ngIf="flightForm.get('origen')?.invalid && flightForm.get('origen')?.touched">
          Por favor, rellena este campo
        </small>
      </div>
      
      <div class="field-group date-field-group">
        <label>
          Fecha y hora de salida
          <i class="pi pi-info-circle info-icon" 
             pTooltip="Hora local del aeropuerto de salida"
             tooltipPosition="top"
             [showDelay]="300"></i>
        </label>
        <p-datepicker
          formControlName="fechaHoraVuelta"
          [showTime]="true"
          [hourFormat]="'24'"
          [minDate]="minFechaVuelta"
          [monthNavigator]="true"
          [yearNavigator]="true"
          [yearRange]="yearRangeVuelta"
          [showIcon]="true"
          appendTo="body"
          dateFormat="dd/mm/yy"
          [showButtonBar]="true"
          placeholder="Seleccionar fecha y hora"
          [ngClass]="{ 'p-invalid': flightForm.get('fechaHoraVuelta')?.invalid && flightForm.get('fechaHoraVuelta')?.touched }"
        >
        </p-datepicker>
        <small class="p-error" *ngIf="flightForm.get('fechaHoraVuelta')?.invalid && flightForm.get('fechaHoraVuelta')?.touched">
          <span *ngIf="flightForm.get('fechaHoraVuelta')?.errors?.['required']">Por favor, rellena este campo</span>
          <span *ngIf="flightForm.get('fechaHoraVuelta')?.errors?.['fechaHoraVueltaBeforeMin']">La fecha/hora seleccionada es anterior al límite mínimo permitido</span>
        </small>
      </div>
    </div>

    <!-- Regreso -->
    <div class="flight-row" *ngIf="tipoViaje === 'IdaVuelta'">
      <div class="row-label">
        <label>Regreso</label>
        <span class="from-label">Desde</span>
      </div>
      
      <div class="field-group">
        <label>
          Origen
          <i class="pi pi-info-circle info-icon" 
             pTooltip="Este es el aeropuerto de salida del tour, desde donde partirá tu vuelo de regreso. Este valor está predeterminado según tu destino turístico."
             tooltipPosition="top"
             [showDelay]="300"></i>
        </label>
        <div class="static-field"
             [pTooltip]="tourDestinoConstante.codigo && tourDestinoConstante.nombre ? (tourDestinoConstante.codigo + ' - ' + tourDestinoConstante.nombre) : ''"
             tooltipPosition="top"
             [showDelay]="300">
          {{ tourDestinoConstante.codigo }} - {{ tourDestinoConstante.nombre }}
        </div>
      </div>
      
      <div class="field-group origin-field">
        <label>
          Llegada
          <i class="pi pi-info-circle info-icon" 
             pTooltip="Selecciona el aeropuerto al que quieres llegar en tu vuelo de regreso. Puede ser el mismo aeropuerto desde donde partiste o uno diferente."
             tooltipPosition="top"
             [showDelay]="300"></i>
        </label>
        <i class="pi pi-plane plane-icon"></i>
        <p-autocomplete
          formControlName="destinoVuelta"
          [suggestions]="filteredCities"
          (completeMethod)="searchCities($event)"
          field="nombre"
          [forceSelection]="true"
          [styleClass]="flightForm.get('destinoVuelta')?.invalid && flightForm.get('destinoVuelta')?.touched ? 'p-invalid' : ''"
          [dropdown]="true"
          [minLength]="1"
          [delay]="0"
          [appendTo]="'body'"
          [showEmptyMessage]="true"
          emptyMessage="No se encontraron ciudades"
        >
          <ng-template #item let-city>
            <div class="city-item">{{ city.codigo }} - {{ city.nombre }}</div>
          </ng-template>
          <ng-template #selectedItem let-city>
            <div class="selected-city">{{ city.codigo }} - {{ city.nombre }}</div>
          </ng-template>
        </p-autocomplete>
        <div class="field-hint">
          <span>Selecciona uno de nuestros aeropuertos seleccionados</span>
        </div>
      </div>
      
      <div class="field-group date-field-group">
        <label>
          Fecha y hora de salida
          <i class="pi pi-info-circle info-icon" 
             pTooltip="Hora local del aeropuerto de salida"
             tooltipPosition="top"
             [showDelay]="300"></i>
        </label>
        <p-datepicker
          formControlName="fechaHoraVuelta"
          [showTime]="true"
          [hourFormat]="'24'"
          [minDate]="minFechaVuelta"
          [monthNavigator]="true"
          [yearNavigator]="true"
          [yearRange]="yearRangeVuelta"
          [showIcon]="true"
          appendTo="body"
          dateFormat="dd/mm/yy"
          [showButtonBar]="true"
          placeholder="Seleccionar fecha y hora"
          [ngClass]="{ 'p-invalid': flightForm.get('fechaHoraVuelta')?.invalid && flightForm.get('fechaHoraVuelta')?.touched }"
        >
        </p-datepicker>
        <small class="p-error" *ngIf="flightForm.get('fechaHoraVuelta')?.invalid && flightForm.get('fechaHoraVuelta')?.touched">
          <span *ngIf="flightForm.get('fechaHoraVuelta')?.errors?.['required']">Por favor, rellena este campo</span>
          <span *ngIf="flightForm.get('fechaHoraVuelta')?.errors?.['fechaHoraVueltaBeforeMin']">La fecha/hora seleccionada es anterior al límite mínimo permitido</span>
        </small>
      </div>
    </div>

    <div class="search-button-container">
      <p-button 
        label="Buscar" 
        styleClass="p-button-danger" 
        (click)="buscar()"
        [disabled]="isLoading"
      ></p-button>
    </div>
  </form>
</p-panel>

<!-- Mensaje de error de búsqueda de vuelos -->
<div *ngIf="errorMessage" class="error-message-panel">
  <p-panel styleClass="error-panel">
    <div class="msg">
      <i class="pi pi-exclamation-triangle"></i>
      <h3>{{ errorMessage }}</h3>
    </div>
  </p-panel>
</div>

<!-- Warnings de búsqueda -->
<div *ngIf="hasSearchWarnings && searchWarnings.length > 0" class="warning-message-panel">
  <p-panel styleClass="warning-panel">
    <div class="msg">
      <i class="pi pi-exclamation-triangle"></i>
      <h3>
        Advertencias en la búsqueda
        <i class="pi pi-info-circle amadeus-info-icon" 
           pTooltip="Estas advertencias son proporcionadas por el servicio de búsqueda de vuelos de Amadeus"
           tooltipPosition="top"
           [showDelay]="300"></i>
      </h3>
      <div class="warnings-container">
        <div *ngFor="let warning of searchWarnings" class="warning-item">
          <div class="warning-header">
            <span class="warning-title">{{ warning.title }}</span>
            <span class="warning-status">({{ warning.status }})</span>
          </div>
          <div class="warning-detail">{{ warning.detail }}</div>
          <div *ngIf="warning.code !== 0" class="warning-code">Código: {{ warning.code }}</div>
        </div>
      </div>
    </div>
  </p-panel>
</div>

<!-- Meta información de búsqueda -->
<div *ngIf="searchMeta" class="meta-info-panel">
  <p-panel styleClass="info-panel">
    <div class="msg">
      <i class="pi pi-info-circle"></i>
      <h3>Información de la búsqueda</h3>
      <div class="meta-container">
        <div class="meta-item">
          <span class="meta-label">Total de resultados:</span>
          <span class="meta-value">{{ searchMeta.count }}</span>
        </div>
        <div *ngIf="searchMeta.oneWayCombinations" class="meta-item">
          <span class="meta-label">Combinaciones de ida:</span>
          <span class="meta-value">{{ searchMeta.oneWayCombinations }}</span>
        </div>
      </div>
    </div>
  </p-panel>
</div>

<!-- Estado de carga -->
<div class="loading" *ngIf="isLoading">
  <p-progressSpinner></p-progressSpinner>
  <div class="msg">Buscando los mejores vuelos para ti...</div>
</div>

<!-- Estado inicial - sin búsqueda -->
<div class="no-search" *ngIf="!isLoading && !searchPerformed">
  <p-panel>
    <div class="msg" style="text-align: center">
      <h3><i class="pi pi-search"></i> Busca tu vuelo</h3>
      <p>
        Selecciona tu ciudad de origen y haz clic en "Buscar" para encontrar
        vuelos disponibles.
      </p>
    </div>
  </p-panel>
</div>

<!-- Sección de resultados de búsqueda usando app-flight-item -->
<div *ngIf="!isLoading && searchPerformed && flightOffersRaw && flightOffersRaw.length > 0" class="flight-results">
  <h3>Resultados de búsqueda de vuelos:</h3>
  
  <!-- Filtros de ordenación -->
  <div class="sort-controls" *ngIf="flightOffersRaw.length > 1">
    <label for="sortSelect">Ordenar por:</label>
    <p-dropdown
      id="sortSelect"
      [options]="sortOptions"
      [(ngModel)]="selectedSortOption"
      (onChange)="onSortChange($event)"
      optionLabel="label"
      optionValue="value"
      placeholder="Seleccionar orden"
    ></p-dropdown>
    
    <!-- Indicador de carga de detalles -->
    <div *ngIf="isLoadingDetails" class="loading-details">
      <i class="pi pi-spin pi-spinner"></i>
      <span>Cargando detalles de escalas...</span>
    </div>
  </div>

  <!-- Lista de vuelos usando app-flight-item -->
  <!-- 
    Nota: Se pasa autoSearch="false" para evitar que cada flight-item haga 
    búsquedas automáticas al cargar, lo que causaría múltiples llamadas al API.
    
    Los detalles de vuelos (escalas, duración, aerolíneas) se cargan automáticamente
    dentro de cada flight-item cuando useNewService="true", usando el endpoint 
    /api/FlightSearch/{packId}/details/{flightId}.
    
    Esto evita el bucle de peticiones y mejora el rendimiento.
    
    Se pasa useNewService="true" para que flight-item y flight-stops usen el nuevo
    FlightSearchService en lugar del FlightsNetService.
    
    Los detalles se mapean internamente al formato esperado por FlightsNetService
    para mantener compatibilidad con el resto de la aplicación.
  -->
  
  <!-- Indicador de carga de nombres de ciudades -->
  <div *ngIf="hasPendingCities() && flightOffersRaw.length > 0" class="loading-cities">
    <p-progressSpinner size="small"></p-progressSpinner>
    <div class="msg">Cargando nombres de ciudades y aeropuertos...</div>
  </div>
  
  <div class="flight-list" *ngIf="!hasPendingCities()">
    <app-flight-item
      *ngFor="let flightPack of adaptedFlightPacks; trackBy: trackByFlightId"
      [flightPack]="flightPack"
      [selectedFlight]="selectedFlight ? adaptFlightPackForFlightItem(selectedFlight) : null"
      [useNewService]="true"
      (flightSelected)="selectFlight($event)"
    ></app-flight-item>
  </div>
</div>

<!-- Mensaje cuando no hay resultados después de una búsqueda -->
<div *ngIf="!isLoading && searchPerformed && (!flightOffersRaw || flightOffersRaw.length === 0)" class="no-results">
  <p-panel>
    <div class="msg">
      <i class="pi pi-info-circle"></i>
      <h3>No se encontraron vuelos</h3>
      <p>{{ getNoResultsMessage() }}</p>
    </div>
  </p-panel>
</div>

