<p-panel>
  <ng-template #header>
    <div class="flt-hdr">
      <h2>Mejor precio, reserva simple</h2>
      <p>
        {{ tourName }}
        <span *ngIf="flightForm.get('adults')?.value > 0">
          | {{ flightForm.get("adults")?.value }} adulto{{
            flightForm.get("adults")?.value > 1 ? "s" : ""
          }}
        </span>
        <span *ngIf="flightForm.get('children')?.value > 0">
          , {{ flightForm.get("children")?.value }} niño{{
            flightForm.get("children")?.value > 1 ? "s" : ""
          }}
        </span>
        <span *ngIf="flightForm.get('infants')?.value > 0">
          , {{ flightForm.get("infants")?.value }} bebé{{
            flightForm.get("infants")?.value > 1 ? "s" : ""
          }}
        </span>
      </p>
    </div>
  </ng-template>

  <form [formGroup]="flightForm">
    <div class="travel-type">
      <div class="radio">
        <p-radioButton
          formControlName="tipoViaje"
          name="tipoViaje"
          value="IdaVuelta"
          inputId="IdaVuelta"
        ></p-radioButton>
        <label for="IdaVuelta">Ida y vuelta</label>
      </div>
      <div class="radio">
        <p-radioButton
          formControlName="tipoViaje"
          name="tipoViaje"
          value="Ida"
          inputId="Ida"
        ></p-radioButton>
        <label for="Ida">Solo ida</label>
      </div>
      <div class="radio">
        <p-radioButton
          formControlName="tipoViaje"
          name="tipoViaje"
          value="Vuelta"
          inputId="Vuelta"
        ></p-radioButton>
        <label for="Vuelta">Solo vuelta</label>
      </div>
      <!-- Baggage filters removed -->
    </div>

    <div class="flt-details">
      <!-- Ida -->
      <div class="row" *ngIf="tipoViaje !== 'Vuelta'">
        <div class="label">
          <label>Ida</label>
          <div class="from">Desde</div>
        </div>
        <div class="input origin">
          <i class="pi pi-plane"></i>
          <!-- Componente de autocomplete mejorado para mostrar todas las ciudades -->
          <p-autocomplete
            formControlName="origen"
            [suggestions]="filteredCities"
            (completeMethod)="searchCities($event)"
            field="nombre"
            [forceSelection]="true"
            styleClass="w-full"
            [dropdown]="true"
            [minLength]="1"
            [delay]="0"
            [appendTo]="'body'"
            [showEmptyMessage]="true"
            emptyMessage="No se encontraron ciudades"
          >
            <!-- Plantilla personalizada para los elementos del dropdown -->
            <ng-template pTemplate="item" let-city>
              <div class="city-item">
                {{ city.codigo }} - {{ city.nombre }}
              </div>
            </ng-template>
            <!-- Plantilla personalizada para el input cuando está seleccionado -->
            <ng-template pTemplate="selectedItem" let-city>
              <div class="selected-city">
                {{ city.codigo }} - {{ city.nombre }}
              </div>
            </ng-template>
          </p-autocomplete>
          <a href="#" class="change"></a>
        </div>
        <div class="input destination">
          <div class="dest-lbl">Llegada</div>
          <div class="static-field">
            {{ tourOrigenConstante.codigo }} - {{ tourOrigenConstante.nombre }}
          </div>
        </div>
        <div class="date">
          <div class="date-lbl">Fecha</div>
          <div class="static-field">
            {{ fechaIdaConstante }}<span *ngIf="horaIdaConstante"> {{ horaIdaConstante }} <i class="pi pi-info-circle" title="Hora local"></i></span>
          </div>
        </div>
      </div>

      <!-- Solo vuelta: origen editable, destino fijo -->
      <div class="row" *ngIf="tipoViaje === 'Vuelta'">
        <div class="label">
          <label>Vuelta</label>
          <div class="from">a</div>
        </div>
        <div class="input origin">
          <i class="pi pi-plane"></i>
          <p-autocomplete
            formControlName="origen"
            [suggestions]="filteredCities"
            (completeMethod)="searchCities($event)"
            field="nombre"
            [forceSelection]="true"
            styleClass="w-full"
            [dropdown]="true"
            [minLength]="1"
            [delay]="0"
            [appendTo]="'body'"
            [showEmptyMessage]="true"
            emptyMessage="No se encontraron ciudades"
          >
            <ng-template pTemplate="item" let-city>
              <div class="city-item">
                {{ city.codigo }} - {{ city.nombre }}
              </div>
            </ng-template>
            <ng-template pTemplate="selectedItem" let-city>
              <div class="selected-city">
                {{ city.codigo }} - {{ city.nombre }}
              </div>
            </ng-template>
          </p-autocomplete>
        </div>
        <div class="input destination">
          <div class="dest-lbl">Desde</div>
          <div class="static-field">
            {{ tourDestinoConstante.codigo }} - {{ tourDestinoConstante.nombre }}
          </div>
        </div>
        <div class="date">
          <div class="date-lbl">Fecha</div>
          <div class="static-field">
            {{ fechaRegresoConstante }}<span *ngIf="horaRegresoConstante"> {{ horaRegresoConstante }} <i class="pi pi-info-circle" title="Hora local"></i></span>
          </div>
        </div>
      </div>

      <!-- Regreso -->
      <div class="row" *ngIf="tipoViaje === 'IdaVuelta'">
        <div class="label">
          <label>Regreso</label>
          <div class="from">Desde</div>
        </div>
        <div class="input origin">
          <i class="pi pi-plane"></i>
          <div class="static-field">{{ tourDestinoConstante.codigo }} - {{ tourDestinoConstante.nombre }}</div>
        </div>
        <div class="input destination">
          <div class="dest-lbl">Llegada</div>
          <div class="static-field">
            {{ flightForm.get("origen")?.value?.codigo || flightForm.get("origen")?.value }} - {{ flightForm.get("origen")?.value?.nombre || flightForm.get("origen")?.value }}
          </div>
        </div>
        <div class="date">
          <div class="date-lbl">Fecha</div>
          <div class="static-field">
            {{ fechaRegresoConstante }}<span *ngIf="horaRegresoConstante"> {{ horaRegresoConstante }} <i class="pi pi-info-circle" title="Hora local"></i></span>
          </div>
        </div>
      </div>
    </div>

    <div class="search-opts">
      <div class="sort">
        <p-dropdown
          [options]="sortOptions"
          [(ngModel)]="selectedSortOption"
          [ngModelOptions]="{ standalone: true }"
          placeholder="Ordenar por"
          (onChange)="onSortChange($event)"
          styleClass="p-button-outlined mobile-friendly-dropdown"
          [showClear]="false"
          appendTo="body"
        ></p-dropdown>
      </div>
      <div class="filter">
        <!--   <p-dropdown
          [options]="escalaOptions"
          formControlName="escala"
          placeholder="Escala"
          styleClass="p-button-outlined"
        ></p-dropdown>
        <p-dropdown
          [options]="aerolineaOptions"
          formControlName="aerolinea"
          placeholder="Aerolínea"
          styleClass="p-button-outlined"
        ></p-dropdown> -->
      </div>
      <div class="btn-search">
        <p-button 
          label="Buscar" 
          styleClass="mobile-friendly-button" 
          (click)="buscar()"
          [disabled]="isLoading"
        ></p-button>
      </div>
    </div>
  </form>
</p-panel>

<!-- Mensaje de error de búsqueda de vuelos -->
<div *ngIf="errorMessage" class="error-message-panel">
  <p-panel styleClass="error-panel">
    <div class="msg">
      <i class="pi pi-exclamation-triangle"></i>
      <h3>{{ errorMessage }}</h3>
    </div>
  </p-panel>
</div>

<!-- Warnings de búsqueda -->
<div *ngIf="hasSearchWarnings && searchWarnings.length > 0" class="warning-message-panel">
  <p-panel styleClass="warning-panel">
    <div class="msg">
      <i class="pi pi-exclamation-triangle"></i>
      <h3>
        Advertencias en la búsqueda
        <i class="pi pi-info-circle amadeus-info-icon" 
           pTooltip="Estas advertencias son proporcionadas por el servicio de búsqueda de vuelos de Amadeus"
           tooltipPosition="top"
           [showDelay]="300"></i>
      </h3>
      <div class="warnings-container">
        <div *ngFor="let warning of searchWarnings" class="warning-item">
          <div class="warning-header">
            <span class="warning-title">{{ warning.title }}</span>
            <span class="warning-status">({{ warning.status }})</span>
          </div>
          <div class="warning-detail">{{ warning.detail }}</div>
          <div *ngIf="warning.code !== 0" class="warning-code">Código: {{ warning.code }}</div>
        </div>
      </div>
    </div>
  </p-panel>
</div>

<!-- Meta información de búsqueda -->
<div *ngIf="searchMeta" class="meta-info-panel">
  <p-panel styleClass="info-panel">
    <div class="msg">
      <i class="pi pi-info-circle"></i>
      <h3>Información de la búsqueda</h3>
      <div class="meta-container">
        <div class="meta-item">
          <span class="meta-label">Total de resultados:</span>
          <span class="meta-value">{{ searchMeta.count }}</span>
        </div>
        <div *ngIf="searchMeta.oneWayCombinations" class="meta-item">
          <span class="meta-label">Combinaciones de ida:</span>
          <span class="meta-value">{{ searchMeta.oneWayCombinations }}</span>
        </div>
      </div>
    </div>
  </p-panel>
</div>

<!-- Estado de carga -->
<div class="loading" *ngIf="isLoading">
  <p-progressSpinner></p-progressSpinner>
  <div class="msg">Buscando los mejores vuelos para ti...</div>
</div>

<!-- Estado inicial - sin búsqueda -->
<div class="no-search" *ngIf="!isLoading && !searchPerformed">
  <p-panel>
    <div class="msg" style="text-align: center">
      <h3><i class="pi pi-search"></i> Busca tu vuelo</h3>
      <p>
        Selecciona tu ciudad de origen y haz clic en "Buscar" para encontrar
        vuelos disponibles.
      </p>
    </div>
  </p-panel>
</div>

<!-- Sección de resultados de búsqueda usando app-flight-item -->
<div *ngIf="!isLoading && searchPerformed && flightOffersRaw && flightOffersRaw.length > 0" class="flight-results">
  <h3>Resultados de búsqueda de vuelos:</h3>
  
  <!-- Filtros de ordenación -->
  <div class="sort-controls" *ngIf="flightOffersRaw.length > 1">
    <label for="sortSelect">Ordenar por:</label>
    <p-dropdown
      id="sortSelect"
      [options]="sortOptions"
      [(ngModel)]="selectedSortOption"
      (onChange)="onSortChange($event)"
      optionLabel="label"
      optionValue="value"
      placeholder="Seleccionar orden"
    ></p-dropdown>
    
    <!-- Indicador de carga de detalles -->
    <div *ngIf="isLoadingDetails" class="loading-details">
      <i class="pi pi-spin pi-spinner"></i>
      <span>Cargando detalles de escalas...</span>
    </div>
  </div>

  <!-- Lista de vuelos usando app-flight-item -->
  <!-- 
    Nota: Se pasa autoSearch="false" para evitar que cada flight-item haga 
    búsquedas automáticas al cargar, lo que causaría múltiples llamadas al API.
    
    Los detalles de vuelos (escalas, duración, aerolíneas) se cargan automáticamente
    dentro de cada flight-item cuando useNewService="true", usando el endpoint 
    /api/FlightSearch/{packId}/details/{flightId}.
    
    Esto evita el bucle de peticiones y mejora el rendimiento.
    
    Se pasa useNewService="true" para que flight-item y flight-stops usen el nuevo
    FlightSearchService en lugar del FlightsNetService.
    
    Los detalles se mapean internamente al formato esperado por FlightsNetService
    para mantener compatibilidad con el resto de la aplicación.
  -->
  
  <!-- Indicador de carga de nombres de ciudades -->
  <div *ngIf="hasPendingCities() && flightOffersRaw.length > 0" class="loading-cities">
    <p-progressSpinner size="small"></p-progressSpinner>
    <div class="msg">Cargando nombres de ciudades y aeropuertos...</div>
  </div>
  
  <div class="flight-list" *ngIf="!hasPendingCities()">
    <app-flight-item
      *ngFor="let flightPack of adaptedFlightPacks; trackBy: trackByFlightId"
      [flightPack]="flightPack"
      [selectedFlight]="selectedFlight ? adaptFlightPackForFlightItem(selectedFlight) : null"
      [useNewService]="true"
      (flightSelected)="selectFlight($event)"
    ></app-flight-item>
  </div>
</div>

<!-- Mensaje cuando no hay resultados después de una búsqueda -->
<div *ngIf="!isLoading && searchPerformed && (!flightOffersRaw || flightOffersRaw.length === 0)" class="no-results">
  <p-panel>
    <div class="msg">
      <i class="pi pi-info-circle"></i>
      <h3>No se encontraron vuelos</h3>
      <p>{{ getNoResultsMessage() }}</p>
    </div>
  </p-panel>
</div>

<!-- Mensaje de error -->
<div *ngIf="errorMessage" class="error-message">
  <p>{{ errorMessage }}</p>
</div>
