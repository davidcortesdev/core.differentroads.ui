<div class="cont">
  <!-- Toast para mensajes informativos -->
  <p-toast position="top-right"></p-toast>
  
  <h3 class="title">Agrega los datos del viajero</h3>
  
  <!-- Información de requisitos de reserva de Amadeus -->
  <div *ngIf="amadeusBookingRequirements && hasFlightSelected" class="amadeus-requirements-info">
    <p-panel styleClass="info-panel">
      <div class="msg">
        <i class="pi pi-info-circle"></i>
        <h4>Requisitos de reserva de Amadeus</h4>
        <p class="requirements-description">
          Los siguientes campos son obligatorios para completar tu reserva de vuelo:
        </p>
        <div class="requirements-list">
          <div *ngIf="amadeusBookingRequirements.invoiceAddressRequired" class="requirement-item">
            <i class="pi pi-check-circle"></i>
            <span>Dirección de facturación requerida</span>
          </div>
          <div *ngIf="amadeusBookingRequirements.mailingAddressRequired" class="requirement-item">
            <i class="pi pi-check-circle"></i>
            <span>Dirección de correo requerida</span>
          </div>
          <div *ngIf="amadeusBookingRequirements.emailAddressRequired" class="requirement-item">
            <i class="pi pi-check-circle"></i>
            <span>Correo electrónico requerido</span>
          </div>
          <div *ngIf="amadeusBookingRequirements.phoneCountryCodeRequired" class="requirement-item">
            <i class="pi pi-check-circle"></i>
            <span>Código de país de teléfono requerido</span>
          </div>
          <div *ngIf="amadeusBookingRequirements.mobilePhoneNumberRequired" class="requirement-item">
            <i class="pi pi-check-circle"></i>
            <span>Número de teléfono móvil requerido</span>
          </div>
          <div *ngIf="amadeusBookingRequirements.phoneNumberRequired" class="requirement-item">
            <i class="pi pi-check-circle"></i>
            <span>Número de teléfono requerido</span>
          </div>
          <div *ngIf="amadeusBookingRequirements.postalCodeRequired" class="requirement-item">
            <i class="pi pi-check-circle"></i>
            <span>Código postal requerido</span>
          </div>
        </div>
        <div *ngIf="amadeusBookingRequirements.travelerRequirements && amadeusBookingRequirements.travelerRequirements.length > 0" class="traveler-requirements">
          <h5>Requisitos específicos por viajero:</h5>
          <div *ngFor="let requirement of amadeusBookingRequirements.travelerRequirements" class="traveler-requirement">
            <strong>Viajero {{ requirement.travelerId }}:</strong>
            <ul>
              <li *ngIf="requirement.genderRequired">Género requerido</li>
              <li *ngIf="requirement.documentRequired">Documento de identidad requerido</li>
              <li *ngIf="requirement.documentIssuanceCityRequired">Ciudad de emisión del documento requerida</li>
              <li *ngIf="requirement.dateOfBirthRequired">Fecha de nacimiento requerida</li>
              <li *ngIf="requirement.redressRequiredIfAny">Número de redress requerido si existe</li>
              <li *ngIf="requirement.airFranceDiscountRequired">Descuento de Air France requerido</li>
              <li *ngIf="requirement.spanishResidentDiscountRequired">Descuento de residente español requerido</li>
              <li *ngIf="requirement.residenceRequired">País de residencia requerido</li>
            </ul>
          </div>
        </div>
        <div class="amadeus-mandatory-fields">
          <h5>Campos obligatorios adicionales:</h5>
          <div class="mandatory-fields-list">
            <div *ngFor="let field of getAmadeusMandatoryFields()" class="mandatory-field-item">
              <i class="pi pi-exclamation-triangle"></i>
              <span>{{ field }}</span>
            </div>
          </div>
        </div>
      </div>
    </p-panel>
  </div>

  <!-- Indicador de carga para verificación de estado de reserva -->
  <div *ngIf="checkingReservationStatus" class="loading-indicator">
    <p-progressSpinner></p-progressSpinner>
    <p>Verificando estado de la reserva...</p>
  </div>

  <!-- Indicador de carga para verificación de estado de vuelos de Amadeus -->
  <div *ngIf="isCheckingFlightStatus" class="loading-indicator">
    <p-progressSpinner></p-progressSpinner>
    <p>Verificando la información necesaria para los vuelos seleccionados...</p>
  </div>

  <!-- Indicador de carga para datos de viajeros -->
  <div *ngIf="loading && !checkingReservationStatus && !isCheckingFlightStatus" class="loading-indicator">
    <p-progressSpinner></p-progressSpinner>
    <p>Cargando información de los viajeros...</p>
  </div>

  <!-- Mensaje de error -->
  <div *ngIf="error" class="error-message">
    <p>{{ error }}</p>
  </div>
  
  <div class="flex flex-col" *ngIf="!loading && !checkingReservationStatus && !error">
    <div class="border-2 border-dashed border-surface-200 dark:border-surface-700 rounded bg-surface-50 dark:bg-surface-950 flex-auto flex justify-center items-center font-medium">
      <div class="content-form">
        <div class="travel-title">
          <h3 class="title">Viajeros</h3>
        </div>
        
        <p-accordion 
          [multiple]="true"
          [value]="[0]"
          class="travelers-accordion">
          
          <!-- Generar un accordion panel por cada viajero -->
          <p-accordion-panel *ngFor="let traveler of travelers; let i = index" [value]="i">
            <p-accordion-header>
              Pasajero {{ traveler.travelerNumber }} {{ traveler.isLeadTraveler ? '(Persona que hace la reserva)' : '' }}
            </p-accordion-header>
            <p-accordion-content>
              
              <!-- Encabezado del panel -->
              <div class="traveler-header">
                <p-panel class="user-button">
                  <i class="pi pi-user"></i>
                  <p class="user">{{ getAgeGroupName(traveler.ageGroupId) }}</p>
                </p-panel>
                <p class="user-description">
                  <i class="pi pi-exclamation-circle info-icon"></i>
                  Introduce el nombre y el apellido tal y como aparecen en el documento de identificación. 
                  <strong>Los campos marcados con * son obligatorios.</strong>
                </p>
              </div>

              <!-- Formulario del viajero -->
              <ng-container *ngIf="getTravelerForm(i) as travelerForm">
                <form [formGroup]="travelerForm" class="traveler-form">
                <!-- Campos OBLIGATORIOS visibles siempre -->
                <div class="form-section mandatory-fields">
                  <div class="form-row">
                    <!-- Generar campos obligatorios dinámicamente desde la API -->
                    <ng-container *ngFor="let field of departureReservationFields; let fieldIndex = index">
                      <ng-container *ngIf="isFieldMandatory(field, traveler.isLeadTraveler) && getReservationFieldDetails(field.reservationFieldId) as fieldDetails">
                        
                        <div class="form-column form-field half-width" *ngIf="fieldDetails.fieldType === 'text' && fieldDetails.code !== 'phone'">
                          <label>{{ fieldDetails.name }}*</label>
                          <input 
                            pInputText 
                            [formControlName]="fieldDetails.code + '_' + traveler.id"
                            [placeholder]="'Introduce tu ' + fieldDetails.name.toLowerCase()"
                            [ngClass]="{ 'p-invalid': hasFieldError(traveler.id, fieldDetails.code) }"
                            (input)="onFieldChange(traveler.id, fieldDetails.code)" />
                          <small *ngIf="hasFieldError(traveler.id, fieldDetails.code)" class="p-error">
                            {{ getErrorMessage(fieldDetails.code, getFieldErrors(traveler.id, fieldDetails.code)) }}
                          </small>
                        </div>
                        
                        <div class="form-column form-field half-width" *ngIf="fieldDetails.fieldType === 'email'">
                          <label>{{ fieldDetails.name }}*</label>
                          <input 
                            pInputText 
                            type="email" 
                            [formControlName]="fieldDetails.code + '_' + traveler.id"
                            [placeholder]="'Introduce tu ' + fieldDetails.name.toLowerCase()"
                            [ngClass]="{ 'p-invalid': hasFieldError(traveler.id, fieldDetails.code) }"
                            (input)="onFieldChange(traveler.id, fieldDetails.code)" />
                          <small *ngIf="hasFieldError(traveler.id, fieldDetails.code)" class="p-error">
                            {{ getErrorMessage(fieldDetails.code, getFieldErrors(traveler.id, fieldDetails.code)) }}
                          </small>
                        </div>
                        
                        <div class="form-column form-field half-width" *ngIf="fieldDetails.fieldType === 'phone' || (fieldDetails.fieldType === 'text' && fieldDetails.code === 'phone')">
                          <label>{{ fieldDetails.name }}*</label>
                          <input 
                            pInputText 
                            type="tel" 
                            [formControlName]="fieldDetails.code + '_' + traveler.id"
                            [placeholder]="'Introduce tu ' + fieldDetails.name.toLowerCase()"
                            [ngClass]="{ 'p-invalid': hasFieldError(traveler.id, fieldDetails.code) }"
                            (input)="onPhoneFieldChange(traveler.id, fieldDetails.code, $event)" />
                          <small *ngIf="hasFieldError(traveler.id, fieldDetails.code)" class="p-error">
                            {{ getErrorMessage(fieldDetails.code, getFieldErrors(traveler.id, fieldDetails.code)) }}
                          </small>
                        </div>
                        
                        <div class="form-column form-field half-width" *ngIf="fieldDetails.fieldType === 'sex'">
                          <label>{{ fieldDetails.name }}*</label>
                          <p-dropdown 
                            [formControlName]="fieldDetails.code + '_' + traveler.id"
                            [options]="sexOptions" 
                            optionLabel="label" 
                            optionValue="value" 
                            placeholder="Seleccione"
                            [ngClass]="{ 'p-invalid': hasFieldError(traveler.id, fieldDetails.code) }"
                            (onChange)="onFieldChange(traveler.id, fieldDetails.code)"></p-dropdown>
                          <small *ngIf="hasFieldError(traveler.id, fieldDetails.code)" class="p-error">
                            {{ getErrorMessage(fieldDetails.code, getFieldErrors(traveler.id, fieldDetails.code)) }}
                          </small>
                        </div>
                        
                        <div class="form-column form-field half-width" *ngIf="fieldDetails.fieldType === 'date'">
                          <label>{{ fieldDetails.name }}*</label>
                          <p-datePicker 
                            [formControlName]="fieldDetails.code + '_' + traveler.id"
                            showIcon 
                            appendTo="body" 
                            placeholder="dd/mm/yyyy"
                            dateFormat="dd/mm/yy"
                            (onSelect)="onDateFieldChange(traveler.id, fieldDetails.code, $event)"
                            (onBlur)="onDateFieldBlur(traveler.id, fieldDetails.code)"
                            [ngClass]="{ 'p-invalid': hasFieldError(traveler.id, fieldDetails.code) }"></p-datePicker>
                          <small *ngIf="hasFieldError(traveler.id, fieldDetails.code)" class="p-error">
                            {{ getErrorMessage(fieldDetails.code, getFieldErrors(traveler.id, fieldDetails.code)) }}
                          </small>
                        </div>
                        
                        <div class="form-column form-field half-width" *ngIf="fieldDetails.fieldType === 'country'">
                          <label>{{ fieldDetails.name }}*</label>
                          <p-autocomplete 
                            [formControlName]="fieldDetails.code + '_' + traveler.id"
                            [suggestions]="countryOptions" 
                            field="name" 
                            [placeholder]="'Introduce tu ' + fieldDetails.name.toLowerCase()" 
                            appendTo="body" 
                            [dropdown]="true"
                            [ngClass]="{ 'p-invalid': hasFieldError(traveler.id, fieldDetails.code) }">
                          </p-autocomplete>
                          <small *ngIf="hasFieldError(traveler.id, fieldDetails.code)" class="p-error">
                            {{ getErrorMessage(fieldDetails.code, getFieldErrors(traveler.id, fieldDetails.code)) }}
                          </small>
                        </div>
                        
                      </ng-container>
                    </ng-container>
                  </div>

                  <!-- Campos de checkbox van en filas separadas -->
                  <ng-container *ngFor="let field of departureReservationFields">
                    <ng-container *ngIf="isFieldMandatory(field, traveler.isLeadTraveler) && getReservationFieldDetails(field.reservationFieldId) as fieldDetails">
                      <div class="form-row" *ngIf="fieldDetails.fieldType === 'checkbox'">
                        <div class="form-column form-field full-width">
                          <div class="checkbox-field">
                            <p-checkbox 
                              [formControlName]="fieldDetails.code + '_' + traveler.id"
                              binary="true" 
                              [inputId]="fieldDetails.code + '_' + traveler.id"></p-checkbox>
                            <label [for]="fieldDetails.code + '_' + traveler.id" class="checkbox-label">{{ fieldDetails.description }}*</label>
                          </div>
                        </div>
                      </div>
                    </ng-container>
                  </ng-container>
                </div>

                <!-- Botón Ver más / Ver menos -->
                <div class="form-row">
                  <div class="form-column">
                    <button
                      pButton
                      type="button"
                      [label]="showMoreFields ? 'Ver menos' : 'Ver más'"
                      [icon]="showMoreFields ? 'pi pi-chevron-up' : 'pi pi-chevron-down'"
                      (click)="toggleMoreFields()"
                      class="p-button-text p-button-sm show-more-button"
                    ></button>
                  </div>
                </div>
                
                <!-- Mensaje debajo del botón Ver más / Ver menos -->
                <div class="datos-adicionales-info">
                  <p class="mensaje-info">
                    <i class="pi pi-exclamation-circle icono-info"></i>
                    Completa tus datos pendientes antes de tu viaje. 
                    <strong>Puedes rellenarlos más tarde desde tu perfil.</strong>
                  </p>
                </div>
                <!-- Campos ADICIONALES visibles al hacer Ver más -->
                <div class="additional-fields" *ngIf="showMoreFields">
                  <div class="form-row">
                    <!-- Generar campos NO obligatorios dinámicamente desde la API -->
                    <ng-container *ngFor="let field of departureReservationFields">
                      <ng-container *ngIf="!isFieldMandatory(field, traveler.isLeadTraveler) && getReservationFieldDetails(field.reservationFieldId) as fieldDetails">
                        
                        <div class="form-column form-field half-width" *ngIf="fieldDetails.fieldType === 'text' && fieldDetails.code !== 'phone'">
                          <label>{{ fieldDetails.name }}</label>
                          <input 
                            pInputText 
                            [formControlName]="fieldDetails.code + '_' + traveler.id"
                            [placeholder]="'Introduce tu ' + fieldDetails.name.toLowerCase()"
                            [ngClass]="{ 'p-invalid': hasFieldError(traveler.id, fieldDetails.code) }"
                            (input)="onFieldChange(traveler.id, fieldDetails.code)" />
                          <small *ngIf="hasFieldError(traveler.id, fieldDetails.code)" class="p-error">
                            {{ getErrorMessage(fieldDetails.code, getFieldErrors(traveler.id, fieldDetails.code)) }}
                          </small>
                        </div>
                        
                        <div class="form-column form-field half-width" *ngIf="fieldDetails.fieldType === 'email'">
                          <label>{{ fieldDetails.name }}</label>
                          <input 
                            pInputText 
                            type="email" 
                            [formControlName]="fieldDetails.code + '_' + traveler.id"
                            [placeholder]="'Introduce tu ' + fieldDetails.name.toLowerCase()"
                            [ngClass]="{ 'p-invalid': hasFieldError(traveler.id, fieldDetails.code) }"
                            (input)="onFieldChange(traveler.id, fieldDetails.code)" />
                          <small *ngIf="hasFieldError(traveler.id, fieldDetails.code)" class="p-error">
                            {{ getErrorMessage(fieldDetails.code, getFieldErrors(traveler.id, fieldDetails.code)) }}
                          </small>
                        </div>
                        
                        <div class="form-column form-field half-width" *ngIf="fieldDetails.fieldType === 'phone' || (fieldDetails.fieldType === 'text' && fieldDetails.code === 'phone')">
                          <label>{{ fieldDetails.name }}</label>
                          <input 
                            pInputText 
                            type="tel" 
                            [formControlName]="fieldDetails.code + '_' + traveler.id"
                            [placeholder]="'Introduce tu ' + fieldDetails.name.toLowerCase()"
                            [ngClass]="{ 'p-invalid': hasFieldError(traveler.id, fieldDetails.code) }"
                            (input)="onPhoneFieldChange(traveler.id, fieldDetails.code, $event)" />
                          <small *ngIf="hasFieldError(traveler.id, fieldDetails.code)" class="p-error">
                            {{ getErrorMessage(fieldDetails.code, getFieldErrors(traveler.id, fieldDetails.code)) }}
                          </small>
                        </div>
                        
                        <div class="form-column form-field half-width" *ngIf="fieldDetails.fieldType === 'sex'">
                          <label>{{ fieldDetails.name }}</label>
                          <p-dropdown 
                            [formControlName]="fieldDetails.code + '_' + traveler.id"
                            [options]="sexOptions" 
                            optionLabel="label" 
                            optionValue="value" 
                            placeholder="Seleccione"></p-dropdown>
                        </div>
                        
                        <div class="form-column form-field half-width" *ngIf="fieldDetails.fieldType === 'date'">
                          <label>{{ fieldDetails.name }}</label>
                          <p-datePicker 
                            [formControlName]="fieldDetails.code + '_' + traveler.id"
                            showIcon 
                            appendTo="body" 
                            placeholder="dd/mm/yyyy"
                            dateFormat="dd/mm/yy"
                            (onSelect)="onDateFieldChange(traveler.id, fieldDetails.code, $event)"
                            (onBlur)="onDateFieldBlur(traveler.id, fieldDetails.code)"
                            [ngClass]="{ 'p-invalid': hasFieldError(traveler.id, fieldDetails.code) }"></p-datePicker>
                          <small *ngIf="hasFieldError(traveler.id, fieldDetails.code)" class="p-error">
                            {{ getErrorMessage(fieldDetails.code, getFieldErrors(traveler.id, fieldDetails.code)) }}
                          </small>
                        </div>
                        
                        <div class="form-column form-field half-width" *ngIf="fieldDetails.fieldType === 'country'">
                          <label>{{ fieldDetails.name }}</label>
                          <p-autocomplete 
                            [formControlName]="fieldDetails.code + '_' + traveler.id"
                            [suggestions]="countryOptions" 
                            field="name" 
                            [placeholder]="'Introduce tu ' + fieldDetails.name.toLowerCase()" 
                            appendTo="body" 
                            [dropdown]="true"></p-autocomplete>
                        </div>
                        
                      </ng-container>
                    </ng-container>
                  </div>

                  <!-- Campos de checkbox opcionales van en filas separadas -->
                  <ng-container *ngFor="let field of departureReservationFields">
                    <ng-container *ngIf="!isFieldMandatory(field, traveler.isLeadTraveler) && getReservationFieldDetails(field.reservationFieldId) as fieldDetails">
                      <div class="form-row" *ngIf="fieldDetails.fieldType === 'checkbox'">
                        <div class="form-column form-field full-width">
                          <div class="checkbox-field">
                            <p-checkbox 
                              [formControlName]="fieldDetails.code + '_' + traveler.id"
                              binary="true" 
                              [inputId]="fieldDetails.code + '_opt_' + traveler.id"></p-checkbox>
                            <label [for]="fieldDetails.code + '_opt_' + traveler.id" class="checkbox-label">{{ fieldDetails.description }}</label>
                          </div>
                        </div>
                      </div>
                    </ng-container>
                  </ng-container>
                </div>
                
                <!-- Actividades asignadas al viajero -->
                <div class="traveler-activities" *ngIf="(travelerActivities[traveler.id] && travelerActivities[traveler.id].length > 0) || (travelerActivityPacks[traveler.id] && travelerActivityPacks[traveler.id].length > 0)">
                  <h4>Actividades asignadas:</h4>
                  <div class="activities-list">
                    <!-- Actividades individuales asignadas -->
                    <ng-container *ngFor="let travelerActivity of travelerActivities[traveler.id]">
                      <div *ngIf="getActivityName(travelerActivity.activityId)" class="activity-item" style="display: flex; justify-content: space-between; align-items: center; padding: 5px 0;">
                        <div class="activity-info">
                          <h5><strong>{{ getActivityName(travelerActivity.activityId) }}</strong> </h5>
                        </div>
                        <div class="activity-toggle-container">
                          <p-progressSpinner 
                            *ngIf="isSavingActivity(traveler.id, travelerActivity.activityId)"
                            styleClass="activity-saving-spinner"
                            [style]="{ width: '20px', height: '20px' }">
                          </p-progressSpinner>
                          <p-toggleSwitch 
                            *ngIf="!isSavingActivity(traveler.id, travelerActivity.activityId)"
                            [ngModel]="true"
                            [disabled]="isSavingActivity(traveler.id, travelerActivity.activityId)"
                            (ngModelChange)="onActivityToggleChange(traveler.id, travelerActivity.activityId, $event)"
                            [ngModelOptions]="{standalone: true}">
                          </p-toggleSwitch>
                        </div>
                      </div>
                    </ng-container>
                    
                    <!-- Paquetes de actividades asignados -->
                    <ng-container *ngFor="let travelerActivityPack of travelerActivityPacks[traveler.id]">
                      <div *ngIf="getActivityName(travelerActivityPack.activityPackId)" class="activity-item" style="display: flex; justify-content: space-between; align-items: center; padding: 5px 0;">
                        <div class="activity-info">
                          <h5><strong>{{ getActivityName(travelerActivityPack.activityPackId) }}</strong> </h5>
                        </div>
                        <div class="activity-toggle-container">
                          <p-progressSpinner 
                            *ngIf="isSavingActivity(traveler.id, travelerActivityPack.activityPackId)"
                            styleClass="activity-saving-spinner"
                            [style]="{ width: '20px', height: '20px' }">
                          </p-progressSpinner>
                          <p-toggleSwitch 
                            *ngIf="!isSavingActivity(traveler.id, travelerActivityPack.activityPackId)"
                            [ngModel]="true"
                            [disabled]="isSavingActivity(traveler.id, travelerActivityPack.activityPackId)"
                            (ngModelChange)="onActivityToggleChange(traveler.id, travelerActivityPack.activityPackId, $event)"
                            [ngModelOptions]="{standalone: true}">
                          </p-toggleSwitch>
                        </div>
                      </div>
                    </ng-container>
                  </div>
                </div>
                </form>
              </ng-container>
              
            </p-accordion-content>
          </p-accordion-panel>
        </p-accordion>
      </div>
    </div>
  </div>

            <!-- NUEVO: Componente de personalización de habitaciones -->
            <app-info-travelers-room
              [travelers]="travelers"
              [ageGroups]="ageGroups"
              [reservationId]="reservationId"
              [departureId]="departureId"
              (roomAssignmentsChange)="onRoomAssignmentsChange($event)">
            </app-info-travelers-room>



</div>