<!-- new-reservation.component.html -->
<div class="loading-container" *ngIf="loading">
  <p-progressSpinner styleClass="reservation-loader"></p-progressSpinner>
</div>

<div
  *ngIf="!loading && !error"
  class="res-conf"
  [ngClass]="{
    'rq': status === 'PENDING' && paymentType !== 'Transfer',
    'confirm': status === 'SUCCESS',
    'transfer': paymentType === 'Transfer'
  }"
>
  <!-- Header con check y título -->
  <div class="hdr">
    <span
      class="status-icon"
      *ngIf="paymentType !== 'Transfer'"
      [class]="
        status === 'SUCCESS'
          ? 'pi pi-check-circle'
          : 'pi pi-exclamation-circle'
      "
    ></span>
    <h1 *ngIf="status === 'SUCCESS'">
      ¡Tu reserva con número {{ reservation?.id }} ha sido confirmada!
    </h1>
    <h1 *ngIf="status === 'PENDING' && paymentType !== 'Transfer'">
      ¡Tu reserva con número {{ reservation?.id }} está en petición!
    </h1>
    <h1 *ngIf="paymentType === 'Transfer'">
      Confirma tu petición de reserva realizando el pago por transferencia
    </h1>
  </div>

  <!-- Mensaje de bienvenida -->
  <div class="wel">
    <p class="greet" *ngIf="leadTravelerName">
      Hola {{ leadTravelerName }},
    </p>

    <!-- Mensajes específicos por estado -->
    <ng-container *ngIf="status === 'SUCCESS'">
      <p class="hl">
        ¡Estamos emocionados de confirmarte que tu reserva ha sido realizada con éxito!
      </p>
      <p class="msg">
        Gracias por elegirnos para tu próximo viaje. Sabemos que cada viaje es
        una oportunidad para crear recuerdos inolvidables, y estamos aquí para
        asegurarnos de que todo sea perfecto. Si tienes alguna pregunta sobre tu
        destino, recomendaciones de actividades o cualquier detalle relacionado
        con tu viaje, no dudes en contactarnos.
      </p>
      <p class="msg">
        ¡Estamos seguros de que vivirás una experiencia maravillosa!
      </p>
    </ng-container>

    <ng-container *ngIf="status === 'PENDING' && paymentType !== 'Transfer'">
      <p class="hl">
        Hemos bloqueado tus plazas, ¡Esto significa que te tenemos en cuenta
        para la salida de este tour!
      </p>
      <p class="msg">
        Pero algunos de los servicios incluidos en tu viaje están aún pendientes
        de confirmación. Si el precio de tu viaje sufre alguna modificación
        podrás cancelar la reserva sin ningún compromiso y recibir un reembolso
        inmediato.
      </p>
      <p class="msg">
        Nuestro equipo de atención al cliente se pondrá en contacto contigo
        <span class="status-msg">vía email</span> en las próximas 24/48 horas
        con toda la información actualizada y los detalles para realizar el pago
        del depósito de tu viaje. Agradecemos tu paciencia y comprensión
      </p>
    </ng-container>

    <ng-container *ngIf="paymentType === 'Transfer'">
      <p class="hl">¡Hemos recibido tu petición de reserva del tour!</p>
      <p class="msg">
        Por favor, realiza el pago por transferencia antes de las 11:59 pm
        {{ nextDayDate }} a través de las entidades bancarias que se indican.
      </p>
      <p class="status-msg" style="color: #f05a4c" *ngIf="!payment?.attachmentUrl">
        IMPORTANTE: Sube el justificante de pago dentro de este plazo para
        evitar que tu viaje se cancele automáticamente.
      </p>
    </ng-container>

    <!-- Recuadro coral con información bancaria -->
    <p-panel styleClass="bank-panel" *ngIf="paymentType === 'Transfer'">
      <ng-template pTemplate="header">
        <div class="pan-hdr">
          Realiza el pago a través de una de estas entidades bancarias y adjunta
          el justificante
        </div>
      </ng-template>
      <div class="bank-info">
        <div class="bank-column" *ngFor="let bank of bankInfo">
          <div class="bank-row">
            <span class="label">Banco:</span>
            <span class="value">{{ bank.name }}</span>
          </div>
          <div class="bank-row">
            <span class="label">Cuenta:</span>
            <span class="value">{{ bank.account }}</span>
          </div>
          <div class="bank-row">
            <span class="label">Beneficiario:</span>
            <span class="value">{{ bank.beneficiary }}</span>
          </div>
          <div class="bank-row">
            <span class="label">Concepto:</span>
            <span class="value">{{ bank.concept }}</span>
          </div>
        </div>
      </div>
    </p-panel>

    <ng-container *ngIf="paymentType === 'Transfer'">
      <!-- Botón de justificante: mostrar componente de subida o botón de ver voucher -->
      <ng-container
        *ngIf="!payment?.attachmentUrl && status === 'PENDING'; else voucherView"
      >
        <app-upload-button
          label="Subir justificante de transferencia"
          accept="image/*, .pdf"
          [maxFileSize]="1000000"
          folder="vouchers"
          [auto]="false"
          chooseIcon="pi pi-upload"
          styleClass="upload-button"
          (onUploadSuccess)="handleVoucherUpload($event)"
          (onUploadError)="handleVoucherError($event)"
        >
        </app-upload-button>
      </ng-container>
      <ng-template #voucherView>
        <p-button
          label="Ver justificante"
          (onClick)="viewVoucher()"
          severity="info"
        ></p-button>
        <ng-container *ngIf="status === 'PENDING'">
          <p class="voucher-status-text">
            Hemos recibido tu comprobante de pago y nuestro equipo lo estará
            validando. Recibirás una notificación en tu correo cuando la
            transferencia sea verificada.
          </p>
        </ng-container>
      </ng-template>
    </ng-container>
  </div>

  <!-- Panel de detalles -->
  <p-panel styleClass="det-panel">
    <div class="det-item">
      <label class="val">Fecha de reserva:</label>
      <span>{{ reservation?.createdAt | date:'dd/MM/yyyy' }}</span>
    </div>
    <div class="det-item">
      <label class="val">Número de reserva:</label>
      <span>{{ reservation?.id }}</span>
    </div>
    <div class="det-item">
      <label class="val">{{
        status === "PENDING"
          ? "Pendiente a abonar:"
          : "Importe abonado:"
      }}</label>
      <span>{{ (reservation?.totalAmount || 0) | number:'1.0-0' }} €</span>
    </div>
  </p-panel>

  <!-- Sección de creación de contraseña (comentada como en el ejemplo) -->
  <!--
  <div class="lnk">
    <p>
      Te has dado de alta en nuestra web al realizar tu reserva, crea tu
      contraseña para acceder a
      <a href="#">tu perfil</a> y poder gestionar tu reserva
    </p>
    <a href="#" class="pwd" style="color: #55728f">Crear contraseña</a>
  </div>
  -->

  <!-- Panel de información del viaje -->
  <app-travel-info 
    [reservationId]="reservationId"
    [tourId]="reservation?.tourId"
    [departureId]="reservation?.departureId">
  </app-travel-info>

  <!-- Panel de información de viajeros -->
  <app-travelers-info 
    [reservationId]="reservationId">
  </app-travelers-info>

  <!-- Panel de información de vuelos -->
  <app-section-flight 
    [departureId]="reservation?.departureId">
  </app-section-flight>
</div>

<div *ngIf="error" class="error-container">
  <i
    class="pi pi-exclamation-triangle"
    style="font-size: 3rem; color: #f05a4c"
  ></i>
  <h2>No se pudo cargar la información de la reserva</h2>
  <p>
    Por favor, inténtalo de nuevo más tarde o ponte en contacto con nuestro
    equipo de soporte.
  </p>
  <p-button 
    label="Volver" 
    routerLink="/" 
    icon="pi pi-arrow-left"
    severity="secondary">
  </p-button>
</div>