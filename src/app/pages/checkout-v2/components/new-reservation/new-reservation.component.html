<!-- new-reservation.component.html -->
<div class="loading-container" *ngIf="loading">
  <p-progressSpinner styleClass="reservation-loader"></p-progressSpinner>
</div>

<div
  *ngIf="!loading && !error"
  class="res-conf"
  [ngClass]="{
    'rq': status === 'PENDING' && paymentType !== 'Transfer',
    'confirm': status === 'SUCCESS',
    'transfer': paymentType === 'Transfer'
  }"
>
  <!-- Header con check y t√≠tulo -->
  <div class="hdr">
    <span
      class="status-icon"
      *ngIf="paymentType !== 'Transfer'"
      [class]="
        status === 'SUCCESS'
          ? 'pi pi-check-circle'
          : 'pi pi-exclamation-circle'
      "
    ></span>
    <h1 *ngIf="status === 'SUCCESS'">
      ¬°Tu reserva con n√∫mero {{ reservation?.id }} ha sido confirmada!
    </h1>
    <h1 *ngIf="status === 'PENDING' && paymentType !== 'Transfer'">
      ¬°Tu reserva con n√∫mero #{{ reservation?.id }} est√° en petici√≥n!
    </h1>
    <h1 *ngIf="paymentType === 'Transfer'">
      Confirma tu petici√≥n de reserva realizando el pago por transferencia
    </h1>
  </div>

  <!-- Mensaje de bienvenida -->
  <div class="wel">
    <p class="greet" *ngIf="leadTravelerName">
      Hola {{ leadTravelerName }},
    </p>

    <!-- Mensajes espec√≠ficos por estado -->
    <ng-container *ngIf="status === 'SUCCESS'">
      <p class="hl">
        ¬°Estamos emocionados de confirmarte que tu reserva ha sido realizada con √©xito!
      </p>
      <p class="msg">
        Gracias por elegirnos para tu pr√≥ximo viaje. Sabemos que cada viaje es
        una oportunidad para crear recuerdos inolvidables, y estamos aqu√≠ para
        asegurarnos de que todo sea perfecto. Si tienes alguna pregunta sobre tu
        destino, recomendaciones de actividades o cualquier detalle relacionado
        con tu viaje, no dudes en contactarnos.
      </p>
      <p class="msg">
        ¬°Estamos seguros de que vivir√°s una experiencia maravillosa!
      </p>
    </ng-container>

    <ng-container *ngIf="status === 'PENDING' && paymentType !== 'Transfer'">
      <p class="hl">
        Hemos bloqueado tus plazas, ¬°Esto significa que te tenemos en cuenta
        para la salida de este tour!
      </p>
      <p class="msg">
        Pero algunos de los servicios incluidos en tu viaje est√°n a√∫n pendientes
        de confirmaci√≥n. Si el precio de tu viaje sufre alguna modificaci√≥n
        podr√°s cancelar la reserva sin ning√∫n compromiso y recibir un reembolso
        inmediato.
      </p>
      <p class="msg">
        Nuestro equipo de atenci√≥n al cliente se pondr√° en contacto contigo
        <span class="status-msg">v√≠a email</span> en las pr√≥ximas 24/48 horas
        con toda la informaci√≥n actualizada y los detalles para realizar el pago
        del dep√≥sito de tu viaje. Agradecemos tu paciencia y comprensi√≥n
      </p>
    </ng-container>

    <ng-container *ngIf="paymentType === 'Transfer'">
      <p class="hl">¬°Hemos recibido tu petici√≥n de reserva del tour!</p>
      <p class="msg">
        Por favor, realiza el pago por transferencia antes de las 11:59 pm
        {{ nextDayDate }} a trav√©s de las entidades bancarias que se indican.
      </p>
      <p class="status-msg" style="color: #f05a4c" *ngIf="!payment?.attachmentUrl">
        IMPORTANTE: Sube el justificante de pago dentro de este plazo para
        evitar que tu viaje se cancele autom√°ticamente.
      </p>
    </ng-container>

    <!-- Recuadro coral con informaci√≥n bancaria -->
    <p-panel styleClass="bank-panel" *ngIf="paymentType === 'Transfer'">
      <ng-template pTemplate="header">
        <div class="pan-hdr">
          Realiza el pago a trav√©s de una de estas entidades bancarias y adjunta
          el justificante
        </div>
      </ng-template>
      <div class="bank-info">
        <div class="bank-column" *ngFor="let bank of bankInfo">
          <div class="bank-row">
            <span class="label">Banco:</span>
            <span class="value">{{ bank.name }}</span>
          </div>
          <div class="bank-row">
            <span class="label">Cuenta:</span>
            <span class="value">{{ bank.account }}</span>
          </div>
          <div class="bank-row">
            <span class="label">Beneficiario:</span>
            <span class="value">{{ bank.beneficiary }}</span>
          </div>
          <div class="bank-row">
            <span class="label">Concepto:</span>
            <span class="value">{{ bank.concept }}</span>
          </div>
        </div>
      </div>
    </p-panel>

    <ng-container *ngIf="paymentType === 'Transfer'">
      <!-- Bot√≥n de justificante: mostrar componente de subida o bot√≥n de ver voucher -->
      <ng-container
        *ngIf="!payment?.attachmentUrl && status === 'PENDING'; else voucherView"
      >
        <app-upload-button
          label="Subir justificante de transferencia"
          accept="image/*, .pdf"
          [maxFileSize]="1000000"
          folder="vouchers"
          [auto]="false"
          chooseIcon="pi pi-upload"
          styleClass="upload-button"
          (onUploadSuccess)="handleVoucherUpload($event)"
          (onUploadError)="handleVoucherError($event)"
        >
        </app-upload-button>
      </ng-container>
      <ng-template #voucherView>
        <p-button
          label="Ver justificante"
          (onClick)="viewVoucher()"
          severity="info"
        ></p-button>
        <ng-container *ngIf="status === 'PENDING'">
          <p class="voucher-status-text">
            Hemos recibido tu comprobante de pago y nuestro equipo lo estar√°
            validando. Recibir√°s una notificaci√≥n en tu correo cuando la
            transferencia sea verificada.
          </p>
        </ng-container>
      </ng-template>
    </ng-container>
  </div>

  <!-- Panel de detalles -->
  <p-panel styleClass="det-panel">
    <div class="det-item">
      <label class="val">Fecha de reserva:</label>
      <span>{{ reservation?.createdAt | date:'dd/MM/yyyy' }}</span>
    </div>
    <div class="det-item">
      <label class="val">N√∫mero de reserva:</label>
      <span>#{{ reservation?.id }}</span>
    </div>
    <div class="det-item">
      <label class="val">{{
        status === "PENDING"
          ? "Pendiente a abonar:"
          : "Importe abonado:"
      }}</label>
      <span>{{ (reservation?.totalAmount || 0) | number:'1.0-0' }} ‚Ç¨</span>
    </div>
  </p-panel>

  <!-- Secci√≥n de creaci√≥n de contrase√±a (comentada como en el ejemplo) -->
  <!--
  <div class="lnk">
    <p>
      Te has dado de alta en nuestra web al realizar tu reserva, crea tu
      contrase√±a para acceder a
      <a href="#">tu perfil</a> y poder gestionar tu reserva
    </p>
    <a href="#" class="pwd" style="color: #55728f">Crear contrase√±a</a>
  </div>
  

  <!-- Panel de informaci√≥n del viaje -->
  <app-travel-info 
    [reservationId]="reservationId"
    [tourId]="reservation?.tourId"
    [departureId]="reservation?.departureId">
  </app-travel-info>

  <!-- Panel de informaci√≥n de viajeros -->
  <app-travelers-info 
    [reservationId]="reservationId">
  </app-travelers-info>

  <!-- Panel de informaci√≥n de vuelos -->
  <app-section-flight 
    [departureId]="reservation?.departureId">
  </app-section-flight>

  <!-- Panel de resumen de precios -->
  <app-summary-info 
    [reservationId]="reservationId">
  </app-summary-info>

  <!-- Panel de informaci√≥n de pago -->
  <app-payment-info 
    [reservationId]="reservationId">
  </app-payment-info>

  <!-- ‚úÖ NUEVA SECCI√ìN: Informaci√≥n de reserva de vuelos Amadeus -->
  <div class="amadeus-flight-section" *ngIf="hasAmadeusFlight || flightBookingResponse">
    <p-panel styleClass="amadeus-panel">
      <ng-template pTemplate="header">
        <div class="amadeus-header">
          <i class="pi pi-plane" style="margin-right: 0.5rem;"></i>
          Reserva de Vuelos Amadeus
        </div>
      </ng-template>
      
      <!-- Estado de verificaci√≥n -->
      <div class="flight-status" *ngIf="!flightBookingResponse && !flightBookingError">
        <div class="status-item">
          <i class="pi pi-check-circle" style="color: var(--success-green); margin-right: 0.5rem;"></i>
          <span>Vuelos Amadeus detectados y seleccionados</span>
        </div>
        
        <!-- Loading durante la reserva -->
        <div class="booking-loading" *ngIf="flightBookingLoading">
          <p-progressSpinner styleClass="flight-loader"></p-progressSpinner>
          <p>Procesando reserva de vuelos...</p>
        </div>

        <!-- ‚úÖ DEBUG: Estado actual de vuelos -->
        <div class="debug-section">
          <details>
            <summary class="debug-summary">
              üîç Ver estado actual (Debug)
            </summary>
            <div class="debug-content">
              <div class="debug-item">
                <strong>hasAmadeusFlight:</strong> 
                <span class="debug-value" [class.success]="hasAmadeusFlight" [class.error]="!hasAmadeusFlight">{{ hasAmadeusFlight }}</span>
              </div>
              <div class="debug-item">
                <strong>flightBookingLoading:</strong> 
                <span class="debug-value" [class.loading]="flightBookingLoading">{{ flightBookingLoading }}</span>
              </div>
              <div class="debug-item">
                <strong>flightBookingError:</strong> 
                <span class="debug-value" [class.error]="flightBookingError">{{ flightBookingError }}</span>
              </div>
              <div class="debug-item">
                <strong>reservationId:</strong> 
                <span class="debug-id">{{ reservationId || 'No disponible' }}</span>
              </div>
              
              <!-- Bot√≥n manual para probar -->
              <div class="debug-actions">
                <p-button 
                  label="üîÑ Verificar vuelos manualmente" 
                  (onClick)="checkAndBookAmadeusFlight()" 
                  severity="info"
                  [disabled]="!reservationId || flightBookingLoading"
                  styleClass="debug-button">
                </p-button>
              </div>
            </div>
          </details>
        </div>
      </div>

      <!-- Respuesta exitosa de la reserva -->
      <div class="flight-success" *ngIf="flightBookingResponse && !flightBookingLoading">
        <div class="success-header">
          <i class="pi pi-check-circle success-icon"></i>
          <h3>¬°Vuelos reservados exitosamente!</h3>
        </div>
        
        <div class="flight-details" *ngIf="flightBookingResponse.data">
          <div class="detail-item" *ngIf="flightBookingResponse.data.id">
            <label>ID de Orden:</label>
            <span>{{ flightBookingResponse.data.id }}</span>
          </div>
          <div class="detail-item" *ngIf="flightBookingResponse.data.type">
            <label>Tipo de Orden:</label>
            <span>{{ flightBookingResponse.data.type }}</span>
          </div>
          <div class="detail-item" *ngIf="flightBookingResponse.data.queuingOfficeId">
            <label>Oficina de Cola:</label>
            <span>{{ flightBookingResponse.data.queuingOfficeId }}</span>
          </div>
          <div class="detail-item" *ngIf="flightBookingResponse.data.ownerOfficeId">
            <label>Oficina Propietaria:</label>
            <span>{{ flightBookingResponse.data.ownerOfficeId }}</span>
          </div>

          <!-- Informaci√≥n de FlightOffers -->
          <div class="flight-offers" *ngIf="flightBookingResponse.data.flightOffers && flightBookingResponse.data.flightOffers.length > 0">
            <h4>Ofertas de Vuelo:</h4>
            <div class="offer-item" *ngFor="let offer of flightBookingResponse.data.flightOffers; let i = index">
              <div class="offer-header">
                <strong>Oferta {{ i + 1 }}</strong>
                <span class="offer-id" *ngIf="offer.id">ID: {{ offer.id }}</span>
              </div>
              
              <div class="offer-details">
                <div class="detail-row" *ngIf="offer.source">
                  <label>Fuente:</label>
                  <span>{{ offer.source }}</span>
                </div>
                <div class="detail-row" *ngIf="offer.oneWay !== null">
                  <label>Ida y Vuelta:</label>
                  <span>{{ offer.oneWay ? 'Solo Ida' : 'Ida y Vuelta' }}</span>
                </div>
                <div class="detail-row" *ngIf="offer.numberOfBookableSeats">
                  <label>Asientos Disponibles:</label>
                  <span>{{ offer.numberOfBookableSeats }}</span>
                </div>
                <div class="detail-row" *ngIf="offer.paymentCardRequired !== null">
                  <label>Tarjeta Requerida:</label>
                  <span>{{ offer.paymentCardRequired ? 'S√≠' : 'No' }}</span>
                </div>
              </div>

              <!-- Informaci√≥n de Precio -->
              <div class="price-info" *ngIf="offer.price">
                <h5>Precio:</h5>
                <div class="price-details">
                  <div class="price-row" *ngIf="offer.price.total">
                    <label>Total:</label>
                    <span class="price-value">{{ offer.price.total }} {{ offer.price.currency || 'EUR' }}</span>
                  </div>
                  <div class="price-row" *ngIf="offer.price.base">
                    <label>Base:</label>
                    <span>{{ offer.price.base }} {{ offer.price.currency || 'EUR' }}</span>
                  </div>
                  <div class="price-row" *ngIf="offer.price.grandTotal">
                    <label>Total General:</label>
                    <span>{{ offer.price.grandTotal }} {{ offer.price.billingCurrency || 'EUR' }}</span>
                  </div>
                </div>
              </div>

              <!-- Informaci√≥n de Itinerarios -->
              <div class="itineraries-info" *ngIf="offer.itineraries && offer.itineraries.length > 0">
                <h5>Itinerarios:</h5>
                <div class="itinerary-item" *ngFor="let itinerary of offer.itineraries; let j = index">
                  <div class="itinerary-header">
                    <strong>Itinerario {{ j + 1 }}</strong>
                    <span *ngIf="itinerary.duration">Duraci√≥n: {{ itinerary.duration }}</span>
                  </div>
                  
                  <div class="segments-info" *ngIf="itinerary.segments && itinerary.segments.length > 0">
                    <div class="segment-item" *ngFor="let segment of itinerary.segments; let k = index">
                      <div class="segment-header">
                        <strong>Segmento {{ k + 1 }}</strong>
                        <span class="carrier" *ngIf="segment.carrierCode">{{ segment.carrierCode }}</span>
                        <span class="flight-number" *ngIf="segment.number">{{ segment.number }}</span>
                      </div>
                      
                      <div class="segment-details">
                        <div class="segment-row" *ngIf="segment.departure">
                          <label>Salida:</label>
                          <span>{{ segment.departure.iataCode ?? '' }} {{ segment.departure.terminal ? '(T' + segment.departure.terminal + ')' : '' }}</span>
                          <span class="time" *ngIf="segment.departure.at">{{ segment.departure.at | date:'HH:mm' }}</span>
                        </div>
                        <div class="segment-row" *ngIf="segment.arrival">
                          <label>Llegada:</label>
                          <span>{{ segment.arrival.iataCode ?? '' }} {{ segment.arrival.terminal ? '(T' + segment.arrival.terminal + ')' : '' }}</span>
                          <span class="time" *ngIf="segment.arrival?.at">{{ segment.arrival.at | date:'HH:mm' }}</span>
                        </div>
                        <div class="segment-row" *ngIf="segment.duration">
                          <label>Duraci√≥n:</label>
                          <span>{{ segment.duration }}</span>
                        </div>
                        <div class="segment-row" *ngIf="segment.bookingStatus">
                          <label>Estado:</label>
                          <span [class]="'status-' + segment.bookingStatus.toLowerCase()">{{ segment.bookingStatus }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Informaci√≥n de Viajeros -->
          <div class="travelers-info" *ngIf="flightBookingResponse.data.travelers && flightBookingResponse.data.travelers.length > 0">
            <h4>Viajeros:</h4>
            <div class="traveler-item" *ngFor="let traveler of flightBookingResponse.data.travelers; let i = index">
              <div class="traveler-header">
                <strong>Viajero {{ i + 1 }}</strong>
                <span class="traveler-id" *ngIf="traveler.id">ID: {{ traveler.id }}</span>
              </div>
              
              <div class="traveler-details">
                <div class="detail-row" *ngIf="traveler.name">
                  <label>Nombre:</label>
                  <span>{{ traveler.name.title }} {{ traveler.name.firstName }} {{ traveler.name.lastName }}</span>
                </div>
                <div class="detail-row" *ngIf="traveler.dateOfBirth">
                  <label>Fecha de Nacimiento:</label>
                  <span>{{ traveler.dateOfBirth | date:'dd/MM/yyyy' }}</span>
                </div>
                <div class="detail-row" *ngIf="traveler.gender">
                  <label>G√©nero:</label>
                  <span>{{ traveler.gender }}</span>
                </div>
                <div class="detail-row" *ngIf="traveler.travelerType">
                  <label>Tipo:</label>
                  <span>{{ traveler.travelerType }}</span>
                </div>
                <div class="detail-row" *ngIf="traveler.contact?.emailAddress">
                  <label>Email:</label>
                  <span>{{ traveler.contact?.emailAddress }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Warnings si existen -->
        <div class="flight-warnings" *ngIf="flightBookingResponse.warnings && flightBookingResponse.warnings.length > 0">
          <h4>Advertencias:</h4>
          <div class="warning-item" *ngFor="let warning of flightBookingResponse.warnings">
            <i class="pi pi-exclamation-triangle warning-icon"></i>
            <span>{{ warning.title }}: {{ warning.detail }}</span>
          </div>
        </div>

        <!-- ‚úÖ SECCI√ìN DEBUG: Informaci√≥n completa en JSON -->
        <div class="debug-section">
          <details>
            <summary class="debug-summary">
              üîç Ver informaci√≥n completa (Debug)
            </summary>
            <div class="debug-content">
              <pre class="debug-json">{{ flightBookingResponse | json }}</pre>
            </div>
          </details>
        </div>
      </div>

      <!-- Error en la reserva -->
      <div class="flight-error" *ngIf="flightBookingError && !flightBookingLoading">
        <div class="error-header">
          <i class="pi pi-exclamation-triangle error-icon"></i>
          <h3>Error en la reserva de vuelos</h3>
        </div>
        <p>No se pudo completar la reserva de vuelos. Por favor, contacta con soporte t√©cnico.</p>
        <p-button 
          label="Reintentar" 
          (onClick)="checkAndBookAmadeusFlight()" 
          severity="warn"
          styleClass="retry-button">
        </p-button>
      </div>
    </p-panel>
  </div>

</div>

<div *ngIf="error" class="error-container">
  <i
    class="pi pi-exclamation-triangle"
    style="font-size: 3rem; color: #f05a4c"
  ></i>
  <h2>No se pudo cargar la informaci√≥n de la reserva</h2>
  <p>
    Por favor, int√©ntalo de nuevo m√°s tarde o ponte en contacto con nuestro
    equipo de soporte.
  </p>
  <p-button 
    label="Volver" 
    routerLink="/" 
    icon="pi pi-arrow-left"
    severity="secondary">
  </p-button>
</div>