<div *ngIf="isLoading && paymentType === 'installments'" class="loading-container-scalapay">
  <span>Espere un momento, le estamos redirigiendo a <img src="assets/images/scalapay.svg" alt="ScalaPay" class="scalapay-logo" loading="lazy" /></span>
  <p-progressSpinner></p-progressSpinner>
</div>
<div *ngIf="isLoading && paymentType != 'installments'" class="loading-container">
  <p-progressSpinner></p-progressSpinner>
</div>
<div class="container" *ngIf="!isLoading">
  <div class="header-container" (click)="toggleDropdown()">
    <div class="title-with-icon">
      <span class="title">Selecciona la forma de pago</span>
      <i class="pi" [ngClass]="isOpen ? 'pi-chevron-up' : 'pi-chevron-down'"></i>
    </div>
    <div class="title-underline"></div>
  </div>

  <div *ngIf="isOpen" class="payment-panels">
    <!-- Panel para pago completo -->
    <p-panel styleClass="payment-panel" [ngClass]="{ 'selected': paymentType === 'complete' }" (click)="selectPaymentType('complete')">
      <div class="payment-option">
        <p-radioButton name="paymentType" value="complete" [(ngModel)]="paymentType" (onChange)="onPaymentTypeChange()"></p-radioButton>
        <span class="option-text">Paga tu viaje al completo</span>
        <span class="option-price">{{ totalPrice | currencyFormat }}</span>
      </div>
    </p-panel>

    <!-- Panel para pago con depósito -->
    <p-panel styleClass="payment-panel" [ngClass]="{ 'selected': paymentType === 'deposit' }" (click)="selectPaymentType('deposit')">
      <div class="payment-option">
        <p-radioButton name="paymentType" value="deposit" [(ngModel)]="paymentType" (onChange)="onPaymentTypeChange()"></p-radioButton>
        <span class="option-text">
          Paga ahora {{ depositAmount | currencyFormat }} y el resto antes del {{ paymentDeadline }}
        </span>
        <span class="option-price">{{ depositAmount | currencyFormat }}</span>
      </div>
    </p-panel>

    <!-- Panel para pago a plazos -->
    <p-panel styleClass="payment-panel" [ngClass]="{ 'selected': paymentType === 'installments' }" (click)="selectPaymentType('installments')">
      <div class="payment-option">
        <p-radioButton name="paymentType" value="installments" [(ngModel)]="paymentType" (onChange)="onPaymentTypeChange()"></p-radioButton>
        <span class="option-text">Paga a plazos</span>
        <img src="assets/images/scalapay.svg" alt="ScalaPay" class="scalapay-logo" loading="lazy" />
      </div>
    </p-panel>
  </div>

  <!-- Métodos de pago para completo o depósito -->
  <div *ngIf="paymentType === 'complete' || paymentType === 'deposit'" class="payment-methods-section">
    <div class="header-container" (click)="togglePaymentMethodsDropdown()">
      <div class="title-with-icon">
        <span class="title">Selecciona el método de pago</span>
        <i class="pi" [ngClass]="isPaymentMethodsOpen ? 'pi-chevron-up' : 'pi-chevron-down'"></i>
      </div>
      <div class="title-underline pay"></div>
    </div>
    <div *ngIf="isPaymentMethodsOpen" class="payment-methods-row">
      <div class="payment-method-container">
        <p-panel styleClass="payment-panel payment-method-panel" [ngClass]="{ selected: paymentMethod === 'creditCard' }" (click)="selectPaymentMethod('creditCard')">
          <div class="payment-option">
            <p-radioButton name="paymentMethod" value="creditCard" [(ngModel)]="paymentMethod" (onChange)="onPaymentMethodChange()"></p-radioButton>
            <span class="option-text">Tarjeta bancaria</span>
          </div>
        </p-panel>
      </div>
      <div class="payment-method-container">
        <p-panel styleClass="payment-panel payment-method-panel" [ngClass]="{ selected: paymentMethod === 'transfer' }" (click)="selectPaymentMethod('transfer')">
          <div class="payment-option">
            <p-radioButton name="paymentMethod" value="transfer" [(ngModel)]="paymentMethod" (onChange)="onPaymentMethodChange()"></p-radioButton>
            <span class="option-text">Transferencia bancaria</span>
          </div>
        </p-panel>
      </div>
    </div>
  </div>

  <!-- Sección de cuotas para pago a plazos -->
  <div *ngIf="paymentType === 'installments'" class="installments-section">
    <div class="header-container" (click)="toggleInstallmentsDropdown()">
      <div class="title-with-icon">
        <span class="title">Selecciona el plazo de pagos</span>
        <i
          class="pi"
          [ngClass]="isInstallmentsOpen ? 'pi-chevron-up' : 'pi-chevron-down'"
        ></i>
      </div>
      <div class="title-underline"></div>
    </div>

    <div *ngIf="isInstallmentsOpen" class="installment-panels-row">
      <div class="installment-panel-container">
        <!-- Panel para 3 cuotas - Ahora clickeable completo -->
        <p-panel
          styleClass="payment-panel installment-panel"
          [ngClass]="{ selected: installmentOption === 'three' }"
          (click)="selectInstallmentOption('three')"
        >
          <div class="payment-option">
            <p-radioButton
              name="installmentOption"
              value="three"
              [(ngModel)]="installmentOption"
              (onChange)="onInstallmentOptionChange()"
            >
            </p-radioButton>
            <div class="installment-content">
              <div class="scalapay-widget-container">
                <div id="price-container-three" style="display: none">
                  {{ totalPrice | currencyFormat }}
                </div>
                <scalapay-widget
                  channel="travel"
                  type="checkout"
                  show-title="true"
                  frequency-number="30"
                  number-of-installments="3"
                  hide="false"
                  hide-price="false"
                  min="0.01"
                  max="999999"
                  amount-selectors='["#price-container-three"]'
                  currency-position="before"
                  currency-display="symbol"
                  logo-size="100"
                  locale="es"
                >
                </scalapay-widget>
              </div>
            </div>
          </div>
        </p-panel>
      </div>

      <div class="installment-panel-container">
        <!-- Panel para 4 cuotas - Ahora clickeable completo -->
        <p-panel
          styleClass="payment-panel installment-panel"
          [ngClass]="{ selected: installmentOption === 'four' }"
          (click)="selectInstallmentOption('four')"
        >
          <div class="payment-option">
            <p-radioButton
              name="installmentOption"
              value="four"
              [(ngModel)]="installmentOption"
              (onChange)="onInstallmentOptionChange()"
            >
            </p-radioButton>
            <div class="installment-content">
              <div class="scalapay-widget-container">
                <div id="price-container-four" style="display: none">
                  {{ totalPrice | currencyFormat }}
                </div>
                <scalapay-widget
                  channel="travel"
                  type="checkout"
                  show-title="true"
                  frequency-number="30"
                  number-of-installments="4"
                  hide="false"
                  hide-price="false"
                  min="0.01"
                  max="999999"
                  amount-selectors='["#price-container-four"]'
                  currency-position="before"
                  currency-display="symbol"
                  logo-size="100"
                  locale="es"
                >
                </scalapay-widget>
              </div>
            </div>
          </div>
        </p-panel>
      </div>
    </div>
  </div>

  <!-- Botón de pago -->
  <div class="buttons-container">
    <p-button label="Regresar" severity="secondary" icon="pi pi-arrow-left" styleClass="back-button" [disabled]="isLoading" (click)="goBack()"></p-button>
    <p-button [label]="isLoading ? 'Procesando...' : 'Realizar pago'" styleClass="payment-button" [disabled]="isLoading || !paymentType || ((paymentType === 'complete' || paymentType === 'deposit') && !paymentMethod) || (paymentType === 'installments' && !installmentOption)" (click)="submitPayment()"></p-button>
  </div>
</div>