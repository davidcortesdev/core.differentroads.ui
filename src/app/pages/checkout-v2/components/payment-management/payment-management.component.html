<!-- Loading States -->
<app-loading-section 
  [isLoading]="isLoading" 
  [paymentType]="paymentType">
</app-loading-section>

<!-- Main Content -->
<div class="container" *ngIf="!isLoading">
  <!-- Payment Type Selection -->
  <section class="payment-type-section">
    <header class="section-header" (click)="toggleDropdown('main')">
      <div class="title-with-icon">
        <h2 class="title">Selecciona la forma de pago</h2>
        <i class="pi" 
           [ngClass]="dropdownStates.main ? 'pi-chevron-up' : 'pi-chevron-down'"
           aria-hidden="true"></i>
      </div>
      <div class="title-underline"></div>
    </header>

    <div *ngIf="dropdownStates.main" 
         class="payment-panels" 
         role="radiogroup" 
         aria-label="Opciones de pago">
      
      <!-- Complete Payment Panel -->
      <article class="payment-panel-wrapper">
        <p-panel 
          styleClass="payment-panel" 
          [ngClass]="{ 'selected': paymentType === 'complete' }"
          (click)="selectPaymentType('complete')"
          [attr.aria-selected]="paymentType === 'complete'">
          <div class="payment-option">
            <p-radioButton 
              name="paymentType" 
              value="complete" 
              [ngModel]="paymentType"
              (ngModelChange)="selectPaymentType('complete')"
              inputId="payment-complete">
            </p-radioButton>
            <label for="payment-complete" class="option-text">
              Paga tu viaje al completo
            </label>
            <span class="option-price" aria-label="Precio total">
              {{ totalPrice | currencyFormat }}
            </span>
          </div>
        </p-panel>
      </article>

      <!-- Deposit Payment Panel -->
      <article class="payment-panel-wrapper" *ngIf="shouldShowDepositOption">
        <p-panel 
          styleClass="payment-panel"
          [ngClass]="{ 'selected': paymentType === 'deposit' }" 
          (click)="selectPaymentType('deposit')"
          [attr.aria-selected]="paymentType === 'deposit'">
          <div class="payment-option">
            <p-radioButton 
              name="paymentType" 
              value="deposit" 
              [ngModel]="paymentType"
              (ngModelChange)="selectPaymentType('deposit')"
              inputId="payment-deposit">
            </p-radioButton>
            <label for="payment-deposit" class="option-text">
              Paga ahora {{ depositTotalAmount | currencyFormat }} y el resto antes del {{ paymentDeadline }}
              <small *ngIf="hasAmadeusFlight && hasSpecificSearchFlights" 
                     class="specific-search-info">
                (incluye {{ depositAmount | currencyFormat }} depósito + {{ specificSearchFlightsCost | currencyFormat }} vuelos)
              </small>
            </label>
            <span class="option-price" aria-label="Precio del depósito">
              {{ depositTotalAmount | currencyFormat }}
            </span>
          </div>
        </p-panel>
      </article>

      <!-- Installments Payment Panel -->
      <article class="payment-panel-wrapper" *ngIf="shouldShowInstallmentsOption">
        <p-panel 
          styleClass="payment-panel"
          [ngClass]="{ 'selected': paymentType === 'installments' }" 
          (click)="selectPaymentType('installments')"
          [attr.aria-selected]="paymentType === 'installments'">
          <div class="payment-option">
            <p-radioButton 
              name="paymentType" 
              value="installments" 
              [ngModel]="paymentType"
              (ngModelChange)="selectPaymentType('installments')"
              inputId="payment-installments">
            </p-radioButton>
            <label for="payment-installments" class="option-text">
              Paga a plazos
            </label>
            <div class="scalapay-widget-container" aria-label="Widget de pago fraccionado Scalapay">
              <div id="price-container-main" style="display: none;" aria-hidden="true">
                {{ totalPrice | currencyFormat }}
              </div>
              <scalapay-widget 
                merchant-token="9MFV6DMBA" 
                amount-selectors='["#price-container-main"]' 
                channel="travel"
                type="checkout"
                environment="integration"
                locale="es"
                currency-display="symbol">
              </scalapay-widget>
            </div>
          </div>
        </p-panel>
      </article>
    </div>
  </section>

  <!-- Payment Methods Section -->
  <section *ngIf="paymentType === 'complete' || paymentType === 'deposit'" 
           class="payment-methods-section"
           aria-labelledby="payment-methods-title">
    <header class="section-header" (click)="toggleDropdown('paymentMethods')">
      <div class="title-with-icon">
        <h3 id="payment-methods-title" class="title">Selecciona el método de pago</h3>
        <i class="pi" 
           [ngClass]="dropdownStates.paymentMethods ? 'pi-chevron-up' : 'pi-chevron-down'"
           aria-hidden="true"></i>
      </div>
      <div class="title-underline pay"></div>
    </header>

    <div *ngIf="dropdownStates.paymentMethods" 
         class="payment-methods-row"
         role="radiogroup"
         aria-label="Métodos de pago disponibles">
      
      <!-- Credit Card Method -->
      <article class="payment-method-container">
        <p-panel 
          styleClass="payment-panel payment-method-panel"
          [ngClass]="{ selected: paymentMethod === 'creditCard' }" 
          (click)="selectPaymentMethod('creditCard')"
          [attr.aria-selected]="paymentMethod === 'creditCard'">
          <div class="payment-option">
            <p-radioButton 
              name="paymentMethod" 
              value="creditCard" 
              [ngModel]="paymentMethod"
              (ngModelChange)="selectPaymentMethod('creditCard')"
              inputId="method-credit-card">
            </p-radioButton>
            <label for="method-credit-card" class="option-text">
              Tarjeta bancaria
            </label>
          </div>
        </p-panel>
      </article>

      <!-- Bank Transfer Method -->
      <article class="payment-method-container" *ngIf="shouldShowTransferOption">
        <p-panel 
          styleClass="payment-panel payment-method-panel" 
          [ngClass]="{ selected: paymentMethod === 'transfer' }"
          (click)="selectPaymentMethod('transfer')"
          [attr.aria-selected]="paymentMethod === 'transfer'">
          <div class="payment-option">
            <p-radioButton 
              name="paymentMethod" 
              value="transfer" 
              [ngModel]="paymentMethod"
              (ngModelChange)="selectPaymentMethod('transfer')"
              inputId="method-transfer">
            </p-radioButton>
            <label for="method-transfer" class="option-text">
              Transferencia bancaria
            </label>
          </div>
        </p-panel>
      </article>

      <!-- Flight Search Info Panel -->
      <aside class="payment-method-container info-panel" 
             *ngIf="hasAmadeusFlight"
             role="note"
             aria-label="Información sobre métodos de pago para vuelos">
        <p-panel styleClass="payment-panel payment-method-panel info-panel">
          <div class="payment-option info-content">
            <i class="pi pi-info-circle" aria-hidden="true"></i>
            <div class="info-text">
              <strong>Para vuelos de búsqueda directa:</strong>
              <ul>
                <li>Pago completo: Tarjeta bancaria o Scalapay</li>
                <li>Pago parcial: Tarjeta bancaria (depósito + vuelos de specific-search)</li>
              </ul>
            </div>
          </div>
        </p-panel>
      </aside>
    </div>
  </section>

  <!-- Installments Section (Currently disabled) -->
  <!-- 
  TODO: Esta sección está deshabilitada hasta nueva implementación
  <section *ngIf="paymentType === 'installments'" 
           class="installments-section"
           aria-labelledby="installments-title">
    <header class="section-header" (click)="toggleDropdown('installments')">
      <div class="title-with-icon">
        <h3 id="installments-title" class="title">Selecciona el plazo de pagos</h3>
        <i class="pi" 
           [ngClass]="dropdownStates.installments ? 'pi-chevron-up' : 'pi-chevron-down'"
           aria-hidden="true"></i>
      </div>
      <div class="title-underline"></div>
    </header>

    <div *ngIf="dropdownStates.installments" 
         class="installment-panels-row"
         role="radiogroup"
         aria-label="Opciones de plazos de pago">
      [Installments content would go here]
    </div>
  </section>
  -->

  <!-- Points Redemption Section -->
  <section class="points-section" aria-label="Sección de canje de puntos">
    <app-points-redemption
      [reservationId]="reservationId"
      [travelers]="travelers"
      [totalPrice]="totalPrice"
      [depositAmount]="depositAmount"
      [paymentType]="paymentState.type"
      (pointsDiscountChange)="onPointsDiscountChange($event)"
      (redemptionEnabledChange)="onRedemptionEnabledChange($event)">
    </app-points-redemption>
  </section>

  <!-- Action Buttons -->
  <footer class="buttons-container" role="toolbar" aria-label="Botones de acción">
    <p-button 
      label="Regresar" 
      severity="secondary" 
      icon="pi pi-arrow-left" 
      styleClass="back-button"
      [disabled]="isLoading" 
      (click)="goBack()"
      type="button"
      [attr.aria-label]="'Regresar al paso anterior' + (isLoading ? ' (deshabilitado)' : '')">
    </p-button>

    <p-button 
      [label]="buttonLabel" 
      styleClass="payment-button" 
      [disabled]="isLoading || !isPaymentValid"
      (click)="submitPayment()"
      type="button"
      [attr.aria-label]="buttonLabel + (isLoading || !isPaymentValid ? ' (deshabilitado)' : '')">
    </p-button>
  </footer>

  <!-- Price Change Dialog -->
  <p-dialog 
    [(visible)]="showPriceChangeDialog" 
    header="Precio del vuelo cambiado" 
    [modal]="true" 
    [closable]="false"
    styleClass="price-change-dialog"
    role="alertdialog"
    aria-labelledby="price-change-title"
    aria-describedby="price-change-description">

    <div class="price-change-content">
      <div class="price-change-icon" aria-hidden="true">
        <i class="pi pi-exclamation-triangle"></i>
      </div>

      <h3 id="price-change-title">El precio del vuelo ha cambiado</h3>

      <div class="price-details" *ngIf="priceValidation" role="table" aria-label="Detalles del cambio de precio">
        <div class="price-row" role="row">
          <span class="price-label" role="cell">Precio anterior:</span>
          <span class="price-value previous-price" role="cell" [attr.aria-label]="'Precio anterior: ' + (priceValidation.previousPrice | currency:'EUR':'symbol':'1.2-2')">
            {{ priceValidation.previousPrice | currency:'EUR':'symbol':'1.2-2' }}
          </span>
        </div>

        <div class="price-row" role="row">
          <span class="price-label" role="cell">Precio actual:</span>
          <span class="price-value current-price" role="cell" [attr.aria-label]="'Precio actual: ' + (priceValidation.currentPrice | currency:'EUR':'symbol':'1.2-2')">
            {{ priceValidation.currentPrice | currency:'EUR':'symbol':'1.2-2' }}
          </span>
        </div>

        <div class="price-row" role="row">
          <span class="price-label" role="cell">Diferencia:</span>
          <span class="price-value difference-price" 
                role="cell"
                [ngClass]="priceValidation.isPriceIncrease ? 'increase' : 'decrease'"
                [attr.aria-label]="(priceValidation.isPriceIncrease ? 'Aumento de ' : 'Descuento de ') + (priceValidation.priceDifference | currency:'EUR':'symbol':'1.2-2')">
            {{ priceValidation.isPriceIncrease ? '+' : '' }}{{ priceValidation.priceDifference | currency:'EUR':'symbol':'1.2-2' }}
          </span>
        </div>
      </div>

      <p id="price-change-description" class="price-change-message">
        El precio del vuelo seleccionado ha cambiado desde su búsqueda.<br>
        ¿Desea continuar con el nuevo precio o volver a seleccionar un vuelo?
      </p>
    </div>

    <ng-template #footer>
      <div class="dialog-footer" role="group" aria-label="Opciones de respuesta">
        <p-button 
          label="Volver a seleccionar vuelo" 
          severity="secondary" 
          icon="pi pi-arrow-left"
          (click)="handlePriceChangeDecision(false)"
          type="button"
          aria-label="Volver a la selección de vuelos para elegir uno diferente">
        </p-button>

        <p-button 
          label="Continuar con nuevo precio" 
          severity="success" 
          icon="pi pi-check"
          (click)="handlePriceChangeDecision(true)"
          type="button"
          aria-label="Aceptar el nuevo precio y continuar con el pago">
        </p-button>
      </div>
    </ng-template>
  </p-dialog>
</div>