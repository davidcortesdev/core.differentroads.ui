<!-- Mensaje informativo 3% según especificaciones -->
<div class="points-info-message">
    <div class="info-content">
        <p class="info-title">¡Gana puntos en cada viaje!</p>
        <p class="info-text">Obtienes el <strong>3% del importe</strong> de tu viaje en puntos que podrás canjear en futuras reservas.</p>
    </div>
</div>

<!-- Points Redemption Section -->
<div *ngIf="pointsSummary && pointsSummary.availablePoints > 0" class="container">
  <div class="header-container" (click)="toggleExpansion()">
    <div class="title-with-icon">
      <span class="title">Canje de puntos</span>
      <i class="pi" [ngClass]="isExpanded ? 'pi-chevron-up' : 'pi-chevron-down'"></i>
    </div>
    <div class="title-underline"></div>
  </div>

  <div *ngIf="isExpanded" class="points-redemption-content">
    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-container">
      <p-progressSpinner></p-progressSpinner>
      <p>Cargando información de puntos...</p>
    </div>

    <!-- Points Balance Info -->
    <div *ngIf="!isLoading" class="balance-card">
      <div class="balance-header">
        <span>Tu saldo de puntos</span>
      </div>
      
      <div class="balance-details">
        <div class="points-amount">{{ getAvailablePoints() }} puntos</div>
        <div class="points-value">({{ getAvailablePoints() | currency:'EUR':'symbol':'1.2-2' }})</div>
      </div>
      
      <div class="category-info">
        <p-tag [value]="getCategoryDisplayName()" 
               [icon]="getCategoryIcon()" 
               [severity]="getCategoryBadgeClass()">
        </p-tag>
        <span class="max-discount">Máximo: {{ getMaxDiscountForCategory() | currency:'EUR':'symbol':'1.2-2' }}</span>
      </div>
      
      <!-- Progress to next category -->
      <div *ngIf="pointsSummary?.nextCategory" class="progress-section">
        <div class="progress-info">
          <span class="progress-text">{{ getProgressText() }}</span>
          <p-progressBar [value]="getProgressPercentage()" 
                         [showValue]="false"
                         styleClass="category-progress">
          </p-progressBar>
        </div>
      </div>
    </div>

    <!-- Points Redemption Toggle -->
    <div class="redemption-toggle" *ngIf="!isLoading">
      <p-checkbox 
        [ngModel]="pointsRedemption.enabled"
        (onChange)="onPointsRedemptionChange($event)"
        [binary]="true"
        inputId="points-redemption-toggle">
      </p-checkbox>
      <label for="points-redemption-toggle" class="toggle-label">
        Usar puntos para descuento
      </label>
    </div>

    <!-- Points Input (only when enabled) -->
    <div *ngIf="pointsRedemption.enabled && !isLoading" 
         class="points-input-card">
      
      <div class="input-group">
        <label for="points-input" class="input-label">
          Puntos a canjear (máximo {{ getMaxAllowedPoints() }})
        </label>
        <div class="input-with-button">
          <p-inputNumber 
            id="points-input"
            [(ngModel)]="pointsRedemption.totalPointsToUse"
            (ngModelChange)="updatePointsToUse($event)"
            [max]="getMaxAllowedPoints()"
            [min]="0"
            [showButtons]="true"
            buttonLayout="horizontal" 
            inputId="horizontal" 
            spinnerMode="horizontal"
            [useGrouping]="false"
            placeholder="0"
            [class.error]="pointsRedemption.totalPointsToUse > getMaxAllowedPoints()"
            styleClass="points-input">
            <ng-template #incrementbuttonicon>
                <span class="pi pi-plus"></span>
            </ng-template>
            <ng-template #decrementbuttonicon>
                <span class="pi pi-minus"></span>
            </ng-template>
          </p-inputNumber>
          <p-button 
            label="Máximo" 
            size="small" 
            severity="secondary"
            (onClick)="setMaximumPoints()">
          </p-button>
        </div>
      </div>

      <!-- Points Distribution Section -->
      <div *ngIf="travelers.length > 0" class="distribution-header">
        <h4>Distribución de puntos por viajero</h4>
        <div class="distribution-actions">
          <p-button 
            label="Equitativo" 
            size="small" 
            severity="secondary"
            icon="pi pi-users"
            (onClick)="distributePointsEqually()">
          </p-button>
        </div>
      </div>

      <!-- Lista de viajeros rediseñada -->
      <div *ngFor="let traveler of travelers; let i = index" 
           class="traveler-card"
           [class.traveler-disabled]="!traveler.hasEmail">
        
        <!-- Header del viajero -->
        <div class="traveler-header">
          <div class="traveler-info">
            <i class="pi pi-user traveler-icon"></i>
            <div class="traveler-details">
              <div class="traveler-name">{{ traveler.name }}</div>
              <div class="traveler-email" *ngIf="traveler.hasEmail">{{ traveler.email }}</div>
            </div>
          </div>
          <p-tag *ngIf="!traveler.hasEmail" 
                 value="Sin email" 
                 severity="warning" 
                 size="small">
          </p-tag>
        </div>

        <!-- Sección de puntos -->
        <div class="points-section">
          <!-- Para viajeros con email -->
          <div *ngIf="traveler.hasEmail" class="points-input-container">
            <label class="points-label">Puntos asignados:</label>
            <div class="points-input-wrapper">
              <p-inputNumber 
                [ngModel]="getTravelerAssignedPoints(traveler.id)"
                (ngModelChange)="assignPointsToTraveler(traveler.id, +$event)"
                [max]="getTravelerMaxPoints(traveler.id)"
                [min]="0"
                [showButtons]="true"
                buttonLayout="horizontal"
                inputId="horizontal"
                [useGrouping]="false"
                [class.error]="!canAssignPointsToTraveler(traveler.id, getTravelerAssignedPoints(traveler.id)) || getTravelerAssignedPoints(traveler.id) > getTravelerMaxPoints(traveler.id)"
                styleClass="points-input">
                <ng-template #incrementbuttonicon>
                    <span class="pi pi-plus"></span>
                </ng-template>
                <ng-template #decrementbuttonicon>
                    <span class="pi pi-minus"></span>
                </ng-template>
              </p-inputNumber>
              <span class="max-indicator">/ {{ getTravelerMaxPointsDisplay(traveler.id) }}</span>
            </div>
          </div>
          
          <!-- Para viajeros sin email -->
          <div *ngIf="!traveler.hasEmail" class="blocked-section">
            <div class="blocked-message">
              <i class="pi pi-lock"></i>
              <span>Bloqueado - Sin email asignado</span>
            </div>
            <p-message severity="info" [closable]="false">
              <ng-template pTemplate>
                <span>Este viajero no puede recibir puntos porque no tiene email configurado</span>
              </ng-template>
            </p-message>
          </div>
          
          <!-- Descuento solo para viajeros con email -->
          <div *ngIf="traveler.hasEmail" class="discount-display">
            <p-tag [value]="'Descuento: ' + (getTravelerAssignedPoints(traveler.id) | currency:'EUR':'symbol':'1.2-2')" 
                   severity="success">
            </p-tag>
          </div>
          
          <!-- Error message solo para viajeros con email -->
          <p-message *ngIf="traveler.hasEmail && (!canAssignPointsToTraveler(traveler.id, getTravelerAssignedPoints(traveler.id)) || getTravelerAssignedPoints(traveler.id) > getTravelerMaxPoints(traveler.id)) && getTravelerAssignedPoints(traveler.id) > 0"
                     severity="warn"
                     [closable]="false">
            <ng-template pTemplate>
              <span>Límite excedido (máximo: {{ getTravelerMaxPointsDisplay(traveler.id) }} puntos)</span>
            </ng-template>
          </p-message>
        </div>
      </div>

        <!-- Global Error Message -->
        <p-message *ngIf="isTotalExceeded()" 
                   severity="error" 
                   [closable]="false"
                   styleClass="global-error">
          <ng-template pTemplate>
            <span>El total de puntos asignados ({{ getPointsDistributionSummary().totalPoints }}) excede el máximo disponible ({{ getMaxAllowedPoints() }})</span>
          </ng-template>
        </p-message>

        <!-- Distribution Summary -->
        <div class="distribution-summary-card">
          <div class="card-header">
            <i class="pi pi-chart-bar"></i>
            <span>Resumen de distribución</span>
          </div>
          
          <div class="summary-grid">
            <div class="summary-item">
              <span class="summary-label">Total puntos asignados:</span>
              <p-tag [value]="getPointsDistributionSummary().totalPoints.toString()" 
                     [severity]="isTotalExceeded() ? 'danger' : 'info'">
              </p-tag>
            </div>
            <div class="summary-item">
              <span class="summary-label">Máximo disponible:</span>
              <p-tag [value]="getMaxAllowedPoints().toString()" severity="secondary">
              </p-tag>
            </div>
            <div class="summary-item">
              <span class="summary-label">Viajeros con puntos:</span>
              <p-tag [value]="getPointsDistributionSummary().travelersWithPoints.toString()" severity="success">
              </p-tag>
            </div>
            <div class="summary-item">
              <span class="summary-label">Puntos al titular:</span>
              <p-tag [value]="getPointsDistributionSummary().mainTravelerPoints.toString()" severity="warning">
              </p-tag>
            </div>
          </div>
        </div>

        <!-- Redemption Summary -->
        <div *ngIf="pointsRedemption.enabled && pointsRedemption.totalPointsToUse > 0" 
             class="redemption-summary-card">
          <div class="summary-header">
            <i class="pi pi-check-circle"></i>
            <span>Resumen de canje de puntos</span>
          </div>
          
          <div class="summary-content">
            <div class="summary-row">
              <span class="summary-label">Total de puntos a canjear:</span>
              <p-tag [value]="getRedemptionSummary().totalPoints + ' puntos'" severity="info">
              </p-tag>
            </div>
            <div class="summary-row">
              <span class="summary-label">Descuento total:</span>
              <p-tag [value]="getRedemptionSummary().totalPoints | currency:'EUR':'symbol':'1.2-2'" severity="success">
              </p-tag>
            </div>
            <div class="summary-row" *ngIf="getRedemptionSummary().travelersWithPoints > 1">
              <span class="summary-label">Distribución entre viajeros:</span>
              <p-tag [value]="getRedemptionSummary().travelersWithPoints + ' viajeros'" severity="warning">
              </p-tag>
            </div>
          </div>
        </div>
    </div>
  </div>
</div>
