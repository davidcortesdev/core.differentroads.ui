<div class="checkout">
  <p-toast></p-toast>
  <h2 class="checkout-title">
    {{ tourName }}
  </h2>
  <p class="checkout-subtitle">
    {{ tourDates }}
  </p>
  <div class="checkout-container">
    <!-- Left and Center columns with steps -->
    <div class="main-content">
      <div class="steps-container">
        <p-stepper [value]="currentStep" [linear]="false">
          <p-step-list>
            <p-step [value]="1">Personaliza tu viaje</p-step>
            <p-step [value]="2">Vuelos</p-step>
            <p-step [value]="3">Viajeros</p-step>
            <p-step [value]="4">Pago</p-step>
          </p-step-list>

          <p-step-panels>
            <p-step-panel [value]="1">
              <ng-template #content let-activateCallback="activateCallback">
                <app-customize-trip
                  *ngIf="orderDetails && prices"
                  [orderDetails]="orderDetails"
                  [prices]="prices"
                ></app-customize-trip>
                <div class="flex pt-6 justify-end">
                  <p-button
                    class="next"
                    label="Continuar"
                    icon="pi pi-arrow-right"
                    iconPos="right"
                    (onClick)="nextStep(2) && activateCallback(2)"
                  />
                </div>
                <div class="flex pt-6 justify-end">
                  <p-button class="file" iconPos="right" (onClick)="saveTrip()">
                    <ng-template pTemplate="content">
                      <div class="title">
                        <div>Guarda este viaje</div>
                        <div class="description">
                          Sujeto a disponibilidad en el momento de la reserva y
                          s√≥lo para salidas con stock
                        </div>
                      </div>
                    </ng-template>
                  </p-button>
                </div>
              </ng-template>
            </p-step-panel>
            <p-step-panel [value]="2">
              <ng-template #content let-activateCallback="activateCallback">
                <app-flights
                  *ngIf="orderDetails && prices"
                  [orderDetails]="orderDetails"
                ></app-flights>
                <div class="flight">
                  <p-button
                    label="Regresar"
                    severity="secondary"
                    icon="pi pi-arrow-left"
                    (onClick)="activateCallback(1)"
                  />
                  <p-button
                    class="whith-flight"
                    *ngIf="flightlessOption"
                    label="Continuar sin vuelos"
                    (onClick)="
                      selectFlightlessAndContinue() &&
                        nextStep(3) &&
                        activateCallback(3)
                    "
                  ></p-button>
                  <p-button
                    label="Continuar"
                    icon="pi pi-arrow-right"
                    iconPos="right"
                    (onClick)="nextStep(3) && activateCallback(3)"
                    [disabled]="
                      !selectedFlight ||
                      selectedFlight.name.toLowerCase().includes('sin ')
                    "
                  ></p-button>
                </div>
              </ng-template>
            </p-step-panel>
            <p-step-panel [value]="3">
              <ng-template #content let-activateCallback="activateCallback">
                <app-travelers></app-travelers>
                <div class="flex pt-6 justify-between">
                  <p-button
                    label="Regresar"
                    severity="secondary"
                    icon="pi pi-arrow-left"
                    (onClick)="activateCallback(2)"
                  />
                  <p-button
                    label="Continuar"
                    icon="pi pi-arrow-right"
                    iconPos="right"
                    (onClick)="nextStep(4) && activateCallback(4)"
                  />
                </div>
              </ng-template>
            </p-step-panel>
            <p-step-panel [value]="4">
              <ng-template #content let-activateCallback="activateCallback">
                <app-payment
                  [totalPrice]="total"
                  [processBooking]="processBooking.bind(this)"
                  (goBackEvent)="activateCallback(3)"
                ></app-payment>
                <!-- Remove the separate button row since it's now in the payment component -->
              </ng-template>
            </p-step-panel>
          </p-step-panels>
        </p-stepper>
      </div>
    </div>

    <!-- Right column - Order Summary and Discount Code -->
    <div class="right-column">
      <!-- Order Summary Section -->
      <div class="order-summary">
        <h3>Resumen del pedido</h3>
        <div class="summary-content">
          <!-- Tour base info -->
          <div class="tour-base-info">
            <!-- Selected items list -->
            <div class="selected-items">
              <div *ngFor="let item of summary" class="item">
                <span>{{ item.description }}</span>
                <span *ngIf="item.value">
                  <span>{{ item.qty }}</span>
                  <span>x</span>
                  <span>{{ item.value | currencyFormat : "EUR" }}</span>
                  <span>=</span>
                  <span>{{
                    item.value * item.qty | currencyFormat : "EUR"
                  }}</span>
                </span>
                <span *ngIf="!item.value">
                  <span></span>
                  <span></span>
                  <span></span>
                  <span></span>
                  <span>incluido</span>
                </span>
              </div>
            </div>

            <!-- Total section -->
            <div class="total-section">
              <!-- Remove the separate discount row since it's now in the summary -->
              <div class="total">
                <span>Total</span>
                <span>{{ total | currencyFormat : "EUR" }}</span>
              </div>
            </div>

            <!-- Flights info if selected -->
            <div
              class="flights-info"
              *ngIf="
                selectedFlight &&
                !selectedFlight?.name?.toLowerCase()?.includes('sin ')
              "
            >
              <h4>Vuelos</h4>
              <div class="flight-details">
                <!-- outbound -->
                <div
                  *ngFor="
                    let segment of selectedFlight?.outbound?.segments;
                    let idx = index
                  "
                  class="itinerary-flight"
                >
                  <ng-container *ngIf="idx === 0">
                    <div class="itinerary-flight-date">
                      <span>IDA</span>
                      <span class="itinerary-flight-date-line"></span>
                      <i class="icon icon-navigate_next font-xl"></i>
                      <span>{{
                        selectedFlight.outbound.date | date : "dd/MM/yyyy"
                      }}</span>
                    </div>
                    <div class="itinerary-flight-scale">
                      <span *ngIf="selectedFlight?.outbound?.segments">
                        {{
                          selectedFlight.outbound.segments.length > 1
                            ? selectedFlight.outbound.segments.length -
                              1 +
                              " escala"
                            : "Vuelo directo"
                        }}
                      </span>
                    </div>
                  </ng-container>
                  <div class="itinerary-flight-wrap">
                    <div class="itinerary-flight-departure">
                      <span>{{ segment.departureTime }}</span>
                      <span
                        >{{ segment.departureCity }} ({{
                          segment.departureIata
                        }})</span
                      >
                    </div>
                    <span><i class="icon icon-navigate_next"></i></span>
                    <div class="itinerary-flight-arrival">
                      <span>{{ segment.arrivalTime }}</span>
                      <span
                        >{{ segment.arrivalCity }} ({{
                          segment.arrivalIata
                        }})</span
                      >
                    </div>
                  </div>
                </div>
                <!-- inbound -->
                <div
                  *ngFor="
                    let segment of selectedFlight?.inbound?.segments;
                    let idx = index
                  "
                  class="itinerary-flight"
                >
                  <ng-container *ngIf="idx === 0">
                    <div class="itinerary-flight-date inbound">
                      <span>VUELTA</span>
                      <span class="itinerary-flight-date-line"></span>
                      <span>{{
                        selectedFlight.inbound.date | date : "dd/MM/yyyy"
                      }}</span>
                    </div>
                    <div class="itinerary-flight-scale">
                      <span *ngIf="selectedFlight?.inbound?.segments">
                        {{
                          selectedFlight.inbound.segments.length > 1
                            ? selectedFlight.inbound.segments.length -
                              1 +
                              " escala"
                            : "Vuelo directo"
                        }}
                      </span>
                    </div>
                  </ng-container>
                  <div class="itinerary-flight-wrap">
                    <div class="itinerary-flight-departure">
                      <span>{{ segment.departureTime }}</span>
                      <span
                        >{{ segment.departureCity }} ({{
                          segment.departureIata
                        }})</span
                      >
                    </div>
                    <span><i class="icon icon-navigate_next"></i></span>
                    <div class="itinerary-flight-arrival">
                      <span>{{ segment.arrivalTime }}</span>
                      <span
                        >{{ segment.arrivalCity }} ({{
                          segment.arrivalIata
                        }})</span
                      >
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Update app-discount-code to handle the new event signature -->
      <app-discount-code
        [orderTotal]="subtotal"
        [existingDiscount]="discountInfo"
        (discountApplied)="handleDiscountApplied($event)"
      >
      </app-discount-code>
    </div>
  </div>

  <!-- Update the budget dialog -->
  <p-dialog
    [(visible)]="budgetDialogVisible"
    [modal]="true"
    [breakpoints]="{ '1199px': '80vw', '575px': '90vw' }"
    [style]="{ width: '50vw' }"
    [draggable]="false"
    [resizable]="false"
    class=""
  >
    <app-budget-dialog
      [visible]="budgetDialogVisible"
      [handleCloseModal]="handleCloseBudgetDialog.bind(this)"
      (close)="handleCloseBudgetDialog()"
      [existingOrderId]="orderDetails?._id ?? null"
      [tourName]="tourName"
      [periodName]="periodData.name"
      [periodDates]="tourDates"
      [departureCity]="selectedFlight?.name || 'Sin vuelos'"
      [tripType]="'Circuito'"
      [travelersCount]="{
        adults: travelersSelected.adults,
        children: travelersSelected.childs,
        babies: travelersSelected.babies
      }"
      [periodId]="periodID"
    ></app-budget-dialog>
  </p-dialog>
</div>
