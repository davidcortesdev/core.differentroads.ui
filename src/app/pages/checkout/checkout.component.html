<div class="checkout">
  <h2 class="checkout-title">
    {{ tourName }}
  </h2>
  <p class="checkout-subtitle">
    {{ tourDates }}
  </p>
  <div class="checkout-container">
    <!-- Left and Center columns with steps -->
    <div class="main-content">
      <div class="steps-container full-width">
        <!-- Ubicando el p-steps donde estaba originalmente pero con clase full-width -->
        <p-steps [model]="items" [readonly]="false" [activeIndex]="activeIndex" (activeIndexChange)="onActiveIndexChange($event)"></p-steps>
        
        <div [ngSwitch]="activeIndex">
          <!-- Step 1: Customize Trip -->
          <div *ngSwitchCase="0">
            <app-customize-trip
              *ngIf="orderDetails && prices"
              [orderDetails]="orderDetails"
              [prices]="prices"
            ></app-customize-trip>
            <div class="flex pt-6 justify-end">
              <p-button
                class="next"
                label="Continuar"
                icon="pi pi-arrow-right"
                iconPos="right"
                (onClick)="nextStepWithValidation(1)"
              ></p-button>
            </div>
            <div class="flex pt-6 justify-end">
              <p-button class="file" iconPos="right" (onClick)="saveTrip()">
                <ng-template pTemplate="content">
                  <div class="title">
                    <div>Guarda este viaje</div>
                    <div class="description">
                      Sujeto a disponibilidad en el momento de la reserva y
                      s√≥lo para salidas con stock
                    </div>
                  </div>
                </ng-template>
              </p-button>
            </div>
          </div>
          
          <!-- Step 2: Flights -->
          <div *ngSwitchCase="1">
            <app-flights
              *ngIf="orderDetails && prices"
              [orderDetails]="orderDetails"
            ></app-flights>
            <div class="flight-buttons">
              <p-button
                class="without-flight"
                *ngIf="flightlessOption"
                label="Lo quiero sin vuelos"
                (onClick)="selectFlightlessAndContinue() && nextStepWithValidation(2)"
              ></p-button>
              <p-button
                class="continue-button"
                label="Continuar"
                icon="pi pi-arrow-right"
                iconPos="right"
                (onClick)="nextStepWithValidation(2)"
                [disabled]="
                  !selectedFlight ||
                  selectedFlight.name.toLowerCase().includes('sin ')
                "
              ></p-button>
            </div>
          </div>
          
          <!-- Step 3: Travelers -->
          <div *ngSwitchCase="2">
            <app-travelers></app-travelers>
            <div class="flex pt-6 justify-between">
              <p-button
                label="Continuar"
                icon="pi pi-arrow-right"
                iconPos="right"
                (onClick)="nextStepWithValidation(3)"
              ></p-button>
            </div>
          </div>
          
          <!-- Step 4: Payment -->
          <div *ngSwitchCase="3">
            <app-payment
              [totalPrice]="total"
              [processBooking]="processBooking.bind(this)"
              [departureDate]="periodData.dayOne || null"
              (goBackEvent)="onActiveIndexChange(2)"
            ></app-payment>
          </div>
        </div>
      </div>
    </div>

    <!-- Right column - Order Summary and Discount Code -->
    <div class="right-column">
      <!-- Order Summary Section -->
      <div class="order-summary">
        <h3>Resumen del pedido</h3>
        <div class="summary-content">
          <!-- Tour base info -->
          <div class="tour-base-info">
            <!-- Selected items list -->
            <div class="selected-items">
              <div *ngFor="let item of summary" class="item">
                <span>{{ item.description }}</span>
                <span *ngIf="item.value">
                  <span>{{ item.qty }}</span>
                  <span>x</span>
                  <span>{{ item.value | currencyFormat : "EUR" }}</span>
                  <span>=</span>
                  <span>{{
                    item.value * item.qty | currencyFormat : "EUR"
                  }}</span>
                </span>
                <span *ngIf="!item.value">
                  <span></span>
                  <span></span>
                  <span></span>
                  <span></span>
                  <span>incluido</span>
                </span>
              </div>
            </div>

            <!-- Total section -->
            <div class="total-section">
              <div class="total">
                <span>Total</span>
                <span>{{ total | currencyFormat : "EUR" }}</span>
              </div>
            </div>

            <!-- Flights info if selected -->
            <div
              class="flights-info"
              *ngIf="
                selectedFlight &&
                !selectedFlight?.name?.toLowerCase()?.includes('sin ')
              "
            >
              <h4>Vuelos</h4>
              <div class="flight-details">
                <!-- outbound -->
                <div
                  *ngFor="
                    let segment of selectedFlight?.outbound?.segments;
                    let idx = index
                  "
                  class="itinerary-flight"
                >
                  <ng-container *ngIf="idx === 0">
                    <div class="itinerary-flight-date">
                      <span>IDA</span>
                      <span class="itinerary-flight-date-line"></span>
                      <i class="icon icon-navigate_next font-xl"></i>
                      <span>{{
                        selectedFlight.outbound.date | date : "dd/MM/yyyy"
                      }}</span>
                    </div>
                    <div class="itinerary-flight-scale">
                      <span *ngIf="selectedFlight?.outbound?.segments">
                        {{
                          selectedFlight.outbound.segments.length > 1
                            ? selectedFlight.outbound.segments.length -
                              1 +
                              " escala"
                            : "Vuelo directo"
                        }}
                      </span>
                    </div>
                  </ng-container>
                  <!-- Rest of the flight details -->
                </div>
                <!-- inbound -->
                <!-- Flight details content -->
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <app-discount-code
        [orderTotal]="subtotal"
        [existingDiscount]="discountInfo"
        (discountApplied)="handleDiscountApplied($event)"
      >
      </app-discount-code>
    </div>
  </div>

  <!-- Budget dialog remains the same -->
  <p-dialog
    [(visible)]="budgetDialogVisible"
    [modal]="true"
    [breakpoints]="{ '1199px': '80vw', '575px': '90vw' }"
    [style]="{ width: '50vw' }"
    [draggable]="false"
    [resizable]="false"
    class=""
  >
    <app-budget-dialog
      [visible]="budgetDialogVisible"
      [handleCloseModal]="handleCloseBudgetDialog.bind(this)"
      (close)="handleCloseBudgetDialog()"
      [existingOrderId]="orderDetails?._id ?? null"
      [tourName]="tourName"
      [periodName]="periodData.name"
      [periodDates]="tourDates"
      [departureCity]="selectedFlight?.name || 'Sin vuelos'"
      [tripType]="'Circuito'"
      [travelersCount]="{
        adults: travelersSelected.adults,
        children: travelersSelected.childs,
        babies: travelersSelected.babies
      }"
      [periodId]="periodID"
    ></app-budget-dialog>
  </p-dialog>
</div>