<div class="checkout">
  <h2 class="checkout-title">
    {{ tourName }}
  </h2>
  <p class="checkout-subtitle">
    {{ tourDates }}
  </p>
  <div class="checkout-container">
    <!-- Left and Center columns with steps -->
    <div class="main-content">
      <div class="steps-container full-width">
        <!-- Ubicando el p-steps donde estaba originalmente pero con clase full-width -->
        <p-steps
          [model]="items"
          [readonly]="false"
          [activeIndex]="activeIndex"
          (activeIndexChange)="onActiveIndexChange($event)"
        ></p-steps>

        <div [ngSwitch]="activeIndex">
          <!-- Step 1: Customize Trip -->
          <div *ngSwitchCase="0">
            <app-customize-trip
              *ngIf="orderDetails && prices"
              [orderDetails]="orderDetails"
              [prices]="prices"
            ></app-customize-trip>
            <div class="flex pt-6 justify-end">
              <p-button
                class="next"
                label="Continuar"
                icon="pi pi-arrow-right"
                iconPos="right"
                (onClick)="nextStepWithValidation(1)"
              ></p-button>
            </div>
            <div class="flex pt-6 justify-end">
              <p-button class="file" iconPos="right" (onClick)="saveTrip()">
                <ng-template pTemplate="content">
                  <div class="title">
                    <div>Guarda este viaje</div>
                    <div class="description">
                      Sujeto a disponibilidad en el momento de la reserva y s√≥lo
                      para salidas con stock
                    </div>
                  </div>
                </ng-template>
              </p-button>
            </div>
          </div>

          <!-- Step 2: Flights -->
          <div *ngSwitchCase="1">
            <app-flights
              *ngIf="orderDetails && prices"
              [orderDetails]="orderDetails"
            ></app-flights>
            <div class="flight-buttons">
              <p-button
                class="without-flight"
                *ngIf="flightlessOption"
                label="Lo quiero sin vuelos"
                (onClick)="
                  checkAuthAndContinue(2, onActiveIndexChange.bind(this), true)
                "
              ></p-button>
              <p-button
                class="continue-button"
                label="Continuar"
                icon="pi pi-arrow-right"
                iconPos="right"
                (onClick)="
                  checkAuthAndContinue(2, onActiveIndexChange.bind(this), false)
                "
                [disabled]="
                  !selectedFlight ||
                  selectedFlight.name.toLowerCase().includes('sin ')
                "
              ></p-button>
            </div>
          </div>

          <!-- Step 3: Travelers -->
          <div *ngSwitchCase="2">
            <app-travelers></app-travelers>
            <div class="flex pt-6 justify-between">
              <p-button
                label="Continuar"
                icon="pi pi-arrow-right"
                iconPos="right"
                (onClick)="nextStepWithValidation(3)"
              ></p-button>
            </div>
          </div>

          <!-- Step 4: Payment -->
          <div *ngSwitchCase="3">
            <app-payment
              [totalPrice]="total"
              [processBooking]="processBooking.bind(this)"
              [departureDate]="periodData.dayOne || null"
              (goBackEvent)="onActiveIndexChange(2)"
            ></app-payment>
          </div>
        </div>
      </div>
    </div>

    <!-- Right column - Order Summary and Discount Code -->
    <div class="right-column">
      <!-- Order Summary Section -->
      <div class="order-summary">
        <h3>Resumen del pedido</h3>
        <div class="summary-content">
          <!-- Tour base info -->
          <div class="tour-base-info">
            <!-- Selected items list -->
            <div class="selected-items">
              <div *ngFor="let item of summary" class="item">
                <span>{{ item.description }}</span>
                <span *ngIf="item.value">
                  <span>{{ item.qty }}</span>
                  <span>x</span>
                  <span>{{ item.value | currencyFormat : "EUR" }}</span>
                  <span>=</span>
                  <span>{{
                    item.value * item.qty | currencyFormat : "EUR"
                  }}</span>
                </span>
                <span *ngIf="!item.value">
                  <span></span>
                  <span></span>
                  <span></span>
                  <span></span>
                  <span>incluido</span>
                </span>
              </div>
            </div>
            <!-- Points section -->
            <br /><br />
            <p>Acumulas {{ subtotal * 0.03 | number:'1.0-0' }} puntos con este viaje</p>
            <p-message
              severity="secondary"
              size="small"
              icon="pi pi-exclamation-circle"
              >Se genera un abono del 3% del importe del viaje en puntos a
              descontar en futuras compras para aquellos viajeros de los que se
              indique el DNI.</p-message
            >

            <!-- Total section -->
            <div class="total-section">
              <div class="total">
                <span>TOTAL</span>
                <span class="price">{{ total | currencyFormat : "EUR" }}</span>
                <span class="price">{{ subtotal | currencyFormat : "EUR" }}</span>
              </div>
            </div>
            <!-- Flights info if selected -->
            <app-flight-section
              *ngIf="
                selectedFlight &&
                !selectedFlight?.name?.toLowerCase()?.includes('sin ')
              "
              [flight]="selectedFlight"
            ></app-flight-section>
          </div>
        </div>
      </div>

      <app-discount-code
        [orderTotal]="subtotal"
        [existingDiscount]="discountInfo"
        (discountApplied)="handleDiscountApplied($event)"
      >
      </app-discount-code>
    </div>
  </div>

  <!-- Budget dialog remains the same -->
  <p-dialog
    [(visible)]="budgetDialogVisible"
    [modal]="true"
    [breakpoints]="{ '1199px': '80vw', '575px': '90vw' }"
    [style]="{ width: '50vw' }"
    [draggable]="false"
    [resizable]="false"
    class=""
  >
    <app-budget-dialog
      class="budget-dialog"
      [visible]="budgetDialogVisible"
      [handleCloseModal]="handleCloseBudgetDialog.bind(this)"
      (close)="handleCloseBudgetDialog()"
      [existingOrderId]="orderDetails?._id ?? null"
      [tourName]="tourName"
      [periodName]="periodData.name"
      [periodDates]="tourDates"
      [departureCity]="selectedFlight?.name || 'Sin vuelos'"
      [tripType]="'Circuito'"
      [travelersCount]="{
        adults: travelersSelected.adults,
        children: travelersSelected.childs,
        babies: travelersSelected.babies
      }"
      [periodId]="periodID"
    ></app-budget-dialog>
  </p-dialog>

  <!-- Add the login modal at the bottom of the template -->
  <app-login-modal
    [visible]="loginDialogVisible"
    (close)="closeLoginModal()"
    (login)="navigateToLogin()"
    (register)="navigateToRegister()"
  >
  </app-login-modal>
</div>
