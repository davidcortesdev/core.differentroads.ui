<!-- Título de salida fuera del flight-itinerary -->
<div class="flight-departure-title" *ngIf="journeys && journeys.length > 0">
  <h3>
    Salida {{ journeys[0].segments[0].departureCity }} ({{
      journeys[0].departure.iata
    }})
  </h3>
</div>

<div class="flight-itinerary">
  <div class="flight-itinerary-journey">
    <!-- Iteramos sobre cada journey (outbound e inbound) -->
    <div class="journey-item" *ngFor="let journey of journeys; let i = index; trackBy: trackByJourneyType">
      <!-- Etiqueta de IDA/VUELTA -->
      <div class="journey-direction">
        <span class="direction-text">{{i === 0 ? "IDA" : "VUELTA"}}</span>
      </div>
      
      <div class="journey-row">
        <!-- Columna izquierda - Hora y ciudad de salida -->
        <div class="journey-time-block departure">
          <span class="journey-time">
            {{isValidDate(journey.departure.time) ? (journey.departure.time | date : "HH:mm" : "UTC") : "--:--"}}
          </span>
          <span class="journey-date">
            {{isValidDate(journey.departure.date) ? (journey.departure.date | date : "dd-MM-yyyy" : "UTC") : "--/--/----"}}
          </span>
          <span class="journey-city">{{ journey.segments[0].departureCity }}</span>
        </div>
        
        <!-- Línea izquierda -->
        <div class="journey-line-left"></div>
        
        <!-- Columna central - Información de vuelo -->
        <div class="journey-info-block">
          <div class="stops-container">
            <span class="journey-stops" (click)="op.toggle($event)">
              {{ journey.stopsText || "vuelo directo" }}
            </span>
            <!-- Línea roja debajo del texto de escalas -->
            <div class="stops-underline"></div>
          </div>
          <span class="journey-airline">{{ getAirlineNamesByFlightNumbers(journey.segments) | async }}</span>
          <span class="journey-duration">{{ journey.totalDuration }}</span>
          
          <p-overlayPanel #op>
            <p class="panel-title">Detalle del vuelo</p>
            <p-timeline [value]="journey.timelineData" align="left">
              <ng-template #opposite let-item>
                <i
                  [class]="
                    item.type === 'departure' ? 'pi pi-send' : 'pi pi-map-marker'
                  "
                ></i>
              </ng-template>
              <ng-template let-item pTemplate="content">
                <span *ngIf="item.type === 'departure'">
                  {{
                    isValidDate(item.departureDateTime)
                      ? (item.departureDateTime | date : "HH:mm" : "UTC")
                      : item.departureDateTime
                      ? (item.departureDateTime.toString() | slice : 16 : 21)
                      : "--:--"
                  }}
                  {{ item.departureCity || "Unknown City" }} ({{
                    item.departureIata || "???"
                  }})
                  <br />
                  {{
                    isValidDate(item.departureDateTime)
                      ? (item.departureDateTime | date : "dd-MM-yyyy" : "UTC")
                      : (journey.departure.date | date : "dd-MM-yyyy" : "UTC")
                  }}
                   {{ item.flightNumber || "No flight number" }}
                  <!-- Añadido: Logo de aerolínea en detalles con tooltip -->
                  <img *ngIf="item.flightNumber" 
                       [src]="getAirlineLogoUrl(item.flightNumber)" 
                       class="airline-logo-small"
                       alt="Airline"
                       pTooltip="{{getAirlineNamesByFlightNumbers([{flightNumber: item.flightNumber}])}}"
                       tooltipPosition="top"
                       onerror="this.style.display='none'" />
                 
                </span>
                <span *ngIf="item.type === 'arrival'">
                  {{
                    isValidDate(item.arrivalDateTime)
                      ? (item.arrivalDateTime | date : "HH:mm" : "UTC")
                      : item.arrivalDateTime
                      ? (item.arrivalDateTime.toString() | slice : 16 : 21)
                      : "--:--"
                  }}
                  {{ item.arrivalCity || "Unknown City" }} ({{
                    item.arrivalIata || "???"
                  }})
                  <br />
                  {{
                    isValidDate(item.arrivalDateTime)
                      ? (item.arrivalDateTime | date : "dd-MM-yyyy" : "UTC")
                      : (journey.arrival.date | date : "dd-MM-yyyy" : "UTC")
                  }}
                  {{ item.flightNumber || "No flight number" }}
                  <!-- Añadido: Logo de aerolínea en detalles con tooltip -->
                  <img *ngIf="item.flightNumber" 
                       [src]="getAirlineLogoUrl(item.flightNumber)" 
                       class="airline-logo-small"
                       alt="Airline"
                       pTooltip="{{getAirlineNamesByFlightNumbers([{flightNumber: item.flightNumber}])}}"
                       tooltipPosition="top"
                       onerror="this.style.display='none'" />
                
                </span>
              </ng-template>
            </p-timeline>
          </p-overlayPanel>
        </div>
        
        <!-- Línea derecha -->
        <div class="journey-line-right"></div>
        
        <!-- Columna derecha - Hora y ciudad de llegada -->
        <div class="journey-time-block arrival">
          <span class="journey-time">
            {{isValidDate(journey.arrival.time) ? (journey.arrival.time | date : "HH:mm" : "UTC") : "--:--"}}
          </span>
          <span class="journey-date">
            {{isValidDate(journey.arrival.date) ? (journey.arrival.date | date : "dd-MM-yyyy" : "UTC") : "--/--/----"}}
          </span>
          <span class="journey-city">{{ journey.segments[journey.segments.length - 1].arrivalCity }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Bloque de precios y botón de selección -->
  <div class="flight-itinerary-price space-y-4">
    <div class="flight-itinerary-price-wrapper">
      <span class="flight-itinerary-price-wrapper-price">
        {{ getPrice() || flight.price || 0 | currencyFormat : "EUR" }}
      </span>
      <span class="flight-itinerary-price-wrapper-text">Por persona</span>
      <!-- Add message for Amadeus flights -->
      <span
        *ngIf="flight.source === 'amadeus'"
        class="flight-itinerary-price-wrapper-fee-text"
      >
        Tasas y gastos de gestión incluidos
      </span>
    </div>
    <p-button
      type="button"
      class="button-rounded is-primary px-6 py-3"
      [styleClass]="isFlightSelected(flight) ? 'selected-flight-button' : ''"
      (click)="selectFlight(flight)"
    >
      {{ isFlightSelected(flight) ? "Seleccionado" : "Seleccionar" }}
    </p-button>
  </div>
</div>