<div class="container">
  <div class="header-container" (click)="toggleDropdown()">
    <div class="title-with-icon">
      <span class="title">Selecciona la forma de pago</span>
      <i
        class="pi"
        [ngClass]="isOpen ? 'pi-chevron-up' : 'pi-chevron-down'"
      ></i>
    </div>
    <div class="title-underline"></div>
  </div>

  <div *ngIf="isOpen" class="payment-panels">
    <!-- Panel para pago completo - Ahora clickeable completo -->
    <p-panel styleClass="payment-panel" [ngClass]="{ 'selected': paymentType === 'complete' }" (click)="selectPaymentType('complete')">
      <div class="payment-option">
        <p-radioButton
          name="paymentType"
          value="complete"
          [(ngModel)]="paymentType"
          (onChange)="onPaymentTypeChange()"
        ></p-radioButton>
        <span class="option-text">Paga tu viaje al completo</span>
        <span class="option-price">{{ totalPrice | currencyFormat }}</span>
      </div>
    </p-panel>

    <!-- Panel para pago con depósito - Ahora clickeable completo -->
    <p-panel styleClass="payment-panel" [ngClass]="{ 'selected': paymentType === 'deposit' }" (click)="selectPaymentType('deposit')">
      <div class="payment-option">
        <p-radioButton
          name="paymentType"
          value="deposit"
          [(ngModel)]="paymentType"
          (onChange)="onPaymentTypeChange()"
        ></p-radioButton>
        <span class="option-text">
          Paga ahora {{ depositAmount | currencyFormat }} y el resto antes del
          {{ paymentDeadline }}
        </span>
        <span class="option-price">{{ depositAmount | currencyFormat }}</span>
      </div>
    </p-panel>

    <!-- Panel para pago a plazos - Ahora clickeable completo -->
    <p-panel styleClass="payment-panel" [ngClass]="{ 'selected': paymentType === 'installments' }" (click)="selectPaymentType('installments')">
      <div class="payment-option">
        <p-radioButton
          name="paymentType"
          value="installments"
          [(ngModel)]="paymentType"
          (onChange)="onPaymentTypeChange()"
        ></p-radioButton>
        <span class="option-text">Paga a plazos</span>
        <img
          src="assets/images/scalapay.svg"
          alt="ScalaPay"
          class="scalapay-logo"
        />
      </div>
    </p-panel>
  </div>

  <!-- Sección de métodos de pago para pago completo o depósito -->
  <div
    *ngIf="paymentType === 'complete' || paymentType === 'deposit'"
    class="payment-methods-section"
  >
    <div class="header-container" (click)="togglePaymentMethodsDropdown()">
      <div class="title-with-icon">
        <span class="title">Selecciona el método de pago</span>
        <i
          class="pi"
          [ngClass]="isPaymentMethodsOpen ? 'pi-chevron-up' : 'pi-chevron-down'"
        ></i>
      </div>
      <div class="title-underline pay"></div>
    </div>

    <div *ngIf="isPaymentMethodsOpen" class="payment-methods-row">
      <div class="payment-method-container">
        <!-- Panel para tarjeta bancaria - Ahora clickeable completo -->
        <p-panel
          styleClass="payment-panel payment-method-panel"
          [ngClass]="{ selected: paymentMethod === 'creditCard' }"
          (click)="selectPaymentMethod('creditCard')"
        >
          <div class="payment-option">
            <p-radioButton
              name="paymentMethod"
              value="creditCard"
              [(ngModel)]="paymentMethod"
              (onChange)="onPaymentMethodChange()"
            >
            </p-radioButton>
            <span class="option-text">Tarjeta bancaria</span>
          </div>
        </p-panel>
      </div>

      <div class="payment-method-container">
        <!-- Panel para transferencia bancaria - Ahora clickeable completo -->
        <p-panel
          styleClass="payment-panel payment-method-panel"
          [ngClass]="{ selected: paymentMethod === 'transfer' }"
          (click)="selectPaymentMethod('transfer')"
        >
          <div class="payment-option">
            <p-radioButton
              name="paymentMethod"
              value="transfer"
              [(ngModel)]="paymentMethod"
              (onChange)="onPaymentMethodChange()"
            >
            </p-radioButton>
            <span class="option-text">Transferencia bancaria</span>
          </div>
        </p-panel>
      </div>
    </div>
  </div>

  <!-- Sección de cuotas para pago a plazos -->
  <div *ngIf="paymentType === 'installments'" class="installments-section">
    <div class="header-container" (click)="toggleInstallmentsDropdown()">
      <div class="title-with-icon">
        <span class="title">Selecciona el plazo de pagos</span>
        <i
          class="pi"
          [ngClass]="isInstallmentsOpen ? 'pi-chevron-up' : 'pi-chevron-down'"
        ></i>
      </div>
      <div class="title-underline"></div>
    </div>

    <div *ngIf="isInstallmentsOpen" class="installment-panels-row">
      <div class="installment-panel-container">
        <!-- Panel para 3 cuotas - Ahora clickeable completo -->
        <p-panel
          styleClass="payment-panel installment-panel"
          [ngClass]="{ selected: installmentOption === 'three' }"
          (click)="selectInstallmentOption('three')"
        >
          <div class="payment-option">
            <p-radioButton
              name="installmentOption"
              value="three"
              [(ngModel)]="installmentOption"
              (onChange)="onInstallmentOptionChange()"
            >
            </p-radioButton>
            <div class="installment-content">
              <div class="scalapay-widget-container">
                <div id="price-container-three" style="display: none">
                  {{ totalPrice | currencyFormat }}
                </div>
                <scalapay-widget
                  channel="travel"
                  type="checkout"
                  show-title="true"
                  frequency-number="30"
                  number-of-installments="3"
                  hide="false"
                  hide-price="false"
                  min="0.01"
                  max="999999"
                  amount-selectors='["#price-container-three"]'
                  currency-position="before"
                  currency-display="symbol"
                  logo-size="100"
                  locale="es"
                >
                </scalapay-widget>
              </div>
            </div>
          </div>
        </p-panel>
      </div>

      <div class="installment-panel-container">
        <!-- Panel para 4 cuotas - Ahora clickeable completo -->
        <p-panel
          styleClass="payment-panel installment-panel"
          [ngClass]="{ selected: installmentOption === 'four' }"
          (click)="selectInstallmentOption('four')"
        >
          <div class="payment-option">
            <p-radioButton
              name="installmentOption"
              value="four"
              [(ngModel)]="installmentOption"
              (onChange)="onInstallmentOptionChange()"
            >
            </p-radioButton>
            <div class="installment-content">
              <div class="scalapay-widget-container">
                <div id="price-container-four" style="display: none">
                  {{ totalPrice | currencyFormat }}
                </div>
                <scalapay-widget
                  channel="travel"
                  type="checkout"
                  show-title="true"
                  frequency-number="30"
                  number-of-installments="4"
                  hide="false"
                  hide-price="false"
                  min="0.01"
                  max="999999"
                  amount-selectors='["#price-container-four"]'
                  currency-position="before"
                  currency-display="symbol"
                  logo-size="100"
                  locale="es"
                >
                </scalapay-widget>
              </div>
            </div>
          </div>
        </p-panel>
      </div>
    </div>
  </div>

  <!-- Make sure the travelers-points-section is properly displaying -->
  <div *ngIf="uniqueTravelers.length > 0" class="travelers-points-section">
    <p-accordion [activeIndex]="0">
      <p-accordionTab header="Puntos de viajeros">
        <div class="travelers-list">
          <div *ngFor="let traveler of uniqueTravelers" class="traveler-item">
            <div class="traveler-row">
              <!-- Checkbox container - Ahora el área clickeable incluye toda la fila -->
              <div class="checkbox-container checkbox-azul" *ngIf="(traveler.points || 0) > 0" (click)="toggleTravelerPoints(traveler)">
                <p-checkbox
                  [binary]="true"
                  [(ngModel)]="traveler.redeemCheckbox"
                  (onChange)="onRedeemCheckboxChange(traveler)"
                  styleClass="points-checkbox"
                  [disabled]="isLoading"
                ></p-checkbox>
              </div>
              <div
                *ngIf="!traveler.points || traveler.points <= 0"
                class="checkbox-placeholder"
              ></div>

              <!-- Traveler info with status indicators - Ahora también clickeable -->
              <div class="traveler-info" *ngIf="(traveler.points || 0) > 0" (click)="toggleTravelerPoints(traveler)">
                <span class="traveler-name"
                  >{{ traveler.firstName }} {{ traveler.lastName }}</span
                >
                <span>{{traveler.category}}</span>
                <span class="points-badge" *ngIf="!traveler.redeemCheckbox">
                  <span
                    class="points-label"
                    *ngIf="traveler.points && traveler.points > 0"
                  >
                    {{ traveler.points }} pts disponibles
                  </span>
                  <span
                    class="points-label"
                    *ngIf="!traveler.points || traveler.points <= 0"
                  >
                    No hay puntos disponibles
                  </span>
                </span>
                <span class="points-badge" *ngIf="traveler.redeemCheckbox">
                  <span class="points-redeemed-label">
                    {{ traveler.points || 0 }} pts aplicados
                  </span>
                </span>
              </div>
              <!-- Versión no clickeable para viajeros sin puntos -->
              <div class="traveler-info" *ngIf="!traveler.points || traveler.points <= 0">
                <span class="traveler-name"
                  >{{ traveler.firstName }} {{ traveler.lastName }}</span
                >
                <span>{{traveler.category}}</span>
                <span class="points-badge">
                  <span class="points-label">
                    No hay puntos disponibles
                  </span>
                </span>
              </div>
            </div>
          </div>
        </div>
      </p-accordionTab>
    </p-accordion>
  </div>

  <!-- The existing terms-container should come after our new section -->
  <div class="terms-container checkbox-azul">
    <p-checkbox
      [(ngModel)]="termsAccepted"
      [binary]="true"
      inputId="terms"
    ></p-checkbox>
    <label for="terms" class="terms-text">
      Acepto términos de privacidad y compra
      <div class="terms-details">
        He revisado los trayectos, itinerario y destinos de la reserva. Siendo
        estos correctos. He leído y acepto la política de privacidad,
        condiciones generales, condiciones de cancelación y las formas de pago.
      </div>
    </label>
  </div>

  <div class="buttons-container">
    <p-button
      label="Regresar"
      severity="secondary"
      icon="pi pi-arrow-left"
      styleClass="back-button"
      [disabled]="isLoading"
      (click)="goBack()"
    ></p-button>

    <p-button
      [label]="isLoading ? 'Procesando...' : 'Realizar pago'"
      styleClass="payment-button"
      [disabled]="
        isLoading ||
        !termsAccepted ||
        !paymentType ||
        ((paymentType === 'complete' || paymentType === 'deposit') &&
          !paymentMethod) ||
        (paymentType === 'installments' && !installmentOption)
      "
      (click)="submitPayment()"
    >
      <ng-template *ngIf="isLoading" pTemplate="content">
        <div class="button-content">
          <span>Procesando</span>
          <i class="pi pi-spin pi-spinner ml-2"></i>
        </div>
      </ng-template>
    </p-button>
  </div>

  <!-- Add the error dialog -->
  <p-dialog
    [(visible)]="errorDialogVisible"
    [modal]="true"
    [closable]="true"
    [draggable]="false"
    [resizable]="false"
    styleClass="flight-error-dialog"
    [style]="{ width: '450px' }"
    header="{{ errorSummary }}"
  >
    <div class="error-content">
      <i
        class="pi pi-exclamation-circle error-icon"
        style="font-size: 3rem; color: #f44336"
      ></i>
      <p>{{ errorMessage }}</p>
    </div>

    <ng-template pTemplate="footer">
      <div class="dialog-footer">
        <p-button
          *ngIf="errorType === 'traveler-data'"
          label="Ir a datos de viajeros"
          icon="pi pi-user"
          styleClass="p-button-primary"
          (onClick)="goToTravelersStep()"
        >
        </p-button>

        <p-button
          *ngIf="errorType === 'flight-selection'"
          label="Seleccionar otro vuelo"
          icon="pi pi-send"
          styleClass="p-button-primary"
          (onClick)="goToFlightsStep()"
        >
        </p-button>

        <p-button
          *ngIf="errorType === 'generic'"
          label="Cerrar"
          icon="pi pi-times"
          styleClass="p-button-secondary"
          (onClick)="closeErrorDialog()"
        >
        </p-button>
      </div>
    </ng-template>
  </p-dialog>
</div>