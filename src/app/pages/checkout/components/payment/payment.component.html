<div class="container">
  <div class="header-container" (click)="toggleDropdown()">
    <div class="title-with-icon">
      <span class="title">Selecciona la forma de pago</span>
      <i
        class="pi"
        [ngClass]="isOpen ? 'pi-chevron-up' : 'pi-chevron-down'"
      ></i>
    </div>
    <div class="title-underline"></div>
  </div>

  <div *ngIf="isOpen" class="payment-panels">
    <p-panel styleClass="payment-panel">
      <div class="payment-option">
        <p-radioButton
          name="paymentType"
          value="complete"
          [(ngModel)]="paymentType"
          (onChange)="onPaymentTypeChange()"
        ></p-radioButton>
        <span class="option-text">Paga tu viaje al completo</span>
        <span class="option-price">{{ totalPrice | currencyFormat }}</span>
      </div>
    </p-panel>

    <p-panel styleClass="payment-panel">
      <div class="payment-option">
        <p-radioButton
          name="paymentType"
          value="installments"
          [(ngModel)]="paymentType"
          (onChange)="onPaymentTypeChange()"
        ></p-radioButton>
        <span class="option-text">Paga a plazos</span>
        <img src="assets/images/scalapay.svg" alt="ScalaPay" class="scalapay-logo" />
      </div>
    </p-panel>
  </div>

  <!-- Sección de métodos de pago para pago completo -->
  <div *ngIf="paymentType === 'complete'" class="payment-methods-section">
    <div class="header-container" (click)="togglePaymentMethodsDropdown()">
      <div class="title-with-icon">
        <span class="title">Selecciona el método de pago</span>
        <i
          class="pi"
          [ngClass]="isPaymentMethodsOpen ? 'pi-chevron-up' : 'pi-chevron-down'"
        ></i>
      </div>
      <div class="title-underline pay"></div>
    </div>

    <div *ngIf="isPaymentMethodsOpen" class="payment-methods-row">
      <div class="payment-method-container">
        <p-panel
          styleClass="payment-panel payment-method-panel"
          [ngClass]="{ selected: paymentMethod === 'creditCard' }"
        >
          <div class="payment-option">
            <p-radioButton
              name="paymentMethod"
              value="creditCard"
              [(ngModel)]="paymentMethod"
              (onChange)="onPaymentMethodChange()"
            >
            </p-radioButton>
            <span class="option-text">Tarjeta bancaria</span>
          </div>
        </p-panel>
      </div>

      <div class="payment-method-container">
        <p-panel
          styleClass="payment-panel payment-method-panel"
          [ngClass]="{ selected: paymentMethod === 'transfer' }"
        >
          <div class="payment-option">
            <p-radioButton
              name="paymentMethod"
              value="transfer"
              [(ngModel)]="paymentMethod"
              (onChange)="onPaymentMethodChange()"
            >
            </p-radioButton>
            <span class="option-text">Transferencia bancaria</span>
          </div>
        </p-panel>
      </div>
    </div>
  </div>

  <!-- Sección de cuotas para pago a plazos -->
  <div *ngIf="paymentType === 'installments'" class="installments-section">
    <div class="header-container" (click)="toggleInstallmentsDropdown()">
      <div class="title-with-icon">
        <span class="title">Selecciona el plazo de pagos</span>
        <i
          class="pi"
          [ngClass]="isInstallmentsOpen ? 'pi-chevron-up' : 'pi-chevron-down'"
        ></i>
      </div>
      <div class="title-underline"></div>
    </div>

    <div *ngIf="isInstallmentsOpen" class="installment-panels-row">
      <div class="installment-panel-container">
        <p-panel
          styleClass="payment-panel installment-panel"
          [ngClass]="{ selected: installmentOption === 'three' }"
        >
          <div class="payment-option">
            <p-radioButton
              name="installmentOption"
              value="three"
              [(ngModel)]="installmentOption"
              (onChange)="onInstallmentOptionChange()"
            >
            </p-radioButton>
            <div class="installment-content">
              <div class="scalapay-widget-container">
                <div id="price-container-three" style="display: none">
                  {{ totalPrice | currencyFormat }}
                </div>
                <scalapay-widget
                  channel="travel"
                  type="checkout"
                  show-title="true"
                  frequency-number="30"
                  number-of-installments="3"
                  hide="false"
                  hide-price="false"
                  min="0.01"
                  max="999999"
                  amount-selectors='["#price-container-three"]'
                  currency-position="before"
                  currency-display="symbol"
                  logo-size="100"
                  locale="es"
                >
                </scalapay-widget>
              </div>
            </div>
          </div>
        </p-panel>
      </div>

      <div class="installment-panel-container">
        <p-panel
          styleClass="payment-panel installment-panel"
          [ngClass]="{ selected: installmentOption === 'four' }"
        >
          <div class="payment-option">
            <p-radioButton
              name="installmentOption"
              value="four"
              [(ngModel)]="installmentOption"
              (onChange)="onInstallmentOptionChange()"
            >
            </p-radioButton>
            <div class="installment-content">
              <div class="scalapay-widget-container">
                <div id="price-container-four" style="display: none">
                  {{ totalPrice | currencyFormat }}
                </div>
                <scalapay-widget
                  channel="travel"
                  type="checkout"
                  show-title="true"
                  frequency-number="30"
                  number-of-installments="4"
                  hide="false"
                  hide-price="false"
                  min="0.01"
                  max="999999"
                  amount-selectors='["#price-container-four"]'
                  currency-position="before"
                  currency-display="symbol"
                  logo-size="100"
                  locale="es"
                >
                </scalapay-widget>
              </div>
            </div>
          </div>
        </p-panel>
      </div>
    </div>
  </div>

  <div class="source-section">
    <div class="header-container">
      <div class="title-with-icon">
        <span class="title">Por último, ¿Cómo nos has conocido?</span>
      </div>
    </div>

    <div class="dropdown-container" (click)="toggleSourceDropdown($event)">
      <div class="dropdown-select">
        <span>{{ selectedSource }}</span>
        <i
          class="pi"
          [ngClass]="isSourceDropdownOpen ? 'pi-chevron-up' : 'pi-chevron-down'"
        ></i>
      </div>
      <div class="dropdown-options" *ngIf="isSourceDropdownOpen">
        <div
          *ngFor="let option of sourcesOptions"
          class="dropdown-option"
          (click)="selectSource(option, $event)"
        >
          {{ option }}
        </div>
      </div>
    </div>
  </div>

  <div class="terms-container">
    <p-checkbox
      [(ngModel)]="termsAccepted"
      [binary]="true"
      inputId="terms"
    ></p-checkbox>
    <label for="terms" class="terms-text">
      Acepto términos de privacidad y compra
      <div class="terms-details">
        He revisado los trayectos, itinerario y destinos de la reserva. Siendo
        estos correctos. He leído y acepto la política de privacidad,
        condiciones generales, condiciones de cancelación y las formas de pago.
      </div>
    </label>
  </div>

  <p-button
    label="Realizar pago"
    styleClass="payment-button"
    [disabled]="
      isLoading ||
      !termsAccepted ||
      !paymentType ||
      (paymentType === 'complete' && !paymentMethod) ||
      (paymentType === 'installments' && !installmentOption)
    "
    [ngClass]="{
      'payment-button-disabled':
        isLoading ||
        !termsAccepted ||
        !paymentType ||
        (paymentType === 'complete' && !paymentMethod) ||
        (paymentType === 'installments' && !installmentOption)
    }"
    (click)="submitPayment()"
  >
    <ng-template pTemplate="icon">
      <i *ngIf="isLoading" class="pi pi-spin pi-spinner"></i>
    </ng-template>
  </p-button>
</div>
