<div class="container">
  <div class="header-container" (click)="toggleDropdown()">
    <div class="title-with-icon">
      <span class="title">Selecciona la forma de pago</span>
      <i class="pi" [ngClass]="isOpen ? 'pi-chevron-up' : 'pi-chevron-down'"></i>
    </div>
    <div class="title-underline"></div>
  </div>

  <div *ngIf="isOpen" class="payment-panels">
    <p-panel styleClass="payment-panel">
      <div class="payment-option">
        <p-radioButton name="paymentType" value="complete" [(ngModel)]="paymentType" (onChange)="onPaymentTypeChange()"></p-radioButton>
        <span class="option-text">Paga tu viaje al completo</span>
        <span class="option-price">{{ totalPrice }}</span>
      </div>
    </p-panel>

    <p-panel styleClass="payment-panel">
      <div class="payment-option">
        <p-radioButton name="paymentType" value="installments" [(ngModel)]="paymentType" (onChange)="onPaymentTypeChange()"></p-radioButton>
        <span class="option-text">Paga a plazos</span>
        <img src="scalapay.svg" alt="ScalaPay" class="scalapay-logo"/>
      </div>
    </p-panel>
  </div>

  <div *ngIf="paymentType === 'installments'" class="installments-section">
    <div class="header-container" (click)="toggleInstallmentsDropdown()">
      <div class="title-with-icon">
        <span class="title">Selecciona el plazo de pagos</span>
        <i class="pi" [ngClass]="isInstallmentsOpen ? 'pi-chevron-up' : 'pi-chevron-down'"></i>
      </div>
      <div class="title-underline"></div>
    </div>

    <div *ngIf="isInstallmentsOpen" class="installment-panels-row">
      <div class="installment-panel-container">
        <p-panel styleClass="payment-panel installment-panel">
          <div class="payment-option installment-option">
            <p-radioButton 
              name="installmentOption" 
              value="three" 
              [(ngModel)]="installmentOption" 
              (onChange)="onInstallmentOptionChange()">
            </p-radioButton>
            <div class="installment-content">
              <div class="installment-header">
                <span>3 plazos de <strong>{{ threeInstallments }}</strong> sin intereses.</span>
                <i class="pi pi-info-circle info-icon" (click)="toggleScalapayInfo($event)"></i>
              </div>
              <div class="installment-description">
                Confirme tu reserva ahora y tómate tu tiempo para pagar las cuotas restantes
              </div>
            </div>
          </div>
        </p-panel>
      </div>

      <div class="installment-panel-container">
        <p-panel styleClass="payment-panel installment-panel">
          <div class="payment-option installment-option">
            <p-radioButton 
              name="installmentOption" 
              value="four" 
              [(ngModel)]="installmentOption" 
              (onChange)="onInstallmentOptionChange()">
            </p-radioButton>
            <div class="installment-content">
              <div class="installment-header">
                <span>4 plazos de <strong>{{ fourInstallments }}</strong> sin intereses.</span>
                <i class="pi pi-info-circle info-icon" (click)="toggleScalapayInfo($event)"></i>
              </div>
              <div class="installment-description">
                Confirme tu reserva ahora y tómate tu tiempo para pagar las cuotas restantes
              </div>
            </div>
          </div>
        </p-panel>
      </div>
    </div>
  </div>

  <div class="scalapay-widget-container mt-4" *ngIf="showScalapayInfo">
    <div id="price-container" style="display: none;">€ {{ formattedPrice }}</div>
    <scalapay-widget 
      type="product" 
      min="0.01"
      max="999999"
      frequency-number="30"
      amount-selectors='["#price-container"]' 
      currency-position="before" 
      currency-display="symbol" 
      locale="es" 
      environment="integration" 
      merchant-token="8KDS3SPEL">
    </scalapay-widget>
  </div>

  <div class="source-section">
    <div class="header-container">
      <div class="title-with-icon">
        <span class="title">Por último, ¿Cómo nos has conocido?</span>
      </div>
    </div>

    <div class="dropdown-container" (click)="toggleSourceDropdown($event)">
      <div class="dropdown-select">
        <span>{{ selectedSource }}</span>
        <i class="pi" [ngClass]="isSourceDropdownOpen ? 'pi-chevron-up' : 'pi-chevron-down'"></i>
      </div>
      <div class="dropdown-options" *ngIf="isSourceDropdownOpen">
        <div *ngFor="let option of sourcesOptions" class="dropdown-option" (click)="selectSource(option, $event)">
          {{ option }}
        </div>
      </div>
    </div>
  </div>

  <div class="terms-container">
    <p-checkbox [(ngModel)]="termsAccepted" [binary]="true" inputId="terms"></p-checkbox>
    <label for="terms" class="terms-text">
      Acepto términos de privacidad y compra
      <div class="terms-details">
        He revisado los trayectos, itinerario y destinos de la reserva. Siendo estos correctos. He leído y acepto la política de privacidad, condiciones generales, condiciones de cancelación y las formas de pago.
      </div>
    </label>
  </div>

  <p-button 
    label="Realizar pago"
    styleClass="payment-button" 
    [disabled]="!termsAccepted"
    [ngClass]="{'payment-button-disabled': !termsAccepted}">
  </p-button>
</div>