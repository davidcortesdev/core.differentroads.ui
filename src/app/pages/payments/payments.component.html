<div class="single">
  <div class="single-container">
    <div class="container">
      <div class="header-container" (click)="toggleDropdown()">
        <div class="title-icon">
          <span class="title">Selecciona la forma de pago</span>
          <i
            class="pi"
            [ngClass]="isOpen ? 'pi-chevron-up' : 'pi-chevron-down'"
          ></i>
        </div>
        <div class="title-underline"></div>
      </div>

      <div *ngIf="isOpen" class="payment-panels">
        <p-panel 
          styleClass="payment-panel" 
          [ngClass]="{ 'selected': paymentType === 'complete' }" 
          (click)="selectPaymentType('complete')"
        >
          <div class="payment-option">
            <p-radioButton
              name="paymentType"
              value="complete"
              [(ngModel)]="paymentType"
              (onChange)="onPaymentTypeChange()"
            ></p-radioButton>
            <span class="option-text">Paga tu viaje al completo</span>
            <span class="option-price">{{ remainingAmount | currencyFormat }}</span>
          </div>
        </p-panel>

        <p-panel 
          styleClass="payment-panel" 
          [ngClass]="{ 'selected': paymentType === 'deposit' }" 
          (click)="selectPaymentType('deposit')"
          *ngIf="!isLoading && depositAmount <= remainingAmount"
        >
          <div class="payment-option">
            <p-radioButton
              name="paymentType"
              value="deposit"
              [(ngModel)]="paymentType"
              (onChange)="onPaymentTypeChange()"
            ></p-radioButton>
            <span class="option-text">
              Realiza un abono al saldo pendiente
            </span>
            <span class="option-price">
              desde {{ depositAmount | currencyFormat }}</span>
          </div>
        </p-panel>
      </div>

      <!-- Sección de métodos de pago para pago completo o depósito -->
      <div
        *ngIf="paymentType === 'complete' || paymentType === 'deposit'"
        class="payment-methods-section"
      >
        <div class="header-container" (click)="togglePaymentMethodsDropdown()">
          <div class="title-icon">
            <span class="title">Selecciona el método de pago</span>
            <i
              class="pi"
              [ngClass]="
                isPaymentMethodsOpen ? 'pi-chevron-up' : 'pi-chevron-down'
              "
            ></i>
          </div>
          <div class="title-underline pay"></div>
        </div>

        <!-- Only show the input when the deposit option is selected -->
        <div *ngIf="paymentType === 'deposit'" class="form-group">
          <label for="amountToPay">Importe a abonar</label>
          <p-inputNumber
            id="amountToPay"
            [(ngModel)]="amountToPay"
            [min]="depositAmount"
            [max]="remainingAmount"
            [step]="50"
            placeholder="Ingrese el importe a abonar"
            mode="decimal"
            [showButtons]="true"
            class="form-control"
          >
          </p-inputNumber>
        </div>

        <div *ngIf="isPaymentMethodsOpen" class="payment-methods-row">
          <div class="payment-method-container">
            <p-panel
              styleClass="payment-panel payment-method-panel"
              [ngClass]="{ selected: paymentMethod === 'creditCard' }"
              (click)="selectPaymentMethod('creditCard')"
            >
              <div class="payment-option">
                <p-radioButton
                  name="paymentMethod"
                  value="creditCard"
                  [(ngModel)]="paymentMethod"
                  (onChange)="onPaymentMethodChange()"
                >
                </p-radioButton>
                <span class="option-text">Tarjeta bancaria</span>
              </div>
            </p-panel>
          </div>

          <div class="payment-method-container">
            <p-panel
              styleClass="payment-panel payment-method-panel"
              [ngClass]="{ selected: paymentMethod === 'transfer' }"
              (click)="selectPaymentMethod('transfer')"
            >
              <div class="payment-option">
                <p-radioButton
                  name="paymentMethod"
                  value="transfer"
                  [(ngModel)]="paymentMethod"
                  (onChange)="onPaymentMethodChange()"
                >
                </p-radioButton>
                <span class="option-text">Transferencia bancaria</span>
              </div>
            </p-panel>
          </div>
        </div>
      </div>

      <!-- The existing terms-container should come after our new section -->
      <div class="terms-container checkbox-azul">
        <p-checkbox
          [(ngModel)]="termsAccepted"
          [binary]="true"
          inputId="terms"
        ></p-checkbox>
        <label for="terms" class="terms-text">
          Acepto términos de privacidad y compra
          <div class="terms-details">
            He revisado los trayectos, itinerario y destinos de la reserva. Siendo
            estos correctos. He leído y acepto la política de privacidad,
            condiciones generales, condiciones de cancelación y las formas de pago.
          </div>
        </label>
      </div>

      <div class="buttons-container">
        <div></div>
        <p-button
          [label]="isLoading ? 'Procesando...' : 'Realizar pago'"
          styleClass="payment-button"
          [disabled]="
            isLoading ||
            !termsAccepted ||
            !paymentType ||
            ((paymentType === 'complete' || paymentType === 'deposit') &&
              !paymentMethod) ||
            (paymentType === 'installments' && !installmentOption)
          "
          (click)="submitPayment()"
        >
          <ng-template *ngIf="isLoading" pTemplate="content">
            <div class="button-content">
              <span>Procesando</span>
              <i class="pi pi-spin pi-spinner ml-2"></i>
            </div>
          </ng-template>
        </p-button>
      </div>
    </div>

    <!-- Order Summary Section -->
    <div class="order-summary">
      <h3>Resumen del pedido</h3>
      <div class="summary-content">
        <!-- Tour base info -->
        <div class="tour-base-info">
          <!-- Selected items list -->
          <div class="selected-items">
            <div *ngFor="let item of summary" class="item">
              <span>{{ item.description }}</span>
              <span *ngIf="item.value">
                <span>{{ item.qty }}</span>
                <span>x</span>
                <span>{{ item.value | currencyFormat : "EUR" }}</span>
                <span>=</span>
                <span>{{
                  item.value * item.qty | currencyFormat : "EUR"
                }}</span>
              </span>
              <span *ngIf="!item.value">
                <span></span>
                <span></span>
                <span></span>
                <span></span>
                <span>incluido</span>
              </span>
            </div>
            <div></div>
            <div></div>

            <div class="item">
              <span> <b>Subtotal</b></span>
              <span>
                <span></span>
                <span></span>
                <span></span>
                <span></span>
                <span>
                  <b>{{ totalPrice | currencyFormat }}</b>
                </span>
              </span>
            </div>
            <div class="item">
              <span>Total abonado</span>
              <span>
                <span></span>
                <span></span>
                <span></span>
                <span></span>
                <span>
                  <b>{{ paidAmount | currencyFormat }}</b>
                </span>
              </span>
            </div>
          </div>

          <!-- Total section -->
          <div class="total-section">
            <div class="total">
              <span>TOTAL</span>
              <span class="price">{{
                remainingAmount | currencyFormat : "EUR"
              }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>