<div class="active">
  <!-- Header with toggle functionality -->
  <div class="header" (click)="toggleContent()">
    <span>{{ getTitle() }}</span>
    <i class="pi" [ngClass]="{
      'pi-chevron-down arrow-down': !isExpanded,
      'pi-chevron-up arrow-up': isExpanded
    }"></i>
  </div>

  <!-- Collapsible content section -->
  <div class="content" [ngClass]="{ hidden: !isExpanded }">
    <!-- Loading indicator -->
    <div class="loading" *ngIf="loading">
      <p-progressSpinner strokeWidth="3" animationDuration=".5s"></p-progressSpinner>
    </div>

    <!-- Empty state message when no items are available -->
    <div class="empty" *ngIf="!loading && (!bookingItems || bookingItems.length === 0)">
      <p>{{ getEmptyMessage() }}</p>
    </div>

    <!-- Bookings data view -->
    <p-dataView #dv [value]="bookingItems" [rows]="5" [paginator]="true" styleClass="transparent-dataview"
    *ngIf="!loading && bookingItems.length > 0">
      <ng-template #list let-items>
        <div class="list">
          <div class="item" *ngFor="let item of items; trackBy: trackById">
            <div class="item-content">
              <!-- Item image -->
              <div class="image">
                <p-skeleton *ngIf="!item.image || (item.imageLoading === true)" width="100%" height="100%"
                  styleClass="booking-image-skeleton"></p-skeleton>
                <img *ngIf="item.image && (item.imageLoading !== true)" [src]="item.image" [alt]="item.title" 
                  (error)="imageLoadError(item)" loading="eager"/>
              </div>

              <!-- Item information -->
              <div class="sect">
                <div class="title-section">
                  <h2>{{ item.title }}</h2>
                </div>
                <div class="cont">
                  <!-- Show the appropriate ID field based on component type -->
                  <div class="info-row">
                    <span class="label">{{ 
                      listType === 'active-bookings' ? 'Nº Reserva:' : 
                      listType === 'recent-budgets' ? 'Nº Presupuesto:' : 
                      'Nº Reserva:'
                    }}</span>
                    <span class="value budget">
                      {{ 
                        listType === 'active-bookings' ? (item.reservationNumber || '') : 
                        listType === 'recent-budgets' ? (item.ID || '') : 
                        (item.number || item.code || '')
                      }}
                    </span>
                  </div>
                  <div class="info-row">
                    <span class="label">Fecha de creación:</span>
                    <span class="value">{{ item.creationDate | date : "dd/MM/yyyy" }}</span>
                  </div>
                  <div class="info-row status">
                    <span class="label">Estado:</span>
                    <span class="value">{{ item.status }}</span>
                  </div>
                  <!-- Show origin only for travel history -->
                  <div class="info-row" *ngIf="item.origin && listType === 'travel-history'">
                    <span class="label">Origen:</span>
                    <span class="value">{{ item.origin }}</span>
                  </div>
                </div>
              </div>

              <!-- Departure and passenger info -->
              <div class="right">
                <div class="departure-info">
                  <span>Salida: </span>
                  <strong>
                    {{ item.departureDate | date : "dd/MM/yyyy" }}
                  </strong>
                </div>
                <div class="price" *ngIf="item.passengers || item.price">
                  <div class="info" *ngIf="item.passengers">
                    <span class="num-users">{{ item.passengers }}</span>
                    <i class="pi pi-users"></i>
                  </div>
                  <!-- Use currencyFormat pipe for budgets if available -->
                  <strong *ngIf="item.price && listType === 'recent-budgets'">
                    {{ item.price | currency : "EUR" }}
                  </strong>
                  <!-- Use currency pipe for other types -->
                  <strong *ngIf="item.price && listType !== 'recent-budgets'">
                    {{ item.price | currency : "EUR" }}
                  </strong>
                </div>
              </div>

              <!-- Action buttons -->
              <div class="buttons">
                <div class="top-buttons">
                  <p-button *ngIf="shouldShowDownload()" 
                    [label]="getDownloadLabel()" 
                    styleClass="p-button-outlined" 
                    [loading]="downloadLoading[item.id]"
                    (click)="downloadItem(item)"></p-button>
                  <p-button *ngIf="shouldShowSend()" 
                    [label]="getSendLabel()" 
                    styleClass="sendbtn"
                    [loading]="notificationLoading[item.id]"
                    (click)="sendItem(item)"></p-button>
                </div>
                <div class="bottom-buttons">
                  <p-button *ngIf="shouldShowView()" 
                    [label]="getViewLabel()" 
                    styleClass="p-button-rounded" 
                    (click)="viewItem(item)"></p-button>
                  <p-button *ngIf="shouldShowReserve()" 
                    [label]="getReserveLabel()" 
                    styleClass="p-button-rounded" 
                    (click)="reserveItem(item)"></p-button>
                  <p-button *ngIf="shouldShowPointsDiscount(item)" 
                    [label]="getPointsDiscountLabel(item)" 
                    [styleClass]="hasPointsApplied(item) ? 'p-button-rounded p-button-secondary' : 'p-button-rounded p-button-success'" 
                    [icon]="hasPointsApplied(item) ? 'pi pi-check' : 'pi pi-gift'"
                    [disabled]="hasPointsApplied(item)"
                    (click)="openPointsDiscountModal(item)"></p-button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </ng-template>

      <!-- Empty state template -->
      <ng-template #empty>
        <div class="empty-message">
          {{ getEmptyMessage() }}
        </div>
      </ng-template>
    </p-dataView>
  </div>
</div>

<!-- Modal para descuento de puntos -->
<p-dialog 
  [(visible)]="pointsDiscountModalVisible" 
  [modal]="true" 
  [closable]="true" 
  [draggable]="false" 
  [resizable]="false"
  [style]="{width: '500px'}"
  header="Descontar Puntos">
  
  <div class="points-discount-content" *ngIf="selectedBookingItem">
    <div class="booking-info">
      <h4>{{ selectedBookingItem.title }}</h4>
      <p><strong>Nº Reserva:</strong> {{ selectedBookingItem.reservationNumber || selectedBookingItem.number }}</p>
      <p><strong>Precio Total:</strong> {{ selectedBookingItem.price | currency:'EUR':'symbol':'1.2-2' }}</p>
    </div>
    
    <div class="points-section">
      <div class="points-available">
        <label><strong>Puntos Disponibles:</strong></label>
        <span class="points-value">{{ availablePoints }}</span>
      </div>
      
      <p-message severity="info" styleClass="w-full membership-message">
        <ng-template pTemplate="messageicon">
          <i class="pi pi-star-fill"></i>
        </ng-template>
        <span><strong>{{ getCategoryDisplayName() }}</strong> - Límite por reserva: <strong>{{ maxPointsForCategory }} puntos</strong></span>
      </p-message>
      
      <div class="points-input">
        <label for="pointsToUse">Puntos a Descontar:</label>
        <p-inputNumber 
          id="pointsToUse"
          [(ngModel)]="pointsToUse" 
          [min]="0" 
          [max]="availablePoints"
          [maxFractionDigits]="0"
          placeholder="Ingresa los puntos a descontar"
          styleClass="w-full">
        </p-inputNumber>
        <small class="text-muted">Máximo disponible: {{ availablePoints }} puntos</small>
      </div>
      
      <div class="discount-calculation" *ngIf="pointsToUse > 0">
        <div class="calculation-row">
          <span>Precio Original:</span>
          <span>{{ selectedBookingItem.price | currency:'EUR':'symbol':'1.2-2' }}</span>
        </div>
        <div class="calculation-row">
          <span>Descuento por Puntos:</span>
          <span class="discount-amount">-{{ pointsToUse | currency:'EUR':'symbol':'1.2-2' }}</span>
        </div>
        <div class="calculation-row total">
          <span><strong>Precio Final:</strong></span>
          <span><strong>{{ getFinalPrice() | currency:'EUR':'symbol':'1.2-2' }}</strong></span>
        </div>
      </div>
    </div>
  </div>
  
  <ng-template pTemplate="footer">
    <p-button 
      label="Cancelar" 
      icon="pi pi-times" 
      styleClass="p-button-text" 
      (click)="closePointsDiscountModal()">
    </p-button>
    <p-button 
      label="Aplicar Descuento" 
      icon="pi pi-check" 
      styleClass="p-button-success" 
      [disabled]="pointsToUse <= 0 || pointsToUse > availablePoints"
      (click)="applyPointsDiscount()">
    </p-button>
  </ng-template>
</p-dialog>