<div class="loading-container" *ngIf="loading">
  <p-progressSpinner styleClass="reservation-loader"></p-progressSpinner>
</div>
<div
  *ngIf="!loading && !error"
  class="res-conf"
  [ngClass]="paymentStatus || reservationInfo?.status"
>
  <!-- Header con check y t√≠tulo -->
  <div class="hdr">
    <span
      class="status-icon"
      *ngIf="(paymentStatus || reservationInfo?.status) !== 'transfer'"
      [class]="
        (paymentStatus || reservationInfo?.status) === 'confirm'
          ? 'pi pi-check-circle'
          : 'pi pi-exclamation-circle'
      "
    ></span>
    <h1 *ngIf="(paymentStatus || reservationInfo?.status) === 'confirm'">
      ¬°Tu reserva con n√∫mero {{ reservationInfo?.reservationNumber }} ha sido
      confirmada!
    </h1>
    <h1 *ngIf="(paymentStatus || reservationInfo?.status) === 'rq'">
      ¬°Tu reserva con n√∫mero {{ reservationInfo?.reservationNumber }} est√° en
      petici√≥n!
    </h1>
    <h1 *ngIf="(paymentStatus || reservationInfo?.status) === 'transfer'">
      Confirma tu petici√≥n de reserva realizando el pago por transferencia
    </h1>
  </div>

  <!-- Mensaje de bienvenida -->
  <div class="wel">
    <p class="greet" *ngIf="reservationInfo?.customerName">
      Hola {{ reservationInfo?.customerName }},
    </p>

    <!-- Mensajes espec√≠ficos por estado -->
    <ng-container
      *ngIf="(paymentStatus || reservationInfo?.status) === 'confirm'"
    >
      <p class="hl">
        ¬°Estamos emocionados de confirmarte que tu reserva ha sido realizada con
        √©xito!
      </p>
      <p class="msg">
        Gracias por elegirnos para tu pr√≥ximo viaje. Sabemos que cada viaje es
        una oportunidad para crear recuerdos inolvidables, y estamos aqu√≠ para
        asegurarnos de que todo sea perfecto. Si tienes alguna pregunta sobre tu
        destino, recomendaciones de actividades o cualquier detalle relacionado
        con tu viaje, no dudes en contactarnos.
      </p>
      <p class="msg">
        ¬°Estamos seguros de que vivir√°s una experiencia maravillosa!
      </p>
    </ng-container>

    <ng-container *ngIf="(paymentStatus || reservationInfo?.status) === 'rq'">
      <p class="hl">
        Hemos bloqueado tus plazas, ¬°Esto significa que te tenemos en cuenta
        para la salida de este tour!
      </p>
      <p class="msg">
        Pero algunos de los servicios incluidos en tu viaje est√°n a√∫n pendientes
        de confirmaci√≥n. Si el precio de tu viaje sufre alguna modificaci√≥n
        podr√°s cancelar la reserva sin ning√∫n compromiso y recibir un reembolso
        inmediato.
      </p>
      <p class="msg">
        Nuestro equipo de atenci√≥n al cliente se pondr√° en contacto contigo
        <span class="status-msg">v√≠a email</span> en las pr√≥ximas 24/48 horas
        con toda la informaci√≥n actualizada y los detalles para realizar el pago
        del dep√≥sito de tu viaje. Agradecemos tu paciencia y comprensi√≥n
      </p>
    </ng-container>

    <ng-container
      *ngIf="(paymentStatus || reservationInfo?.status) === 'transfer'"
    >
      <p class="hl">¬°Hemos recibido tu petici√≥n de reserva del tour!</p>
      <p class="msg">
        Por favor, realiza el pago por transferencia antes de las 11:59 pm
        {{ nextDayDate }} a trav√©s de las entidades bancarias que se indican.
      </p>
      <p class="status-msg" style="color: #f05a4c" *ngIf="!uploadedVoucher">
        IMPORTANTE: Sube el justificante de pago dentro de este plazo para
        evitar que tu viaje se cancele autom√°ticamente.
      </p>
    </ng-container>

    <!-- Recuadro coral con informaci√≥n bancaria -->
    <p-panel styleClass="bank-panel" *ngIf="paymentStatus === 'transfer'">
      <ng-template pTemplate="header">
        <div class="pan-hdr">
          Realiza el pago a trav√©s de una de estas entidades bancarias y adjunta
          el justificante
        </div>
      </ng-template>
      <div class="bank-info">
        <div class="bank-column" *ngFor="let bank of bankInfo">
          <div class="bank-row">
            <span class="label">Banco:</span>
            <span class="value">{{ bank.name }}</span>
          </div>
          <div class="bank-row">
            <span class="label">Cuenta:</span>
            <span class="value">{{ bank.account }}</span>
          </div>
          <div class="bank-row">
            <span class="label">Beneficiario:</span>
            <span class="value">{{ bank.beneficiary }}</span>
          </div>
          <div class="bank-row">
            <span class="label">Concepto:</span>
            <span class="value">{{ bank.concept }}</span>
          </div>
        </div>
      </div>
    </p-panel>

    <ng-container *ngIf="paymentInfo?.method === 'transfer'">
      <!-- Bot√≥n de justificante: mostrar componente de subida o bot√≥n de ver voucher -->
      <ng-container
        *ngIf="
          !uploadedVoucher && paymentInfo?.status == 'PENDING';
          else voucherView
        "
      >
        <app-upload-button
          label="Subir justificante de transferencia"
          accept="image/*, .pdf"
          [maxFileSize]="1000000"
          folder="vouchers"
          [auto]="false"
          chooseIcon="pi pi-upload"
          styleClass="upload-button"
          (onUploadSuccess)="handleVoucherUpload($event)"
          (onUploadError)="handleVoucherError($event)"
        >
        </app-upload-button>
      </ng-container>
      <ng-template #voucherView>
        <p-button
          label="Ver justificante"
          (onClick)="viewVoucher()"
          severity="info"
        ></p-button>
        <ng-container *ngIf="paymentInfo?.status === 'PENDING_REVIEW'">
          <p class="voucher-status-text">
            Hemos recibido tu comprobante de pago y nuestro equipo lo estar√°
            validando. Recibir√°s una notificaci√≥n en tu correo cuando la
            transferencia sea verificada.
          </p>
        </ng-container>
      </ng-template>
    </ng-container>
  </div>

  <!-- Panel de detalles -->
  <p-panel styleClass="det-panel">
    <div class="det-item">
      <label class="val">Fecha de reserva:</label>
      <span>{{ reservationInfo?.date }}</span>
    </div>
    <div class="det-item">
      <label class="val">N√∫mero de reserva:</label>
      <span>{{ reservationInfo?.reservationNumber }}</span>
    </div>
    <div class="det-item">
      <label class="val">{{
        paymentInfo?.status === "PENDING"
          ? "Pendiente a abonar:"
          : "Importe abonado:"
      }}</label>
      <span>{{ paymentInfo?.amount || 0 | currencyFormat : "EUR" }}</span>
    </div>
  </p-panel>

  <!-- Secci√≥n de creaci√≥n de contrase√±a -->
  <!--   <div class="lnk">
    <p>
      Te has dado de alta en nuestra web al realizar tu reserva, crea tu
      contrase√±a para acceder a
      <a href="#">tu perfil</a> y poder gestionar tu reserva
    </p>
    <a href="#" class="pwd" style="color: #55728f">Crear contrase√±a</a>
  </div> -->

  <!-- Panel de informaci√≥n del viaje -->
  <app-travel-information-section
    *ngIf="reservationInfo?.tripDetails"
    [tripDetails]="reservationInfo!.tripDetails"
  ></app-travel-information-section>

  <!-- Panel de informaci√≥n de viajeros -->
  <app-travelers-information-section
    *ngIf="reservationInfo?.travelers"
    [travelers]="reservationInfo!.travelers"
  ></app-travelers-information-section>

  <!-- Panel de vuelos -->
  <app-flights-section [flights]="flights"></app-flights-section>

  <!-- Panel de precios -->
  <app-prices-section
    *ngIf="reservationInfo?.totalAmount"
    [priceDetails]="priceDetails"
  ></app-prices-section>

  <!-- Panel de informaci√≥n de pago -->
  <app-payments-information-section
    *ngIf="reservationInfo?.totalAmount"
    [totalAmount]="reservationInfo!.totalAmount"
    [bookingID]="bookingId"
    [bookingData]="bookingData!"
    [currentPayment]="paymentInfo!"
  ></app-payments-information-section>

  <!-- ‚úÖ NUEVA SECCI√ìN: Informaci√≥n de reserva de vuelos Amadeus -->
  <div class="amadeus-flight-section" *ngIf="hasAmadeusFlight || flightBookingResponse">
    <p-panel styleClass="amadeus-panel">
      <ng-template pTemplate="header">
        <div class="amadeus-header">
          <i class="pi pi-plane" style="margin-right: 0.5rem;"></i>
          Reserva de Vuelos Amadeus
        </div>
      </ng-template>
      
      <!-- Estado de verificaci√≥n -->
      <div class="flight-status" *ngIf="!flightBookingResponse && !flightBookingError">
        <div class="status-item">
          <i class="pi pi-check-circle" style="color: #177903; margin-right: 0.5rem;"></i>
          <span>Vuelos Amadeus detectados y seleccionados</span>
        </div>
        
        <!-- Loading durante la reserva -->
        <div class="booking-loading" *ngIf="flightBookingLoading">
          <p-progressSpinner styleClass="flight-loader"></p-progressSpinner>
          <p>Procesando reserva de vuelos...</p>
        </div>

        <!-- ‚úÖ DEBUG: Estado actual de vuelos -->
        <div class="debug-section">
          <details>
            <summary style="cursor: pointer; color: #666; font-size: 0.9rem; margin-top: 1rem;">
              üîç Ver estado actual (Debug)
            </summary>
            <div class="debug-content">
              <div class="debug-item">
                <strong>hasAmadeusFlight:</strong> 
                <span [style.color]="hasAmadeusFlight ? '#177903' : '#f05a4c'">{{ hasAmadeusFlight }}</span>
              </div>
              <div class="debug-item">
                <strong>flightBookingLoading:</strong> 
                <span [style.color]="flightBookingLoading ? '#177903' : '#666'">{{ flightBookingLoading }}</span>
              </div>
              <div class="debug-item">
                <strong>flightBookingError:</strong> 
                <span [style.color]="flightBookingError ? '#f05a4c' : '#666'">{{ flightBookingError }}</span>
              </div>
              <div class="debug-item">
                <strong>bookingData._id:</strong> 
                <span style="font-family: monospace; background: #f8f9fa; padding: 0.25rem 0.5rem; border-radius: 4px;">{{ bookingData?._id || 'No disponible' }}</span>
              </div>
              
              <!-- Bot√≥n manual para probar -->
              <div class="debug-actions" style="margin-top: 1rem; text-align: center;">
                <p-button 
                  label="üîÑ Verificar vuelos manualmente" 
                  (onClick)="checkAndBookAmadeusFlight()" 
                  severity="info"
                  [disabled]="!bookingData?._id || flightBookingLoading"
                  styleClass="debug-button">
                </p-button>
              </div>
            </div>
          </details>
        </div>
      </div>

      <!-- Respuesta exitosa de la reserva -->
      <div class="flight-success" *ngIf="flightBookingResponse && !flightBookingLoading">
        <div class="success-header">
          <i class="pi pi-check-circle" style="color: #177903; font-size: 2rem;"></i>
          <h3>¬°Vuelos reservados exitosamente!</h3>
        </div>
        
        <div class="flight-details" *ngIf="flightBookingResponse.data">
          <div class="detail-item" *ngIf="flightBookingResponse.data.id">
            <label>ID de Orden:</label>
            <span>{{ flightBookingResponse.data.id }}</span>
          </div>
          <div class="detail-item" *ngIf="flightBookingResponse.data.type">
            <label>Tipo de Orden:</label>
            <span>{{ flightBookingResponse.data.type }}</span>
          </div>
          <div class="detail-item" *ngIf="flightBookingResponse.data.queuingOfficeId">
            <label>Oficina de Cola:</label>
            <span>{{ flightBookingResponse.data.queuingOfficeId }}</span>
          </div>
        </div>

        <!-- Warnings si existen -->
        <div class="flight-warnings" *ngIf="flightBookingResponse.warnings && flightBookingResponse.warnings.length > 0">
          <h4>Advertencias:</h4>
          <div class="warning-item" *ngFor="let warning of flightBookingResponse.warnings">
            <i class="pi pi-exclamation-triangle" style="color: #f05a4c; margin-right: 0.5rem;"></i>
            <span>{{ warning.title }}: {{ warning.detail }}</span>
          </div>
        </div>

        <!-- ‚úÖ SECCI√ìN DEBUG: Informaci√≥n completa en JSON -->
        <div class="debug-section">
          <details>
            <summary style="cursor: pointer; color: #666; font-size: 0.9rem; margin-top: 1rem;">
              üîç Ver informaci√≥n completa (Debug)
            </summary>
            <div class="debug-content">
              <pre style="background: #f5f5f5; padding: 1rem; border-radius: 4px; overflow-x: auto; font-size: 0.8rem; margin-top: 0.5rem;">{{ flightBookingResponse | json }}</pre>
            </div>
          </details>
        </div>
      </div>

      <!-- Error en la reserva -->
      <div class="flight-error" *ngIf="flightBookingError && !flightBookingLoading">
        <div class="error-header">
          <i class="pi pi-exclamation-triangle" style="color: #f05a4c; font-size: 2rem;"></i>
          <h3>Error en la reserva de vuelos</h3>
        </div>
        <p>No se pudo completar la reserva de vuelos. Por favor, contacta con soporte t√©cnico.</p>
        <p-button 
          label="Reintentar" 
          (onClick)="checkAndBookAmadeusFlight()" 
          severity="warn"
          styleClass="retry-button">
        </p-button>
      </div>
    </p-panel>
  </div>
</div>

<div *ngIf="error" class="error-container">
  <i
    class="pi pi-exclamation-triangle"
    style="font-size: 3rem; color: #f05a4c"
  ></i>
  <h2>No se pudo cargar la informaci√≥n de la reserva</h2>
  <p>
    Por favor, int√©ntalo de nuevo m√°s tarde o ponte en contacto con nuestro
    equipo de soporte.
  </p>
  <button pButton type="button" label="Volver" routerLink="/"></button>
</div>
