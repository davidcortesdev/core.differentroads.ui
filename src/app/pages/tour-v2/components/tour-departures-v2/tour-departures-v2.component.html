<div class="tour-departures-container">
  <!-- ===== AGREGADO: Toast para mostrar notificaciones ===== -->
  <p-toast></p-toast>

  <!-- Loading State -->
  <div *ngIf="loading" class="departure-loading">
    <div class="loading-container">
      <p-skeleton width="100%" height="200px" styleClass="mb-3"></p-skeleton>
      <p-skeleton width="80%" height="30px" styleClass="mb-2"></p-skeleton>
      <p-skeleton width="60%" height="30px"></p-skeleton>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="departure-error">
    <div class="error-content">
      <i class="pi pi-exclamation-triangle error-icon"></i>
      <h3>Error al cargar la información</h3>
      <p>{{ error }}</p>
    </div>
  </div>

  <!-- Empty State - Sin departure seleccionado -->
  <div *ngIf="!hasSelectedDeparture && !loading && !error" class="departure-empty">
    <div class="empty-content">
      <i class="pi pi-calendar-plus empty-icon"></i>
      <h3>Selecciona una fecha de salida</h3>
      <p>Elige una fecha en el selector de arriba para ver los detalles del viaje.</p>
    </div>
  </div>

  <!-- TABLA DE VUELOS CON DATOS REALES DEL DEPARTURE -->
  <div *ngIf="hasValidData" class="t-dep">
    <p-toast></p-toast>
    <h1>Configurar tu Viaje: Fechas y Pasajeros</h1>

    <!-- Sección de filtros con labels dentro de inputs -->
    <div class="f-hdr">
      <div class="f-box">
        <div class="f-lbl">Ciudad de origen</div>
        <div class="f-cnt">
          <span class="input-label">Ciudad de origen</span>
          <p-autocomplete
            [suggestions]="filteredCities"
            [(ngModel)]="selectedCity"
            [dropdown]="true"
            placeholder="Sin vuelos"
            (completeMethod)="filterCities($event)"
            (onSelect)="onCityChange($event.value)"
            optionLabel="name"
          ></p-autocomplete>
        </div>
      </div>

      <div class="f-box">
        <div class="f-lbl">Pasajeros</div>
        <div class="f-cnt">
          <span class="input-label">Pasajeros</span>
          <button
            #passengerButton
            type="button"
            class="p-autocomplete p-btn"
            (click)="togglePassengersPanel($event)"
          >
            {{ passengerText }}
            <i class="pi pi-chevron-down ml-auto"></i>
          </button>

          <p-overlay [(visible)]="showPassengersPanel" styleClass="p-ovl">
            <div class="p-panel p-3">
              
              <!-- ✅ SECCIÓN ADULTOS - Solo mostrar si están permitidos -->
              <div class="p-type" *ngIf="allowedPassengerTypes.adults">
                <div class="p-info">
                  <div class="p-cat">Adultos</div>
                  <div class="p-age">{{ getAgeText('adults') }}</div>                
                </div>
                <div class="p-ctrl">
                  <p-button
                    icon="pi pi-minus"
                    styleClass="p-button-rounded p-button-outlined"
                    [disabled]="travelers.adults <= 1"
                    (onClick)="updatePassengers('adults', -1)"
                  ></p-button>
                  <span class="p-count">{{ travelers.adults }}</span>
                  <p-button
                    icon="pi pi-plus"
                    styleClass="p-button-rounded p-button-outlined"
                    (onClick)="updatePassengers('adults', 1)"
                  ></p-button>
                </div>
              </div>

              <!-- ✅ SECCIÓN NIÑOS - Solo mostrar si están permitidos -->
              <div class="p-type" *ngIf="allowedPassengerTypes.children">
                <div class="p-info">
                  <div class="p-cat">
                    Niños
                    <p-badge
                      icon="pi pi-info-circle"
                      severity="info"
                      styleClass="ml-2"
                    ></p-badge>
                  </div>
                  <div class="p-age">{{ getAgeText('children') }}</div>
                </div>
                <div class="p-ctrl">
                  <p-button
                    icon="pi pi-minus"
                    styleClass="p-button-rounded p-button-outlined"
                    [disabled]="travelers.children <= 0"
                    (onClick)="updatePassengers('children', -1)"
                  ></p-button>
                  <span class="p-count">{{ travelers.children }}</span>
                  <p-button
                    icon="pi pi-plus"
                    styleClass="p-button-rounded p-button-outlined"
                    (onClick)="updatePassengers('children', 1)"
                  ></p-button>
                </div>
              </div>

              <!-- ✅ SECCIÓN BEBÉS - Solo mostrar si están permitidos -->
              <div class="p-type" *ngIf="allowedPassengerTypes.babies">
                <div class="p-info">
                  <div class="p-cat">
                    Bebés
                    <p-badge
                      icon="pi pi-info-circle"
                      severity="info"
                      styleClass="ml-2"
                    ></p-badge>
                  </div>
                  <div class="p-age">{{ getAgeText('babies') }}</div>
                </div>
                <div class="p-ctrl">
                  <p-button
                    icon="pi pi-minus"
                    styleClass="p-button-rounded p-button-outlined"
                    [disabled]="travelers.babies <= 0"
                    (onClick)="updatePassengers('babies', -1)"
                  ></p-button>
                  <span class="p-count">{{ travelers.babies }}</span>
                  <p-button
                    icon="pi pi-plus"
                    styleClass="p-button-rounded p-button-outlined"
                    (onClick)="updatePassengers('babies', 1)"
                  ></p-button>
                </div>
              </div>

              <div class="p-actions">
                <p-button
                  label="Aplicar"
                  styleClass="p-button-rounded"
                  (onClick)="applyPassengers()"
                ></p-button>
              </div>
            </div>
          </p-overlay>
        </div>
      </div>
    </div>

    <!-- DataView con datos REALES del departure -->
    <p-dataView
      #dv
      [value]="filteredDepartures"
      [rows]="5"
      [paginator]="false"
      styleClass="paginator-transparent"
      layout="list"
    >
      <ng-template #header>
        <div class="dep-hdr">
          <div class="hdr-cols">
            <span>Salida <i class="pi pi-arrow-right header"></i> Regreso</span>
            <span>Información</span>
            <span>Tipo de salida</span>
            <span>Precio</span>
            <span></span>
          </div>
        </div>
      </ng-template>

      <ng-template #list let-departures>
        <div class="dep-list">
          <ng-container *ngFor="let item of departures; trackBy: trackByDepartureId">
            <div class="dep-item" [ngClass]="{'not-bookable': !item.isBookable}">
              <div class="dates">
                <div class="d-date">
                  <span class="d-name">{{
                    item.departureDate | date : "EEEE"
                  }}</span>
                  <span class="d-day">{{
                    item.departureDate | date : "dd MMM"
                  }}</span>
                </div>
                <i class="pi pi-arrow-right"></i>
                <div class="d-date">
                  <span class="d-name">{{
                    item.returnDate | date : "EEEE" 
                  }}</span>
                  <span class="d-day">{{
                    item.returnDate | date : "dd MMM" 
                  }}</span>
                </div>
              </div>

              <div class="info">
                <span
                  *ngIf="
                    getTripTypeInfo(item.group) &&
                    getTripTypeInfo(item.group)?.class === 'single'
                  "
                  [pTooltip]="getTripTypeInfo(item.group)?.description"
                  tooltipPosition="top"
                  class="trip-type-tag"
                  [ngClass]="
                    'trip-type-tag-' + getTripTypeInfo(item.group)?.class
                  "
                >
                  {{ getTripTypeInfo(item.group)?.title }}
                </span>

                <!-- Horarios de vuelos -->
                <div class="flight-times" *ngIf="!isSinVuelosSelected() && hasFlightTimesState(item.id)">
                  <!-- Mostrar skeleton cuando está cargando -->
                  <div class="flight-times-loading" *ngIf="isFlightTimesLoading(item.id)">
                    <p-skeleton width="80%" height="12px" styleClass="mb-1"></p-skeleton>
                    <p-skeleton width="70%" height="12px"></p-skeleton>
                  </div>
                  
                  <!-- Mostrar horarios válidos cuando están disponibles y no está cargando -->
                  <div *ngIf="!isFlightTimesLoading(item.id) && hasValidFlightTimes(item.id)">
                    <div *ngFor="let line of getFlightTimesLines(item.id)" class="flight-line">
                      {{ line }}
                    </div>
                  </div>

                  <!-- Fallback cuando la API respondió pero no hay datos válidos -->
                  <div
                    *ngIf="!isFlightTimesLoading(item.id) && !hasValidFlightTimes(item.id) && hasFlightTimesError(item.id)"
                  >
                    <div class="flight-line loading-text">
                      Horarios de vuelo no disponibles en este momento
                    </div>
                  </div>
                </div>
                
                <!-- Mostrar "sin vuelos" cuando se selecciona esa opción -->
                <div class="flight-times" *ngIf="isSinVuelosSelected()">
                  <div class="flight-line">
                    Sin vuelos
                  </div>
                </div>

                <!-- Contenedor de tags con espaciado -->
                <div class="tags-container">
                  <p-tag
                    severity="warn"
                    value="Lista de espera"
                    *ngIf="item.waitingList"
                    ><i class="pi pi-clock" style="font-size: 0.7rem"></i>
                  </p-tag>

                  <!-- Estado de disponibilidad de plazas -->
                  <p-tag
                    *ngIf="item.availabilityStatus === 'no-spots'"
                    severity="danger"
                    value="SIN PLAZAS"
                    styleClass="availability-tag"
                  ></p-tag>
                  <p-tag
                    *ngIf="item.availabilityStatus === 'last-spots'"
                    severity="warn"
                    value="Últimas plazas"
                    styleClass="availability-tag"
                  ></p-tag>
                </div>
              </div>

              <div class="trip-type">
                <p-tag
                  *ngIf="getTripType(item.tripTypeId)"
                  [value]="getTripType(item.tripTypeId)?.name || 'Sin tipo'"
                  [style.background-color]="getTripType(item.tripTypeId)?.color || '#ccc'"
                  [style.color]="'#fff'"
                  [style.border]="'none'"
                ></p-tag>
                <span *ngIf="!getTripType(item.tripTypeId)">Sin tipo</span>
              </div>

              <div class="f-price">
                <div class="p-container">
                  <span>desde</span>
                  <span class="amount" *ngIf="!item.priceError && item.price !== null && item.price !== undefined">{{ item.price | currency:'EUR':'symbol':'1.0-0' }}</span>
                  <span class="amount error-text" *ngIf="item.priceError || item.price === null || item.price === undefined">error</span>
                </div>
              </div>

              <div class="actions">
                <button 
                  type="button" 
                  pButton 
                  [disabled]="item.status === 'complete' || !item.isBookable"
                  (click)="addToCart(item)"
                  class="p-button-rounded"
                  [style.background-color]="selectedDepartureId === item.id ? 'transparent' : null"
                  [style.color]="selectedDepartureId === item.id ? 'var(--p-primary-color)' : null"
                  [style.border]="selectedDepartureId === item.id ? '1px solid var(--p-primary-color)' : null"
                  [pTooltip]="!item.isBookable ? 'Esta salida no está disponible para reservar' : ''"
                  tooltipPosition="top"
                >
                  {{ item.status === 'complete' ? 'COMPLETO' : (!item.isBookable ? 'NO DISPONIBLE' : (selectedDepartureId === item.id ? 'Añadido' : 'Añadir')) }}
                </button>
              </div>
              
            </div>
          </ng-container>
        </div>
      </ng-template>
    </p-dataView>
  </div>

</div>