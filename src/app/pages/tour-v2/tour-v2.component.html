<div class="tour-v2-container">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading">
    <p>Cargando información del tour...</p>
  </div>
  
  <!-- Error State -->
  <div *ngIf="error" class="error">
    <p>{{ error }}</p>
  </div>
  
  <!-- Tour Content -->
  <div *ngIf="!loading && !error && tour" class="tour-content">
    <!-- Tour Header Section - MODIFICADO PARA PASAR ACTIVIDADES SELECCIONADAS, FLAG Y DATOS DE AGE GROUPS -->
    <section class="tour-section tour-header-section">
      <section class="tour-section tour-header-section">
        <app-tour-header-v2
          [tourId]="tour.id"
          [totalPrice]="totalPrice"
          [selectedCity]="selectedCity"
          [selectedDeparture]="selectedDepartureData"
          [totalPassengers]="totalPassengers"
          [selectedActivities]="selectedActivities"
          [showActivitiesStatus]="showActivitiesStatus"
          [passengersData]="passengersData"
          [ageGroupCategories]="ageGroupCategories"
          [activityTypesAnalysis]="activityTypesAnalysis"
          [preview]="preview"
          [selectedActivityPackId]="selectedActivityPackId"
          [tourTripTypes]="tourTripTypes"
          [citiesLoading]="citiesLoading"> <!-- ✅ NUEVO: Añadir citiesLoading -->
        </app-tour-header-v2>
      </section>
    </section>
    
    <!-- Tour Overview Section -->
    <section class="tour-section tour-overview-section">
      <app-tour-overview-v2 [tourId]="tour.id" [preview]="preview"></app-tour-overview-v2>
    </section>
    
    <!-- Tour Highlights Section -->
    <section class="tour-section tour-highlights-section">
      <app-tour-highlights-v2 [tourId]="tour.id" [preview]="preview" ></app-tour-highlights-v2>
    </section>
    
    <!-- Tour Itinerary Section - MODIFICADO PARA RECIBIR EVENTOS DE ACTIVIDAD -->
    <section class="tour-section tour-itinerary-section">
      <app-tour-itinerary-v2
        [preview]="preview"
        [tourId]="tour.id"
        [selectedDepartureFromParent]="selectedDepartureData"
        (departureSelected)="onDepartureSelected($event)"
        (activitySelected)="onActivitySelected($event)">
      </app-tour-itinerary-v2>
    </section>
    
    <!-- Tour departure Section - MODIFICADO PARA RECIBIR EVENTO DE AGE GROUPS -->
    <section class="tour-section tour-departures-section">
      <app-tour-departures-v2
        [tourId]="tour.id"
        [tourData]="tour"
        [selectedDepartureEvent]="selectedDepartureEvent"
        (priceUpdate)="onPriceUpdate($event)"
        (cityUpdate)="onCityUpdate($event)"
        (departureUpdate)="onDepartureUpdate($event)"
        (passengersUpdate)="onPassengersUpdate($event)"
        (ageGroupsUpdate)="onAgeGroupsUpdate($event)"
        [preview]="preview"
        (activityPackIdUpdate)="onActivityPackIdUpdate($event)"
        (citiesLoadingUpdate)="onCitiesLoadingUpdate($event)">
      </app-tour-departures-v2>
    </section>
    
    <!-- Tour Information Accordion Section -->
    <section class="tour-section tour-info-accordion-section">
      <app-tour-info-accordion-v2 [tourId]="tour.id"></app-tour-info-accordion-v2>
    </section>

    <!-- Tour Information Accordion Section -->
    <section class="tour-section tour-additional-info-section">
      <app-additional-info
        [tourId]="tour.id?.toString() || ''"
        [tourName]="tour.name || ''"
        [periodID]="selectedDepartureData?.id?.toString() || ''"
        [periodName]="selectedDepartureData?.group || ''"
        [periodDates]="selectedDepartureData?.departureDate && selectedDepartureData?.returnDate ? selectedDepartureData.departureDate + ' - ' + selectedDepartureData.returnDate : ''"
        [totalPrice]="totalPrice"
        [selectedCity]="selectedCity"
        [selectedDeparture]="selectedDepartureData"
        [totalPassengers]="totalPassengers"
        [travelersSelected]="passengersData"
        [selectedActivities]="selectedActivities"
        [showActivitiesStatus]="showActivitiesStatus"
        [passengersData]="passengersData"
        [ageGroupCategories]="ageGroupCategories"
        [context]="'tour'"
        [isAuthenticated]="isAuthenticated"
        [tourCountry]="tourCountry"
        [tourContinent]="tourContinent"
        [tourRating]="tourRating"
        [tourDuration]="tourDuration"
        [tourTripType]="tourTripType"
        [tourProductStyle]="tourProductStyle"
        [tourListId]="tour.id?.toString() || ''"
        [tourListName]="tour.name || ''">
      </app-additional-info>
    </section>
    
    <!-- Tour Reviews Section -->
    <section id="tour-reviews" class="tour-section tour-reviews-section">
      <app-tour-reviews-v2 [tourId]="tour.id"></app-tour-reviews-v2>
    </section>
  </div>
</div>