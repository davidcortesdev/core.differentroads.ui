<!-- Card para "Guarda tu presupuesto" -->
<div
  class="action-card"
  [ngClass]="{
    'checkout-style': context === 'checkout',
    'tour-style': context === 'tour',
    'disabled': !hasSelectedDate && context === 'tour'
  }"
  (click)="hasSelectedDate || context === 'checkout' ? handleSaveTrip() : null"
  [title]="getSaveButtonTooltip()"
  [style.pointer-events]="!hasSelectedDate && context === 'tour' ? 'none' : 'auto'"
  [style.opacity]="!hasSelectedDate && context === 'tour' ? '0.6' : '1'"
>
  <div class="card-content">
    <span class="bg-pink-100">
      <i class="pi pi-bookmark" aria-hidden="true"></i>
    </span>
    <span class="card-text">{{ getSaveButtonText() }}</span>
  </div>
</div>

<!-- Card para "Descarga tu presupuesto" -->
<div
  class="action-card"
  [ngClass]="{
    'checkout-style': context === 'checkout',
    'tour-style': context === 'tour',
    'disabled': !hasSelectedDate && context === 'tour'
  }"
  (click)="hasSelectedDate || context === 'checkout' ? handleDownloadTrip() : null"
  [title]="getDownloadButtonTooltip()"
  [style.pointer-events]="!hasSelectedDate && context === 'tour' ? 'none' : 'auto'"
  [style.opacity]="!hasSelectedDate && context === 'tour' ? '0.6' : '1'"
>
  <div class="card-content">
    <span class="bg-pink-100">
      <i class="pi pi-download" aria-hidden="true"></i>
    </span>
    <span class="card-text">Descarga tu presupuesto</span>
  </div>
</div>

<!-- Card para "Comparte tu presupuesto con alguien" -->
<div
  class="action-card"
  [ngClass]="{
    'checkout-style': context === 'checkout',
    'tour-style': context === 'tour',
    'disabled': !hasSelectedDate && context === 'tour'
  }"
  (click)="hasSelectedDate || context === 'checkout' ? handleInviteFriend() : null"
  [title]="getShareButtonTooltip()"
  [style.pointer-events]="!hasSelectedDate && context === 'tour' ? 'none' : 'auto'"
  [style.opacity]="!hasSelectedDate && context === 'tour' ? '0.6' : '1'"
>
  <div class="card-content">
    <span class="bg-pink-100">
      <i class="pi pi-user-plus" aria-hidden="true"></i>
    </span>
    <span class="card-text">Comparte tu presupuesto con alguien</span>
  </div>
</div>

<!-- Toast para notificaciones -->
<p-toast position="top-right"></p-toast>

<!-- Modal de login -->
<app-login-modal
  [visible]="loginDialogVisible"
  [modalType]="'budget'"
  (close)="closeLoginModal()"
  (login)="navigateToLogin()"
  (register)="navigateToRegister()"
>
</app-login-modal>

<!-- Modal de email y nombre completo para descarga sin autenticación -->
<p-dialog
  [(visible)]="visibleEmailModal"
  [modal]="true"
  [breakpoints]="dialogBreakpoints"
  [style]="dialogStyle"
  [draggable]="false"
  [resizable]="false"
  [closeOnEscape]="true"
  [dismissableMask]="true"
  (onHide)="handleCloseEmailModal()"
  header="Descargar Presupuesto"
>
  <div class="modal-content">
    <!-- Información del tour -->
    <div class="info-section">
      <h4>{{ tourName }}</h4>
      <p *ngIf="periodDates">{{ periodDates }}</p>
      <p *ngIf="selectedFlight">Vuelo: {{ selectedFlight.name || 'Sin especificar' }}</p>
      <p *ngIf="travelersSelected">
        Viajeros: {{ travelersSelected.adults }} adulto(s)
        <span *ngIf="travelersSelected.childs > 0">, {{ travelersSelected.childs }} niño(s)</span>
        <span *ngIf="travelersSelected.babies > 0">, {{ travelersSelected.babies }} bebé(s)</span>
      </p>
    </div>
    
    <!-- Formulario -->
    <form class="form-section" [formGroup]="emailForm">
      <!-- Email -->
      <div class="form-field">
        <label for="email">
          Email *
        </label>
        <input
          id="email"
          type="email"
          pInputText
          formControlName="email"
          placeholder="ejemplo@email.com"
          class="w-full"
        />
        <small class="error" *ngIf="emailForm.get('email')?.invalid && emailForm.get('email')?.touched">
          Por favor, introduce un email válido
        </small>
      </div>

      <!-- Nombre completo -->
      <div class="form-field">
        <label for="fullName">Nombre completo *</label>
        <input
          id="fullName"
          type="text"
          pInputText
          formControlName="fullName"
          placeholder="Nombre y apellidos"
          class="w-full"
        />
        <small class="error" *ngIf="emailForm.get('fullName')?.invalid && emailForm.get('fullName')?.touched">
          Por favor, introduce tu nombre completo
        </small>
      </div>

      <!-- Indicador de carga -->
      <div class="loading-indicator" *ngIf="loadingEmailModal">
        <p-progressSpinner 
          styleClass="w-4rem h-4rem" 
          strokeWidth="4"
          animationDuration=".5s"
        ></p-progressSpinner>
        <p>Procesando...</p>
      </div>
    </form>
  </div>
  
  <ng-template pTemplate="footer">
    <p-button 
      label="Cerrar" 
      icon="pi pi-times" 
      (onClick)="handleCloseEmailModal()"
      styleClass="p-button-text"
      [disabled]="loadingEmailModal"
    ></p-button>
    <p-button 
      label="Descargar" 
      icon="pi pi-download"
      (onClick)="onSubmitEmail()"
      [disabled]="!emailForm.valid || loadingEmailModal"
      [loading]="loadingEmailModal"
    ></p-button>
  </ng-template>
</p-dialog>

<!-- Modal de compartir/descargar presupuesto -->
<p-dialog
  [(visible)]="visible"
  [modal]="true"
  [breakpoints]="dialogBreakpoints"
  [style]="dialogStyle"
  [draggable]="false"
  [resizable]="false"
  [closeOnEscape]="true"
  [dismissableMask]="true"
  (onHide)="handleCloseModal()"
  [header]="isShareMode ? 'Compartir Presupuesto' : 'Descargar Presupuesto'"
>
  <div class="modal-content">
    <!-- Información del tour -->
    <div class="info-section">
      <h4>{{ tourName }}</h4>
      <p *ngIf="periodDates">{{ periodDates }}</p>
      <p *ngIf="selectedFlight">Vuelo: {{ selectedFlight.name || 'Sin especificar' }}</p>
      <p *ngIf="travelersSelected">
        Viajeros: {{ travelersSelected.adults }} adulto(s)
        <span *ngIf="travelersSelected.childs > 0">, {{ travelersSelected.childs }} niño(s)</span>
        <span *ngIf="travelersSelected.babies > 0">, {{ travelersSelected.babies }} bebé(s)</span>
      </p>
    </div>
    
    <!-- Formulario -->
    <form class="form-section" [formGroup]="shareForm">
      <!-- Email destinatario -->
      <div class="form-field">
        <label for="recipientEmail">
          {{ isShareMode ? 'Email del destinatario *' : 'Tu email *' }}
        </label>
        <input
          id="recipientEmail"
          type="email"
          pInputText
          formControlName="recipientEmail"
          [placeholder]="isShareMode ? 'ejemplo@email.com' : userEmail || 'ejemplo@email.com'"
          class="w-full"
        />
        <small class="error" *ngIf="shareForm.get('recipientEmail')?.invalid && shareForm.get('recipientEmail')?.touched">
          Por favor, introduce un email válido
        </small>
      </div>

      <!-- Nombre destinatario (solo modo compartir) -->
      <div class="form-field" *ngIf="isShareMode">
        <label for="recipientName">Nombre del destinatario</label>
        <div class="proximity-message">
          <i class="pi pi-clock"></i>
          <span>Próximamente</span>
        </div>
      </div>

      <!-- Mensaje personalizado -->
      <div class="form-field" *ngIf="!isShareMode">
        <label for="message">Comentarios adicionales</label>
        <textarea
          id="message"
          pTextarea
          formControlName="message"
          [rows]="4"
          placeholder="Añade cualquier comentario (opcional)"
          class="w-full"
        ></textarea>
      </div>

      <!-- Mensaje personalizado para modo compartir -->
      <div class="form-field" *ngIf="isShareMode">
        <label for="message">Mensaje personalizado</label>
        <div class="proximity-message">
          <i class="pi pi-clock"></i>
          <span>Próximamente</span>
        </div>
      </div>

      <!-- Opciones adicionales para compartir -->
      <div class="form-field" *ngIf="isShareMode">
        <label>Incluir detalles completos del itinerario</label>
        <div class="proximity-message">
          <i class="pi pi-clock"></i>
          <span>Próximamente</span>
        </div>
      </div>

      <!-- Indicador de envío -->
      <div class="loading-indicator" *ngIf="loading">
        <p-progressSpinner 
          styleClass="w-4rem h-4rem" 
          strokeWidth="4"
          animationDuration=".5s"
        ></p-progressSpinner>
        <p>Enviando...</p>
      </div>
    </form>
  </div>
  
  <ng-template pTemplate="footer">
    <p-button 
      label="Cerrar" 
      icon="pi pi-times" 
      (onClick)="handleCloseModal()"
      styleClass="p-button-text"
      [disabled]="loading"
    ></p-button>
    <p-button 
      [label]="isShareMode ? 'Compartir' : 'Enviar'" 
      [icon]="isShareMode ? 'pi pi-share-alt' : 'pi pi-send'"
      (onClick)="onSubmitShare()"
      [disabled]="(isShareMode ? !shareForm.get('recipientEmail')?.valid : !shareForm.valid) || loading"
      [loading]="loading"
    ></p-button>
  </ng-template>
</p-dialog>